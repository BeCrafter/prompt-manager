name: Simplified Release

on:
  push:
    tags:
      - 'v*'           # æ­£å¼ç‰ˆæœ¬: v1.0.0
      - 'beta-v*'      # Betaç‰ˆæœ¬: beta-v1.0.0
      - 'canary-v*'    # Canaryç‰ˆæœ¬: canary-v1.0.0

env:
  NODE_VERSION: '22.x'

permissions:
  contents: write
  packages: write

jobs:
  # æå–ç‰ˆæœ¬ä¿¡æ¯
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      clean-version: ${{ steps.version.outputs.clean-version }}
      is-beta: ${{ steps.version.outputs.is-beta }}
      is-canary: ${{ steps.version.outputs.is-canary }}
      publish-tag: ${{ steps.version.outputs.publish-tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version information
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "version=${TAG}" >> $GITHUB_OUTPUT
          
          if [[ $TAG == beta-* ]]; then
            CLEAN_VERSION=${TAG#beta-}
            echo "is-beta=true" >> $GITHUB_OUTPUT
            echo "publish-tag=beta" >> $GITHUB_OUTPUT
          elif [[ $TAG == canary-* ]]; then
            CLEAN_VERSION=${TAG#canary-}
            echo "is-canary=true" >> $GITHUB_OUTPUT
            echo "publish-tag=canary" >> $GITHUB_OUTPUT
          else
            CLEAN_VERSION=${TAG#v}
            echo "is-beta=false" >> $GITHUB_OUTPUT
            echo "is-canary=false" >> $GITHUB_OUTPUT
            echo "publish-tag=latest" >> $GITHUB_OUTPUT
          fi
          
          echo "clean-version=${CLEAN_VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${TAG}"
          echo "Clean Version: ${CLEAN_VERSION}"
          echo "Publish Tag: ${{ steps.version.outputs.publish-tag }}"

  # é¢„å‘å¸ƒæ£€æŸ¥
  pre-checks:
    runs-on: ubuntu-latest
    needs: extract-version
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci

      - name: Check and install all dependencies
        run: npm run check:deps

  #     - name: Run quick pre-release checks
  #       run: node scripts/pre-release-check.js ${{ needs.extract-version.outputs.version }} --quick

  # å‘å¸ƒåˆ°NPM
  publish:
    runs-on: ubuntu-latest
    needs: 
      - extract-version
      - pre-checks
    if: needs.pre-checks.result == 'success'
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Update version files
        run: node scripts/update-version.js ${{ needs.extract-version.outputs.clean-version }}
      
      - name: Commit version updates
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git diff --staged --quiet || git commit -m "chore: update version to ${{ needs.extract-version.outputs.version }} [skip ci]"
          git push origin HEAD:main
      
      - name: Build admin UI
        run: npm run build:admin-ui
        env:
          DISPLAY: ':99'
      
      - name: Build core package
        run: npm run build:core
      
      - name: Rebuild native modules
        run: npm rebuild node-pty
        env:
          DISPLAY: ':99'
      
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.extract-version.outputs.version }}
          release_name: Release ${{ needs.extract-version.outputs.version }}
          draft: false
          prerelease: ${{ needs.extract-version.outputs.is-beta == 'true' || needs.extract-version.outputs.is-canary == 'true' }}
          body: |
            ## Release ${{ needs.extract-version.outputs.version }}
            
            ### ğŸ“¦ Installation
            ```bash
            npm install @becrafter/prompt-manager@${{ needs.extract-version.outputs.publish-tag }}
            ```
      
      - name: Publish to NPM
        run: npm publish --access public --tag ${{ needs.extract-version.outputs.publish-tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # å‘å¸ƒæˆåŠŸé€šçŸ¥
  notify-success:
    runs-on: ubuntu-latest
    needs: [extract-version, publish]
    if: needs.publish.result == 'success'
    
    steps:
      - name: Success notification
        run: |
          echo "ğŸ‰ Release ${{ needs.extract-version.outputs.version }} completed successfully!"
          echo "ğŸ“¦ Published to NPM with tag: ${{ needs.extract-version.outputs.publish-tag }}"
          echo "ğŸ”— GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.extract-version.outputs.version }}"