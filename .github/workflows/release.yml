name: Simplified Release

on:
  push:
    tags:
      - 'v*'           # ç»Ÿä¸€ç‰ˆæœ¬æ ¼å¼: v1.0.0 / v1.0.0-beta.1 / v1.0.0-rc.1

env:
  NODE_VERSION: '22.x'

permissions:
  contents: write
  packages: write

jobs:
  # æå–ç‰ˆæœ¬ä¿¡æ¯
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      clean-version: ${{ steps.version.outputs.clean-version }}
      is-beta: ${{ steps.version.outputs.is-beta }}
      publish-tag: ${{ steps.version.outputs.publish-tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version information
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "version=${TAG}" >> $GITHUB_OUTPUT

          # ç»Ÿä¸€ tag é£æ ¼ï¼š
          # v1.2.3 / v1.2.3-beta.1
          CLEAN_VERSION="${TAG#v}"
          IS_BETA=false

          if [[ "$CLEAN_VERSION" == *"-"* ]]; then
            if [[ "$CLEAN_VERSION" == *"-beta."* ]]; then
              PUBLISH_TAG="beta"
              IS_BETA=true
            elif [[ "$CLEAN_VERSION" == *"-alpha."* ]]; then
              PUBLISH_TAG="alpha"
            elif [[ "$CLEAN_VERSION" == *"-rc."* ]]; then
              PUBLISH_TAG="rc"
            elif [[ "$CLEAN_VERSION" == *"-dev."* ]]; then
              PUBLISH_TAG="dev"
            else
              echo "Unsupported pre-release tag format: ${TAG}"
              exit 1
            fi
          else
            PUBLISH_TAG="latest"
          fi

          echo "is-beta=${IS_BETA}" >> $GITHUB_OUTPUT
          echo "publish-tag=${PUBLISH_TAG}" >> $GITHUB_OUTPUT
          echo "clean-version=${CLEAN_VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${TAG}"
          echo "Clean Version: ${CLEAN_VERSION}"
          echo "Publish Tag: ${PUBLISH_TAG}"

  # é¢„å‘å¸ƒæ£€æŸ¥
  pre-checks:
    runs-on: ubuntu-latest
    needs: extract-version
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci

      - name: Check and install all dependencies
        run: npm run check:deps

  #     - name: Run quick pre-release checks
  #       run: node scripts/pre-release-check.js ${{ needs.extract-version.outputs.version }} --quick

  # å‘å¸ƒåˆ°NPM
  publish:
    runs-on: ubuntu-latest
    needs: 
      - extract-version
      - pre-checks
    if: needs.pre-checks.result == 'success'
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Ensure npm registry is npmjs
        run: |
          rm -f .npmrc
          npm config set registry https://registry.npmjs.org/

      - name: Install dependencies
        run: npm ci

      - name: Check and install all dependencies
        run: npm run check:deps
      
      - name: Build artifacts
        run: npm run build

      - name: Update version files
        run: node scripts/update-version.js ${{ needs.extract-version.outputs.clean-version }}
      
      - name: Commit version updates
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git diff --staged --quiet || git commit -m "chore: update version to ${{ needs.extract-version.outputs.version }}"
          git push origin HEAD:main
      
      # - name: Build admin UI
      #   run: npm run build:admin-ui
      #   env:
      #     DISPLAY: ':99'
      
      # - name: Build core package
      #   run: npm run build:core
      
      - name: Rebuild native modules
        run: npm rebuild node-pty
        env:
          DISPLAY: ':99'
      
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.extract-version.outputs.version }}
          release_name: Release ${{ needs.extract-version.outputs.version }}
          draft: false
          prerelease: ${{ needs.extract-version.outputs.is-beta == 'true' }}
          body: |
            ## Release ${{ needs.extract-version.outputs.version }}
            
            ### ğŸ“¦ Installation
            ```bash
            npm install @becrafter/prompt-manager@${{ needs.extract-version.outputs.publish-tag }}
            ```
      
      - name: Publish to NPM
        run: npm publish --access public --tag ${{ needs.extract-version.outputs.publish-tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_USERCONFIG: /home/runner/work/_temp/.npmrc

  # å‘å¸ƒæˆåŠŸé€šçŸ¥
  notify-success:
    runs-on: ubuntu-latest
    needs: [extract-version, publish]
    if: needs.publish.result == 'success'
    
    steps:
      - name: Success notification
        run: |
          echo "ğŸ‰ Release ${{ needs.extract-version.outputs.version }} completed successfully!"
          echo "ğŸ“¦ Published to NPM with tag: ${{ needs.extract-version.outputs.publish-tag }}"
          echo "ğŸ”— GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.extract-version.outputs.version }}"