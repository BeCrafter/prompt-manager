<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>终端测试页面</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Courier New', monospace;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #007acc;
        }
        .terminal-container {
            height: 500px;
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            margin: 20px 0;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #005a9e;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #2d2d30;
            border-radius: 4px;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #4ec9b0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket 终端测试</h1>
        
        <div class="controls">
            <button onclick="connect()">连接终端</button>
            <button onclick="disconnect()">断开连接</button>
            <button onclick="clearOutput()">清除输出</button>
        </div>
        
        <div class="status" id="status">
            状态: 未连接
        </div>
        
        <div class="terminal-container" id="terminal"></div>
    </div>

    <script type="module">
        // 动态导入 xterm
        let Terminal, FitAddon;
        
        window.connect = async function() {
            try {
                // 动态导入模块
                const xtermModule = await import('xterm');
                Terminal = xtermModule.Terminal;
                
                const fitModule = await import('xterm-addon-fit');
                FitAddon = fitModule.FitAddon;
                
                updateStatus('正在导入模块...', 'success');
                
                // 创建终端
                const term = new Terminal({
                    theme: {
                        background: '#1e1e1e',
                        foreground: '#d4d4d4',
                        cursor: '#ffffff'
                    },
                    fontSize: 14,
                    fontFamily: 'Consolas, "Courier New", monospace',
                    cursorBlink: true,
                    scrollback: 1000
                });
                
                const fitAddon = new FitAddon();
                term.loadAddon(fitAddon);
                
                document.getElementById('terminal').innerHTML = '';
                term.open(document.getElementById('terminal'));
                fitAddon.fit();
                
                updateStatus('终端已创建，正在连接 WebSocket...', 'success');
                
                // 连接 WebSocket
                const ws = new WebSocket('ws://localhost:8081');
                
                ws.onopen = function() {
                    updateStatus('WebSocket 已连接，正在创建终端会话...', 'success');
                    
                    // 创建终端会话
                    ws.send(JSON.stringify({
                        type: 'terminal.create',
                        size: {
                            cols: term.cols,
                            rows: term.rows
                        }
                    }));
                };
                
                ws.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    console.log('收到消息:', message);
                    
                    switch (message.type) {
                        case 'terminal.created':
                            updateStatus(`终端会话已创建: ${message.sessionId}`, 'success');
                            window.sessionId = message.sessionId;
                            window.ws = ws;
                            window.term = term;
                            break;
                        case 'terminal.data':
                            term.write(message.data);
                            break;
                        case 'terminal.exit':
                            term.write(`\r\n[会话结束，退出代码: ${message.exitCode}]\r\n`);
                            break;
                        case 'error':
                            updateStatus(`错误: ${message.message}`, 'error');
                            break;
                    }
                };
                
                ws.onclose = function() {
                    updateStatus('WebSocket 连接已关闭', 'error');
                };
                
                ws.onerror = function(error) {
                    updateStatus(`WebSocket 错误: ${error.message || '未知错误'}`, 'error');
                };
                
                // 终端输入处理
                term.onData(function(data) {
                    if (ws.readyState === WebSocket.OPEN && window.sessionId) {
                        ws.send(JSON.stringify({
                            type: 'terminal.data',
                            data: data
                        }));
                    }
                });
                
                // 窗口大小变化
                window.addEventListener('resize', () => {
                    fitAddon.fit();
                    if (ws.readyState === WebSocket.OPEN && window.sessionId) {
                        ws.send(JSON.stringify({
                            type: 'terminal.resize',
                            cols: term.cols,
                            rows: term.rows
                        }));
                    }
                });
                
            } catch (error) {
                updateStatus(`错误: ${error.message}`, 'error');
                console.error('连接错误:', error);
            }
        };
        
        window.disconnect = function() {
            if (window.ws) {
                window.ws.close();
            }
            if (window.term) {
                window.term.dispose();
            }
            window.sessionId = null;
            window.ws = null;
            window.term = null;
            updateStatus('已断开连接', '');
        };
        
        window.clearOutput = function() {
            if (window.term) {
                window.term.clear();
            }
        };
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `状态: ${message}`;
            statusEl.className = 'status ' + type;
        }
    </script>
</body>
</html>