import { config } from '../utils/config.js';
import { z } from 'zod';
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import {
    handleGetPrompt,
    handleSearchPrompts,
    handleReloadPrompts
} from './prompt.handler.js';
import { handleToolM } from '../toolm/index.js';
import { handleSequentialThinking } from './sequential-thinking.handler.js';
import { handleThinkPlan } from './think-plan.handler.js';
// import { generateToolmDescription } from '../toolm/tool-description-generator.service.js';
import { generateToolmDescription } from '../toolm/tool-description-generator-optimized.service.js';
import { toolLoaderService } from '../toolm/tool-loader.service.js';

class Server {
    constructor() {
        this.server = new McpServer(
            {
                name: 'Prompt Management Server',
                version: config.getServerVersion()
            },
            { capabilities: { logging: {} } }
        );
    }

    registerTools(tools) {
        for (const tool of tools) {
            this.server.registerTool(tool.name,
                {
                    description: tool.description,
                    inputSchema: tool.inputSchema,
                },
                tool.handler
            );
        }
    }

    getServer() {
        return this.server;
    }
}

export const getMcpServer = async () => {
    const mcpServer = new Server();
    
    // ç¡®ä¿å·¥å…·åŠ è½½å™¨å·²åˆå§‹åŒ–ï¼ˆç”¨äºŽç”ŸæˆåŠ¨æ€æè¿°ï¼‰
    if (!toolLoaderService.initialized) {
        try {
            await toolLoaderService.initialize();
        } catch (error) {
            // å¦‚æžœåˆå§‹åŒ–å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨é»˜è®¤æè¿°
            console.warn('å·¥å…·åŠ è½½å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æè¿°:', error.message);
        }
    }
    
    // åŠ¨æ€ç”Ÿæˆ toolm å·¥å…·çš„æè¿°
    const toolmDescription = generateToolmDescription();
    
    mcpServer.registerTools([
        {
            name: 'search_prompts',
            description: `åŠŸèƒ½ï¼šæ™ºèƒ½æ£€ç´¢æç¤ºè¯åº“ï¼ŒåŒ¹é…ç”¨æˆ·éœ€æ±‚\næè¿°ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥å†…å®¹ï¼ˆå¯ä¸ºç©ºï¼‰æœç´¢åŒ¹é…çš„æç¤ºè¯ï¼Œè¿”å›žå€™é€‰æç¤ºè¯çš„ IDã€åç§°ã€ç®€çŸ­æè¿°ã€‚è‹¥è¾“å…¥ä¸ºç©ºåˆ™è¿”å›žå…¨éƒ¨æç¤ºè¯åˆ—è¡¨ã€‚å¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½é€‚åˆçš„æç¤ºè¯ï¼Œæ— éœ€è®°å¿†å…·ä½“åç§°ã€‚\n\nç¤ºä¾‹ï¼š\n- ç”¨æˆ·ï¼š"æˆ‘æƒ³å†™ä¸€é¦–è¯—" â†’ å·¥å…·è¿”å›žï¼š[ID:001, åç§°:è¯—æ­Œåˆ›ä½œ, æè¿°:ç”Ÿæˆå¤å…¸/çŽ°ä»£é£Žæ ¼è¯—æ­Œ]\n- ç”¨æˆ·ï¼š"ï¼ˆæ— è¾“å…¥ï¼‰" â†’ å·¥å…·è¿”å›žï¼šå®Œæ•´æç¤ºè¯åº“æ¦‚è§ˆ`,
            inputSchema: {
                name: z.string().optional().describe('æç¤ºè¯åç§°æˆ–å…³é”®è¯ï¼Œç”¨äºŽæœç´¢åŒ¹é…æç¤ºè¯'),
            },
            handler: async (args) => {
                return handleSearchPrompts(args);
            }
        },
        {
            name: 'get_prompt',
            description: `åŠŸèƒ½ï¼šç²¾å‡†èŽ·å–å¹¶åº”ç”¨æç¤ºè¯è¯¦æƒ…\næè¿°ï¼šæ ¹æ®æç¤ºè¯ ID æˆ–åç§° è°ƒç”¨å…·ä½“å†…å®¹ï¼Œè‡ªåŠ¨å°†å…¶åµŒå…¥å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶ã€‚æ”¯æŒé€šè¿‡ search_prompts è¿”å›žçš„ ID/åç§°ç›´æŽ¥èŽ·å–ã€‚\n\nç¤ºä¾‹ï¼š\n- ç”¨æˆ·ï¼š"ä½¿ç”¨ ID 001" â†’ å·¥å…·è‡ªåŠ¨åŠ è½½è¯—æ­Œåˆ›ä½œæç¤ºè¯å¹¶ç”Ÿæˆå†…å®¹\n- ç”¨æˆ·ï¼š"è°ƒç”¨'è¥é”€æ–‡æ¡ˆç”Ÿæˆ'" â†’ å·¥å…·åŒ¹é…åç§°åŽåº”ç”¨å¯¹åº”æç¤ºè¯`,
            inputSchema: {
                prompt_id: z.string().describe('æç¤ºè¯çš„å”¯ä¸€æ ‡è¯† ID/åç§°'),
            },
            handler: async (args) => {
                return handleGetPrompt(args);
            }
        },
        {
            name: 'toolm',
            description: toolmDescription,
            inputSchema: {
                yaml: z.string().describe('YAML æ ¼å¼çš„å·¥å…·è°ƒç”¨é…ç½®')
            },
            handler: async (args) => {
                return handleToolM(args);
            }
        },
        {
            name: 'sequentialthinking',
            description: `ðŸ§  **é¡ºåºæ€è€ƒå·¥å…· (Sequential Thinking)** - åŠ¨æ€åæ€æ€§æ€ç»´å·¥å…·

## ðŸŽ¯ å·¥å…·å®šä½
è¿™æ˜¯ä¸€ä¸ªç”¨äºŽ**æŽ¢ç´¢æ€§ã€åˆ†æžæ€§ã€ä¸ç¡®å®šæ€§**é—®é¢˜çš„åŠ¨æ€æ€è€ƒå·¥å…·ã€‚æ”¯æŒéžçº¿æ€§æ€ç»´ã€ä¿®è®¢å’Œåˆ†æ”¯ï¼Œé€‚åˆéœ€è¦æ·±å…¥åˆ†æžå’Œåå¤éªŒè¯çš„åœºæ™¯ã€‚

**é‡è¦è¯´æ˜Žï¼š** æ­¤å·¥å…·æ”¯æŒ MCP å·¥å…·åè°ƒåŠŸèƒ½ã€‚æ¨¡åž‹ä¼šåˆ†æžå¯ç”¨å·¥å…·åŠå…¶æè¿°ï¼Œæ™ºèƒ½æŽ¨èåˆé€‚çš„å·¥å…·ï¼Œå¹¶ç”±æœåŠ¡å™¨è·Ÿè¸ªå’Œç»„ç»‡è¿™äº›æŽ¨èã€‚

## ðŸ” åœºæ™¯è¯†åˆ« - ä½•æ—¶ä½¿ç”¨æ­¤å·¥å…·ï¼Ÿ

### âœ… ä¼˜å…ˆä½¿ç”¨ sequentialthinking çš„åœºæ™¯ï¼š

**1. æŽ¢ç´¢æ€§é—®é¢˜ï¼ˆé—®é¢˜ä¸æ˜Žç¡®ï¼‰**
   - â“ "ä¸ºä»€ä¹ˆç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Ÿ" â†’ éœ€è¦åˆ†æžåŽŸå› 
   - â“ "ç”¨æˆ·æµå¤±çŽ‡é«˜çš„åŽŸå› æ˜¯ä»€ä¹ˆï¼Ÿ" â†’ éœ€è¦è¯Šæ–­é—®é¢˜
   - â“ "è¿™ä¸ªbugçš„æ ¹æœ¬åŽŸå› æ˜¯ä»€ä¹ˆï¼Ÿ" â†’ éœ€è¦æ·±å…¥è°ƒæŸ¥

**2. åˆ†æžæ€§ä»»åŠ¡ï¼ˆéœ€è¦å‡è®¾éªŒè¯ï¼‰**
   - ðŸ“Š å¤æ‚æ•°æ®åˆ†æž
   - ðŸ”¬ é—®é¢˜è¯Šæ–­å’Œæ ¹å› åˆ†æž
   - ðŸ§ª å‡è®¾ç”Ÿæˆå’ŒéªŒè¯
   - ðŸ“ˆ è¶‹åŠ¿åˆ†æžå’Œé¢„æµ‹

**3. åˆ›æ„æ€§å·¥ä½œï¼ˆéœ€è¦å¤šè·¯å¾„æŽ¢ç´¢ï¼‰**
   - ðŸ’¡ äº§å“åŠŸèƒ½è®¾è®¡
   - ðŸŽ¨ æ–¹æ¡ˆè®¾è®¡
   - ðŸš€ åˆ›æ–°æ€è·¯æŽ¢ç´¢
   - ðŸ”„ éœ€è¦å¯¹æ¯”å¤šä¸ªæ–¹æ¡ˆ

**4. éœ€è¦ä¿®è®¢å’Œåˆ†æ”¯çš„åœºæ™¯**
   - å‘çŽ°ä¹‹å‰çš„æ€è€ƒæœ‰è¯¯ï¼Œéœ€è¦ä¿®æ­£
   - éœ€è¦æŽ¢ç´¢å¤šä¸ªå¯èƒ½çš„è§£å†³æ–¹æ¡ˆ
   - éœ€è¦å›žæº¯å’Œé‡æ–°è¯„ä¼°

**5. éœ€è¦å·¥å…·æŒ‡å¯¼çš„åœºæ™¯**
   - ä¸ç¡®å®šåº”è¯¥ä½¿ç”¨å“ªäº›å·¥å…·
   - éœ€è¦äº†è§£å·¥å…·çš„æ‰§è¡Œé¡ºåº
   - éœ€è¦å·¥å…·ä½¿ç”¨çš„å‚æ•°å»ºè®®
   - éœ€è¦å·¥å…·æŽ¨èçš„åˆç†æ€§è¯´æ˜Ž

### âŒ ä¸é€‚åˆä½¿ç”¨ sequentialthinking çš„åœºæ™¯ï¼š
   - âœ… ç›®æ ‡æ˜Žç¡®ï¼Œåªéœ€è¦æ‰§è¡Œ â†’ ä½¿ç”¨ think_and_plan
   - âœ… éœ€è¦å…·ä½“çš„è¡ŒåŠ¨æ­¥éª¤ â†’ ä½¿ç”¨ think_and_plan
   - âœ… ä»»åŠ¡åˆ†è§£å’Œæ‰§è¡Œè§„åˆ’ â†’ ä½¿ç”¨ think_and_plan

## ðŸ†š å·¥å…·å¯¹æ¯”å†³ç­–æ ‘

å†³ç­–æµç¨‹ï¼š
  é—®é¢˜æ˜¯å¦æ˜Žç¡®ï¼Ÿ
  - ä¸æ˜Žç¡®/éœ€è¦æŽ¢ç´¢ â†’ sequentialthinking
  - æ˜Žç¡® + éœ€è¦æ‰§è¡Œ â†’ think_and_plan
  - æ˜Žç¡® + åªéœ€åˆ†æž â†’ sequentialthinking
  - éœ€è¦å·¥å…·æŽ¨èå’ŒæŒ‡å¯¼ â†’ sequentialthinking

## âœ¨ æ ¸å¿ƒç‰¹æ€§

**1. éžçº¿æ€§æ€ç»´**
   - æ”¯æŒåˆ†æ”¯ï¼ˆbranchï¼‰ï¼šä»ŽæŸä¸ªæ€è€ƒç‚¹æŽ¢ç´¢å¤šä¸ªæ–¹å‘
   - æ”¯æŒä¿®è®¢ï¼ˆrevisionï¼‰ï¼šä¿®æ­£ä¹‹å‰çš„æ€è€ƒ
   - æ”¯æŒå›žæº¯ï¼šé‡æ–°è¯„ä¼°ä¹‹å‰çš„æ­¥éª¤

**2. åŠ¨æ€è°ƒæ•´**
   - å¯ä»¥è°ƒæ•´æ€»æ€è€ƒæ­¥éª¤æ•°ï¼ˆtotal_thoughtsï¼‰
   - å¯ä»¥ä¸­é€”æ·»åŠ æ›´å¤šæ€è€ƒ
   - å¯ä»¥è¡¨è¾¾ä¸ç¡®å®šæ€§
   - å¯ä»¥æŽ¢ç´¢æ›¿ä»£æ–¹æ¡ˆ

**3. è¿›åº¦è¿½è¸ª**
   - æ˜¾ç¤ºæ€è€ƒè¿›åº¦ï¼ˆå½“å‰/æ€»æ•°/ç™¾åˆ†æ¯”ï¼‰
   - è‡ªåŠ¨ç”Ÿæˆæœ€ç»ˆæ€»ç»“
   - æå–å…³é”®æ´žå¯Ÿå’Œç»“è®º
   - è·Ÿè¸ªå·²æŽ¨èçš„æ­¥éª¤å’Œå‰©ä½™æ­¥éª¤

**4. çµæ´»æ€§å¼º**
   - å•ä¸€ thought å­—æ®µï¼Œå†…å®¹è‡ªç”±
   - æ”¯æŒå‡è®¾ç”Ÿæˆå’ŒéªŒè¯
   - æ”¯æŒé—®é¢˜åˆ†è§£å’Œé‡æž„
   - æ”¯æŒå·¥å…·æŽ¨èå’Œå‚æ•°å»ºè®®

**5. MCP å·¥å…·åè°ƒï¼ˆæ ¸å¿ƒç‰¹æ€§ï¼‰**
   - ðŸ”§ ä¸ºæ¯ä¸ªæ­¥éª¤æŽ¨èåˆé€‚çš„å·¥å…·
   - ðŸ“ æä¾›å·¥å…·æŽ¨èçš„åˆç†æ€§è¯´æ˜Ž
   - ðŸ“‹ å»ºè®®å·¥å…·æ‰§è¡Œé¡ºåºå’Œå‚æ•°
   - ðŸ“Š è·Ÿè¸ªä¹‹å‰çš„æŽ¨èå’Œå‰©ä½™æ­¥éª¤
   - ðŸŽ¯ åˆ†æžå¯ç”¨å·¥å…·å¹¶åšå‡ºæ™ºèƒ½æŽ¨è

## ðŸ“‹ ä½¿ç”¨æŒ‡å—

**å‚æ•°è¯´æ˜Žï¼š**

**åŸºç¡€å‚æ•°ï¼š**
- \`thought\`ï¼ˆå¿…éœ€ï¼‰ï¼šå½“å‰æ€è€ƒæ­¥éª¤ï¼Œå¯ä»¥åŒ…æ‹¬ï¼š
  * å¸¸è§„åˆ†æžæ­¥éª¤
  * å¯¹ä¹‹å‰æ€è€ƒçš„ä¿®è®¢
  * å¯¹ä¹‹å‰å†³ç­–çš„è´¨ç–‘
  * æ„è¯†åˆ°éœ€è¦æ›´å¤šåˆ†æž
  * æ–¹æ³•çš„æ”¹å˜
  * å‡è®¾ç”Ÿæˆ
  * å‡è®¾éªŒè¯
  * å·¥å…·æŽ¨èå’Œåˆç†æ€§è¯´æ˜Ž
- \`thoughtNumber\`ï¼ˆå¯é€‰ï¼‰ï¼šå½“å‰æ€è€ƒç¼–å·ï¼ˆå¯ä»¥ä»Žåˆå§‹æ€»æ•°ç»§ç»­å¢žåŠ ï¼‰
- \`totalThoughts\`ï¼ˆå¯é€‰ï¼‰ï¼šå½“å‰ä¼°è®¡æ‰€éœ€æ€è€ƒæ•°ï¼ˆå¯åŠ¨æ€è°ƒæ•´ï¼‰
- \`nextThoughtNeeded\`ï¼ˆå¯é€‰ï¼‰ï¼šæ˜¯å¦éœ€è¦ç»§ç»­æ€è€ƒï¼ˆå³ä½¿çœ‹ä¼¼å·²åˆ°ç»ˆç‚¹ï¼‰

**ä¿®è®¢å’Œåˆ†æ”¯å‚æ•°ï¼š**
- \`isRevision\`ï¼ˆå¯é€‰ï¼‰ï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ­¤æ€è€ƒæ˜¯å¦ä¿®è®¢äº†ä¹‹å‰çš„æ€è€ƒ
- \`revisesThought\`ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æžœ isRevision ä¸º trueï¼ŒæŒ‡å®šè¦é‡æ–°è€ƒè™‘çš„æ€è€ƒç¼–å·
- \`branchFromThought\`ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æžœåˆ›å»ºåˆ†æ”¯ï¼ŒæŒ‡å®šåˆ†æ”¯èµ·ç‚¹çš„æ€è€ƒç¼–å·
- \`branchId\`ï¼ˆå¯é€‰ï¼‰ï¼šå½“å‰åˆ†æ”¯çš„æ ‡è¯†ç¬¦ï¼ˆå¦‚æžœæœ‰ï¼‰
- \`needsMoreThoughts\`ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æžœåˆ°è¾¾ç»ˆç‚¹ä½†æ„è¯†åˆ°éœ€è¦æ›´å¤šæ€è€ƒ

**MCP å·¥å…·åè°ƒå‚æ•°ï¼š**
- \`available_mcp_tools\`ï¼ˆå¯é€‰ï¼‰ï¼šå¯ç”¨ MCP å·¥å…·åç§°æ•°ç»„ï¼ˆä¾‹å¦‚ï¼š["mcp-omnisearch", "mcp-turso-cloud"]ï¼‰
- \`current_step\`ï¼ˆå¯é€‰ï¼‰ï¼šå½“å‰æ­¥éª¤æŽ¨èï¼ŒåŒ…æ‹¬ï¼š
  * \`step_description\`ï¼šéœ€è¦åšä»€ä¹ˆ
  * \`recommended_tools\`ï¼šæ­¤æ­¥éª¤æŽ¨èçš„å·¥å…·
  * \`expected_outcome\`ï¼šæ­¤æ­¥éª¤çš„é¢„æœŸç»“æžœ
  * \`next_step_conditions\`ï¼šä¸‹ä¸€æ­¥éœ€è¦è€ƒè™‘çš„æ¡ä»¶
- \`previous_steps\`ï¼ˆå¯é€‰ï¼‰ï¼šå·²æŽ¨èçš„æ­¥éª¤
- \`remaining_steps\`ï¼ˆå¯é€‰ï¼‰ï¼šåŽç»­æ­¥éª¤çš„é«˜çº§æè¿°

**ä½¿ç”¨æµç¨‹ï¼š**
1. ä»Žåˆå§‹ä¼°è®¡å¼€å§‹ï¼Œä½†å‡†å¤‡éšæ—¶è°ƒæ•´
2. è‡ªç”±è´¨ç–‘å’Œä¿®è®¢ä¹‹å‰çš„æ€è€ƒ
3. å³ä½¿åˆ°è¾¾"ç»ˆç‚¹"ä¹Ÿå¯ä»¥ç»§ç»­æ·»åŠ æ€è€ƒ
4. è¡¨è¾¾ä¸ç¡®å®šæ€§ï¼ŒæŽ¢ç´¢æ›¿ä»£æ–¹æ¡ˆ
5. æ ‡è®°ä¿®è®¢å’Œåˆ†æ”¯
6. ç”Ÿæˆå‡è®¾å¹¶éªŒè¯
7. **è€ƒè™‘å¯ç”¨å·¥å…·ï¼Œä¸ºå½“å‰æ­¥éª¤æŽ¨èåˆé€‚çš„å·¥å…·**
8. **æä¾›å·¥å…·æŽ¨èçš„æ¸…æ™°åˆç†æ€§è¯´æ˜Ž**
9. **åœ¨é€‚å½“æ—¶å»ºè®®å…·ä½“çš„å·¥å…·å‚æ•°**
10. **è€ƒè™‘æ¯ä¸ªæ­¥éª¤çš„æ›¿ä»£å·¥å…·**
11. **è·Ÿè¸ªæŽ¨èæ­¥éª¤çš„è¿›åº¦**
12. å¿½ç•¥ä¸Žå½“å‰æ­¥éª¤æ— å…³çš„ä¿¡æ¯
13. é‡å¤ç›´åˆ°æ»¡æ„
14. åªåœ¨çœŸæ­£å®Œæˆä¸”å¾—åˆ°æ»¡æ„ç­”æ¡ˆæ—¶è®¾ç½® nextThoughtNeeded=false
15. æä¾›å•ä¸€ã€ç†æƒ³æƒ…å†µä¸‹æ­£ç¡®çš„ç­”æ¡ˆä½œä¸ºæœ€ç»ˆè¾“å‡º

## ðŸ’¡ å…¸åž‹ä½¿ç”¨ç¤ºä¾‹

**ç¤ºä¾‹1ï¼šé—®é¢˜è¯Šæ–­ï¼ˆå¸¦å·¥å…·æŽ¨èï¼‰**
- Thought 1: "åˆ†æžç³»ç»Ÿæ€§èƒ½ä¸‹é™çš„å¯èƒ½åŽŸå› "
  - current_step: { step_description: "æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—", recommended_tools: ["mcp-log-reader"], expected_outcome: "å‘çŽ°é”™è¯¯æ¨¡å¼" }
- Thought 2: "æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½"
  - current_step: { step_description: "åˆ†æžæ…¢æŸ¥è¯¢", recommended_tools: ["mcp-db-profiler"], expected_outcome: "è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ" }
- Thought 3: "å‘çŽ°æŸ¥è¯¢æ…¢ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ†æž"ï¼ˆå¯èƒ½éœ€è¦ä¿®è®¢æˆ–åˆ†æ”¯ï¼‰

**ç¤ºä¾‹2ï¼šæ–¹æ¡ˆè®¾è®¡ï¼ˆå¸¦å·¥å…·åè°ƒï¼‰**
- Thought 1: "è®¾è®¡ç”¨æˆ·ç™»å½•åŠŸèƒ½"
  - current_step: { step_description: "è®¾è®¡è®¤è¯æµç¨‹", recommended_tools: ["mcp-diagram-tool"], expected_outcome: "æµç¨‹å›¾" }
- Thought 2: "è€ƒè™‘å®‰å…¨æ€§è¦æ±‚"
- Thought 3: "ä¿®è®¢ï¼šéœ€è¦æ·»åŠ åŒå› ç´ è®¤è¯"ï¼ˆrevisionï¼‰
  - current_step: { step_description: "å®žçŽ°2FA", recommended_tools: ["mcp-auth-library"], expected_outcome: "å®‰å…¨ç™»å½•æ–¹æ¡ˆ" }

**ç¤ºä¾‹3ï¼šå¤šæ–¹æ¡ˆæŽ¢ç´¢ï¼ˆå¸¦å·¥å…·æŽ¨èï¼‰**
- Thought 1: "è¯„ä¼°ä¸‰ç§æž¶æž„æ–¹æ¡ˆ"
- Branch A: "æ–¹æ¡ˆAï¼šå¾®æœåŠ¡æž¶æž„"
  - current_step: { step_description: "è¯„ä¼°å¾®æœåŠ¡æ–¹æ¡ˆ", recommended_tools: ["mcp-architecture-analyzer"], expected_outcome: "æ–¹æ¡ˆAè¯„ä¼°æŠ¥å‘Š" }
- Branch B: "æ–¹æ¡ˆBï¼šå•ä½“æž¶æž„"
  - current_step: { step_description: "è¯„ä¼°å•ä½“æ–¹æ¡ˆ", recommended_tools: ["mcp-architecture-analyzer"], expected_outcome: "æ–¹æ¡ˆBè¯„ä¼°æŠ¥å‘Š" }`,
            inputSchema: {
                thought: z.string().describe('Your current thinking step'),
                nextThoughtNeeded: z.boolean().optional().describe('Whether another thought step is needed'),
                thoughtNumber: z.number().int().min(1).optional().describe('Current thought number'),
                totalThoughts: z.number().int().min(1).optional().describe('Estimated total thoughts needed'),
                isRevision: z.boolean().optional().describe('Whether this revises previous thinking'),
                revisesThought: z.number().int().min(1).optional().describe('Which thought is being reconsidered'),
                branchFromThought: z.number().int().min(1).optional().describe('Branching point thought number'),
                branchId: z.string().optional().describe('Branch identifier'),
                needsMoreThoughts: z.boolean().optional().describe('If more thoughts are needed')
            },
            handler: async (args) => {
                return handleSequentialThinking(args);
            }
        },
        {
            name: 'think_and_plan',
            description: `ðŸ“‹ **æ€è€ƒè§„åˆ’å·¥å…· (Think & Plan)** - ç»“æž„åŒ–æ‰§è¡Œå¯¼å‘å·¥å…·

## ðŸŽ¯ å·¥å…·å®šä½
è¿™æ˜¯ä¸€ä¸ªç”¨äºŽ**ç›®æ ‡æ˜Žç¡®ã€éœ€è¦æ‰§è¡Œ**çš„ç»“æž„åŒ–è§„åˆ’å·¥å…·ã€‚å¼ºè°ƒæ€è€ƒ-è®¡åˆ’-è¡ŒåŠ¨çš„ä¸‰å…ƒç»“æž„ï¼Œé€‚åˆå°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºå¯æ‰§è¡Œæ­¥éª¤å¹¶è¿½è¸ªæ‰§è¡Œè¿‡ç¨‹ã€‚

## ðŸ” åœºæ™¯è¯†åˆ« - ä½•æ—¶ä½¿ç”¨æ­¤å·¥å…·ï¼Ÿ

### âœ… ä¼˜å…ˆä½¿ç”¨ think_and_plan çš„åœºæ™¯ï¼š

**1. ä»»åŠ¡æ‰§è¡Œï¼ˆç›®æ ‡æ˜Žç¡®ï¼‰**
   - âœ… "å®žçŽ°ç”¨æˆ·ç™»å½•åŠŸèƒ½" â†’ éœ€è¦å…·ä½“å®žçŽ°æ­¥éª¤
   - âœ… "éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°ç”Ÿäº§çŽ¯å¢ƒ" â†’ éœ€è¦æ‰§è¡Œè®¡åˆ’
   - âœ… "å®Œæˆæœˆåº¦æŠ¥å‘Š" â†’ éœ€è¦ä»»åŠ¡åˆ†è§£
   - âœ… "é‡æž„æŸä¸ªæ¨¡å—" â†’ éœ€è¦å®žæ–½æ­¥éª¤

**2. é¡¹ç›®ç®¡ç†ï¼ˆéœ€è¦è¡ŒåŠ¨è¿½è¸ªï¼‰**
   - ðŸ“ ä»»åŠ¡åˆ†è§£å’Œæ­¥éª¤è§„åˆ’
   - ðŸ“… é¡¹ç›®é‡Œç¨‹ç¢‘è§„åˆ’
   - âœ… è¡ŒåŠ¨é¡¹è¿½è¸ª
   - ðŸŽ¯ ç›®æ ‡è¾¾æˆè·¯å¾„

**3. ç»“æž„åŒ–é—®é¢˜ï¼ˆéœ€è¦æ˜Žç¡®æ­¥éª¤ï¼‰**
   - ðŸ”§ æµç¨‹è®¾è®¡å’Œå®žæ–½
   - ðŸ“Š æ–¹æ¡ˆæ‰§è¡Œè®¡åˆ’
   - ðŸš€ åŠŸèƒ½å¼€å‘è§„åˆ’
   - ðŸ”„ ç³»ç»Ÿè¿ç§»è®¡åˆ’

**4. éœ€è¦å¯æ‰§è¡Œè¡ŒåŠ¨çš„åœºæ™¯**
   - æ¯ä¸ªæ­¥éª¤éƒ½éœ€è¦æ˜Žç¡®çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨
   - éœ€è¦è°ƒç”¨å…·ä½“å·¥å…·æˆ–æ‰§è¡Œå…·ä½“æ“ä½œ
   - éœ€è¦éªŒè¯å’Œæ£€æŸ¥ç‚¹

### âŒ ä¸é€‚åˆä½¿ç”¨ think_and_plan çš„åœºæ™¯ï¼š
   - â“ é—®é¢˜ä¸æ˜Žç¡®ï¼Œéœ€è¦æŽ¢ç´¢ â†’ ä½¿ç”¨ sequentialthinking
   - â“ éœ€è¦åˆ†æžåŽŸå› æˆ–è¯Šæ–­é—®é¢˜ â†’ ä½¿ç”¨ sequentialthinking
   - â“ éœ€è¦å¤šæ–¹æ¡ˆå¯¹æ¯”æˆ–ä¿®è®¢ â†’ ä½¿ç”¨ sequentialthinking
   - â“ åˆ›æ„æ€§å·¥ä½œï¼Œéœ€è¦å‘æ•£æ€ç»´ â†’ ä½¿ç”¨ sequentialthinking

## ðŸ†š å·¥å…·å¯¹æ¯”å†³ç­–æ ‘

å†³ç­–æµç¨‹ï¼š
  é—®é¢˜æ˜¯å¦æ˜Žç¡®ï¼Ÿ
  - æ˜Žç¡® + éœ€è¦æ‰§è¡Œ â†’ think_and_plan (ä¼˜å…ˆé€‰æ‹©)
  - æ˜Žç¡® + åªéœ€åˆ†æž â†’ sequentialthinking
  - ä¸æ˜Žç¡®/éœ€è¦æŽ¢ç´¢ â†’ sequentialthinking

## âœ¨ æ ¸å¿ƒç‰¹æ€§

**1. ä¸‰å…ƒç»“æž„ï¼ˆæ€è€ƒ-è®¡åˆ’-è¡ŒåŠ¨ï¼‰**
   - ðŸ¤” Thoughtï¼ˆæ€è€ƒï¼‰ï¼šåˆ†æžã€å‡è®¾ã€æ´žè§
   - ðŸ“‹ Planï¼ˆè®¡åˆ’ï¼‰ï¼šåˆ†è§£ä¸ºå¯æ‰§è¡Œæ­¥éª¤
   - ðŸŽ¯ Actionï¼ˆè¡ŒåŠ¨ï¼‰ï¼šå…·ä½“ã€å¯æ‰§è¡Œã€å¯éªŒè¯çš„ä¸‹ä¸€æ­¥

**2. æ‰§è¡Œå¯¼å‘**
   - å¼ºåˆ¶è¦æ±‚ action å­—æ®µ
   - æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ˜Žç¡®çš„ä¸‹ä¸€æ­¥
   - æ”¯æŒå·¥å…·è°ƒç”¨å»ºè®®

**3. ä¼šè¯éš”ç¦»**
   - æ”¯æŒ sessionId åŒºåˆ†ä¸åŒä¼šè¯
   - å¤šä»»åŠ¡å¹¶è¡Œç®¡ç†
   - ç‹¬ç«‹è®°å½•å’Œè¿½è¸ª

**4. ç»“æž„åŒ–å¼º**
   - å›ºå®šç»“æž„ï¼Œä½¿ç”¨ç®€å•
   - ä¾¿äºŽå¤ç›˜å’Œä¼˜åŒ–
   - é€‚åˆå›¢é˜Ÿåä½œ

## ðŸ“‹ ä½¿ç”¨æŒ‡å—

**å‚æ•°è¯´æ˜Žï¼š**
- thoughtï¼ˆå¿…éœ€ï¼‰ï¼šå½“å‰æ€è€ƒå†…å®¹ï¼Œåˆ†æžã€å‡è®¾ã€æ´žè§ã€åæ€
- planï¼ˆå¿…éœ€ï¼‰ï¼šé’ˆå¯¹å½“å‰ä»»åŠ¡çš„è®¡åˆ’æˆ–æ–¹æ¡ˆï¼Œåˆ†è§£ä¸ºå¯æ‰§è¡Œæ­¥éª¤
- actionï¼ˆå¿…éœ€ï¼‰ï¼šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼Œå¿…é¡»å…·ä½“ã€å¯æ‰§è¡Œã€å¯éªŒè¯ï¼Œå¯ä»¥æ˜¯å·¥å…·è°ƒç”¨
- thoughtNumberï¼ˆå¿…éœ€ï¼‰ï¼šæ€è€ƒæ­¥éª¤ç¼–å·ï¼Œç”¨äºŽè¿½è¸ªå’Œå›žæº¯
- sessionIdï¼ˆå¯é€‰ï¼‰ï¼šä¼šè¯æ ‡è¯†ç¬¦ï¼Œé»˜è®¤ä¸º 'default'

**ä½¿ç”¨æµç¨‹ï¼š**
1. æ˜Žç¡®ä»»åŠ¡ç›®æ ‡
2. æ€è€ƒå½“å‰æ­¥éª¤çš„æ ¸å¿ƒé—®é¢˜
3. åˆ¶å®šå…·ä½“çš„æ‰§è¡Œè®¡åˆ’
4. å®šä¹‰æ˜Žç¡®çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆå¯åŒ…å«å·¥å…·è°ƒç”¨ï¼‰
5. æŒ‰ç¼–å·é¡ºåºè®°å½•æ¯ä¸ªæ­¥éª¤
6. å®ŒæˆåŽå¯èŽ·å–æ‘˜è¦å’Œå›žé¡¾

## ðŸ’¡ å…¸åž‹ä½¿ç”¨ç¤ºä¾‹

**ç¤ºä¾‹1ï¼šåŠŸèƒ½å¼€å‘**
- Thought: "éœ€è¦å®žçŽ°ç”¨æˆ·ç™»å½•åŠŸèƒ½ï¼Œè€ƒè™‘å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ"
- Plan: "1. è®¾è®¡ç™»å½•æŽ¥å£ 2. å®žçŽ°å¯†ç åŠ å¯† 3. æ·»åŠ éªŒè¯ç  4. ç¼–å†™æµ‹è¯•"
- Action: "è°ƒç”¨ä»£ç ç”Ÿæˆå·¥å…·åˆ›å»ºç™»å½•æŽ¥å£æ¡†æž¶"

**ç¤ºä¾‹2ï¼šéƒ¨ç½²ä»»åŠ¡**
- Thought: "éœ€è¦å°†æ–°ç‰ˆæœ¬å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ"
- Plan: "1. å¤‡ä»½å½“å‰ç‰ˆæœ¬ 2. æ‰§è¡Œæ•°æ®åº“è¿ç§» 3. éƒ¨ç½²æ–°ä»£ç  4. éªŒè¯åŠŸèƒ½"
- Action: "æ‰§è¡Œå¤‡ä»½è„šæœ¬ï¼Œæ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸ"

**ç¤ºä¾‹3ï¼šæŠ¥å‘Šç¼–å†™**
- Thought: "éœ€è¦å®Œæˆæœˆåº¦ä¸šåŠ¡åˆ†æžæŠ¥å‘Š"
- Plan: "1. æ”¶é›†æ•°æ® 2. åˆ†æžè¶‹åŠ¿ 3. ç¼–å†™æŠ¥å‘Š 4. å®¡æ ¸å‘å¸ƒ"
- Action: "è°ƒç”¨æ•°æ®åˆ†æžå·¥å…·æå–æœ¬æœˆä¸šåŠ¡æ•°æ®"

## ðŸ”„ ä¸Ž sequentialthinking çš„é…åˆä½¿ç”¨

**æŽ¨èå·¥ä½œæµï¼š**
1. **æŽ¢ç´¢é˜¶æ®µ** â†’ ä½¿ç”¨ sequentialthinking
   - åˆ†æžé—®é¢˜ã€æŽ¢ç´¢æ–¹æ¡ˆã€éªŒè¯å‡è®¾
2. **æ‰§è¡Œé˜¶æ®µ** â†’ ä½¿ç”¨ think_and_plan
   - å°†ç¡®å®šçš„æ–¹æ¡ˆè½¬åŒ–ä¸ºå¯æ‰§è¡Œæ­¥éª¤
   - è¿½è¸ªæ‰§è¡Œè¿›åº¦å’Œç»“æžœ`,
            inputSchema: {
                thought: z.string().describe('å½“å‰çš„æ€è€ƒå†…å®¹ï¼Œå¯ä»¥æ˜¯å¯¹é—®é¢˜çš„åˆ†æžã€å‡è®¾ã€æ´žè§ã€åæ€æˆ–å¯¹å‰ä¸€æ­¥éª¤çš„æ€»ç»“ã€‚å¼ºè°ƒæ·±åº¦æ€è€ƒå’Œé€»è¾‘æŽ¨æ¼”ï¼Œæ˜¯æ¯ä¸€æ­¥çš„æ ¸å¿ƒã€‚'),
                plan: z.string().describe('é’ˆå¯¹å½“å‰ä»»åŠ¡æ‹Ÿå®šçš„è®¡åˆ’æˆ–æ–¹æ¡ˆï¼Œå°†å¤æ‚é—®é¢˜åˆ†è§£ä¸ºå¤šä¸ªå¯æ‰§è¡Œæ­¥éª¤ã€‚'),
                action: z.string().describe('åŸºäºŽå½“å‰æ€è€ƒå’Œè®¡åˆ’ï¼Œå»ºè®®ä¸‹ä¸€æ­¥é‡‡å–çš„è¡ŒåŠ¨æ­¥éª¤ï¼Œè¦æ±‚å…·ä½“ã€å¯æ‰§è¡Œã€å¯éªŒè¯ï¼Œå¯ä»¥æ˜¯ä¸‹ä¸€æ­¥éœ€è¦è°ƒç”¨çš„ä¸€ä¸ªæˆ–å¤šä¸ªå·¥å…·ã€‚'),
                thoughtNumber: z.string().describe('å½“å‰æ€è€ƒæ­¥éª¤çš„ç¼–å·ï¼Œç”¨äºŽè¿½è¸ªå’Œå›žæº¯æ•´ä¸ªæ€è€ƒä¸Žè§„åˆ’è¿‡ç¨‹ï¼Œä¾¿äºŽåŽç»­å¤ç›˜ä¸Žä¼˜åŒ–ã€‚'),
                sessionId: z.string().optional().describe('ä¼šè¯æ ‡è¯†ç¬¦ï¼Œç”¨äºŽåŒºåˆ†ä¸åŒä¼šè¯çš„è®°å½•ï¼Œé»˜è®¤ä¸º \'default\'')
            },
            handler: async (args) => {
                return handleThinkPlan(args);
            }
        }
        // {
        //     name: 'reload_prompts',
        //     description: 'Force a reload of all preset prompts to overwrite the cache.',
        //     inputSchema: {},
        //     handler: async (args) => {
        //         return handleReloadPrompts(args);
        //     }
        // }
    ]);
    return mcpServer.getServer();
};