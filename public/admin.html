<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Manager 后台</title>
  <link rel="stylesheet" href="./css/codemirror.css">
  <link rel="stylesheet" href="./css/codemirror-theme_xq-light.css">
  <style>
    :root {
      --primary: #393939;
      --primary-dark: #393939;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --dark: #1a1a1a;
      --light: #f8f9fa;
      --gray: #6c757d;
      --gray-light: #dee2e6;
      --border: #e0e0e0;
      --sidebar-bg: #f8f9fa;
      --editor-bg: #263238;
      --preview-bg: #f5f5f5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    body {
      background-color: var(--light);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      letter-spacing: -0.01em;
      font-weight: 420;
    }
    
    header {
      background-color: white;
      padding: 12px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      font-size: 24px;
      font-weight: 580;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.02em;
    }
    
    .logo span {
      color: #8e8989;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 5px;
      font-weight: 450;
      border: 1px solid var(--border);
      letter-spacing: 0;
    }
    
    .nav-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--dark);
    }
    
    .btn-outline:hover {
      background: var(--light);
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    #addArgumentBtn {
      padding: 6px 12px;
      font-size: 12px;
    }

    button#saveBtn{
      padding: 10px 18px;
      font-size: 14px;
    }
    
    .btn.loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .btn-icon {
      padding: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
      height: 93%;
    }
    
    aside {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
      max-height: 100%;
      overflow-y: auto;
      scrollbar-width: none;
    }
    
    .sidebar-header {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    
    .new-prompt-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .new-prompt-btn:hover {
      background: #333;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .new-prompt-btn::before {
      content: '+';
      font-size: 18px;
      font-weight: 400;
      margin-right: 2px;
    }
    
    .search-container {
      display: flex;
      gap: 10px;
      margin-top: 2px;
    }
    
    .search-box {
      position: relative;
      flex: 1;
    }
    
    .search-box input {
      width: 100%;
      padding: 9px 32px 9px 38px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: white;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(57,57,57,0.1);
    }
    
    .search-box::before {
      content: '';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      opacity: 0.6;
    }

    .search-box .clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      display: none;
      align-items: center;
      justify-content: center;
      color: var(--gray);
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }

    .search-box .clear-btn::before {
      content: '';
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='15' y1='9' x2='9' y2='15'/%3E%3Cline x1='9' y1='9' x2='15' y2='15'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
    }

    .search-box .clear-btn:hover {
      opacity: 1;
    }

    .search-box input:not(:placeholder-shown) + .clear-btn {
      display: flex;
    }
    
    .folder-btn {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 38px;
      height: 38px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .folder-btn::before {
      content: '';
      width: 18px;
      height: 18px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z'/%3E%3Cline x1='12' y1='11' x2='12' y2='17'/%3E%3Cline x1='9' y1='14' x2='15' y2='14'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }
    
    .folder-btn:hover {
      background: #f8f9fa;
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .folder-btn:hover::before {
      opacity: 1;
    }
    
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column-reverse;
      gap: 12px;
      z-index: 1100;
      align-items: flex-end;
    }

    .toast {
      min-width: 280px;
      max-width: 360px;
      background: white;
      border-radius: 12px;
      padding: 16px 18px;
      display: flex;
      align-items: flex-start;
      gap: 14px;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12);
      border: 1px solid transparent;
      opacity: 0;
      transform: translateY(16px);
      animation: toast-enter 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      pointer-events: auto;
    }

    .toast.toast-leave {
      animation: toast-leave 0.25s ease forwards;
    }

    .toast-success {
      border-color: rgba(40,167,69,0.35);
      background: linear-gradient(145deg, rgba(40,167,69,0.08), rgba(40,167,69,0.02));
    }

    .toast-error {
      border-color: rgba(220,53,69,0.35);
      background: linear-gradient(145deg, rgba(220,53,69,0.08), rgba(220,53,69,0.02));
    }

    .toast-info {
      border-color: rgba(0,102,255,0.3);
      background: linear-gradient(145deg, rgba(0,102,255,0.08), rgba(0,102,255,0.02));
    }

    .toast-warning {
      border-color: rgba(255,193,7,0.35);
      background: linear-gradient(145deg, rgba(255,193,7,0.1), rgba(255,193,7,0.03));
    }

    .toast-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      flex-shrink: 0;
      background: rgba(0,0,0,0.05);
      color: var(--dark);
    }

    .toast-success .toast-icon {
      background: rgba(40,167,69,0.15);
      color: var(--success);
    }

    .toast-error .toast-icon {
      background: rgba(220,53,69,0.15);
      color: var(--danger);
    }

    .toast-info .toast-icon {
      background: rgba(0,102,255,0.15);
      color: var(--primary);
    }

    .toast-warning .toast-icon {
      background: rgba(255,193,7,0.2);
      color: #b58100;
    }

    .toast-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .toast-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--dark);
    }

    .toast-message {
      font-size: 13px;
      color: var(--gray);
      line-height: 1.5;
      white-space: pre-line;
    }

    .toast-close {
      border: none;
      background: transparent;
      color: var(--gray);
      font-size: 18px;
      cursor: pointer;
      padding: 2px;
      line-height: 1;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .toast-close:hover {
      color: var(--dark);
    }
    
    @keyframes toast-enter {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes toast-leave {
      to {
        opacity: 0;
        transform: translateY(12px);
      }
    }
    
    .variable-desc {
      font-size: 12px;
      color: var(--gray);
      margin-top: 2px;
    }
    
    .group-section {
      margin-bottom: 8px;
    }
    
    .group-header {
      padding: 12px 15px;
      font-size: 14px;
      font-weight: 500;
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    
    .group-header:hover {
      background: #f0f0f0;
    }
    
    .group-toggle {
      transition: transform 0.2s;
    }
    
    .group-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .group-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .group-content.collapsed {
      max-height: 0;
    }
    
    .group-content.expanded {
      max-height: 1000px;
      overflow-y: auto;
      padding-top: 8px;
      scrollbar-width: none;
    }
    
    .group-count {
      background: #9ea2a6;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    .prompt-list {
      padding: 0 15px 15px;
    }
    
    .prompt-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      background: #f5f5f5;
      border: 1px solid transparent;
      transition: all 0.2s;
      margin-right: 10px;
      overflow: hidden;
    }
    
    .prompt-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100%;
      min-width: 0;
      padding-right: 10px; /* 为 prompt-meta 预留空间 */
    }
    
    .prompt-name {
      font-weight: 500;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .prompt-meta {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .prompt-item:hover {
      background: #eeeeee;
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,102,255,0.1);
    }
    
    .prompt-item.active {
      background: rgba(0,102,255,0.05);
      border-color: var(--primary);
    }

    .prompt-desc {
      font-size: 12px;
      color: var(--gray);
      line-height: 1.3;
      height: 16px;
      overflow: hidden;
      position: relative;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }

    /* 操作按钮容器样式 */
    .prompt-actions {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      opacity: 0;
      visibility: hidden;
      padding: 8px;
      transition: all 0.25s ease;
      background: linear-gradient(to left,
        rgba(238, 238, 238, 0.95) 0%,
        rgba(238, 238, 238, 0.9) 60%,
        rgba(238, 238, 238, 0) 100%);
      transform: translateX(100%);
      justify-content: center;
      width: 80px;
    }

    .prompt-item:hover .prompt-actions {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
      background: linear-gradient(to left, 
        rgba(255, 255, 255, 0.95) 0%,
        rgba(255, 255, 255, 0.9) 50%,
        rgba(255, 255, 255, 0.1) 100%);
    }
    
    /* Tooltip样式 */
    .tooltip {
      position: relative;
    }
    
    .tooltip::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-width: 300px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: none;
    }
    
    .tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }
    
    /* 启用状态边框样式 */
    .prompt-item.enabled {
      border-left: 4px solid #b8b3b3; /* 浅30%的深灰色，原#333调浅30%约为#666 */
    }
    
    /* 选中状态样式 */
    .prompt-item.active {
      border-left: 4px solid #666; /* 选中时的灰色边框 */
    }
    
    /* 悬停状态样式 */
    .prompt-item:hover {
      border-color: #666; /* 鼠标悬停时的灰色边框 */
    }
    
    /* 操作按钮样式 */
    .prompt-actions {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 100px;
      opacity: 0;
      visibility: hidden;
      padding: 12px 16px;
      transform: translateX(100%);
      transition: all 0.25s ease;
      background: linear-gradient(to left,
        rgba(238, 238, 238, 0.95) 0%,
        rgba(238, 238, 238, 0.9) 30%,
        rgba(238, 238, 238, 0.6) 60%,
        rgba(238, 238, 238, 0) 100%);
      z-index: 1;
    }
    
    .prompt-item {
      padding-right: 24px; /* 为操作按钮预留空间 */
    }
    
    .prompt-item:hover .prompt-actions {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }
    
    .action-btn {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px;
      margin: -3px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      text-align: center;
      transition: all 0.2s ease;
      backdrop-filter: blur(2px);
      width: 100%;
    }
    
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: translateX(-2px);
      box-shadow: 0 1px 23px rgba(0,0,0,0.1);
    }
    
    /* 美化目录三角图标 */
    .group-toggle {
      position: relative;
      width: 20px;
      height: 20px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .group-toggle::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }
    
    .group-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .group-header:hover .group-toggle::before {
      opacity: 1;
    }
    
    .prompt-meta {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .prompt-tag {
      background: rgba(0,102,255,0.1);
      color: var(--primary);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .prompt-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .prompt-status.enabled {
      background: var(--success);
    }
    
    .prompt-status.disabled {
      background: var(--gray-light);
    }
    
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-left: 1px solid var(--border);
    }
    
    .editor-header {
      padding: 15px 20px;
      /* border-bottom: 1px solid var(--border); */
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: white;
    }
    
    .editor-header-top {
      display: flex;
      gap: 16px;
      align-items: center;
      width: 100%;
    }
    
    .editor-header-top input,
    .editor-header-top select,
    .prompt-description {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    
    .editor-header-top input {
      flex: 1;
      min-width: 0;
    }
    
    .editor-header-top select {
      min-width: 140px;
      flex-shrink: 0;
    }
    
    .editor-header-top input:focus,
    .editor-header-top select:focus,
    .prompt-description:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .prompt-description {
      width: 100%;
      min-height: 38px;
      line-height: 1.5;
      resize: none;
      overflow-y: hidden;
      transition: border-color 0.2s ease;
    }
    
    .prompt-description::-webkit-scrollbar {
      width: 6px;
    }
    
    .prompt-description::-webkit-scrollbar-thumb {
      background: var(--gray-light);
      border-radius: 3px;
    }
    
    .editor-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-left: auto;
    }
    
    .mode-toggle {
      display: inline-flex;
      align-items: center;
      padding: 4px;
      border-radius: 999px;
      background: var(--light);
      border: 1px solid var(--border);
    }
    
    .mode-btn {
      padding: 6px 18px;
      border: none;
      background: transparent;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      color: var(--gray);
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    
    .editor-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 16px;
      margin: 12px 20px 20px;
      overflow-y: auto;
      scrollbar-width: none;
    }

    .arguments-section {
      padding: 18px 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .arguments-section.has-error {
      border-color: rgba(220,53,69,0.4);
      box-shadow: 0 0 0 2px rgba(220,53,69,0.08), 0 8px 24px rgba(220,53,69,0.08);
    }

    .arguments-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .arguments-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .arguments-title span {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }

    .arguments-title small {
      font-size: 12px;
      color: var(--gray);
    }

    .arguments-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .arguments-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
    }

    .arguments-empty {
      grid-column: 1 / -1;
      font-size: 13px;
      color: var(--gray);
      background: var(--light);
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .argument-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(248,249,250,0.9), rgba(255,255,255,0.9));
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      /* min-height: 150px; */
      position: relative;
      overflow: hidden;
    }

    .argument-card.argument-card-unused {
      border-color: rgba(220,53,69,0.45);
      box-shadow: 0 0 0 1px rgba(220,53,69,0.18);
      background: rgba(220,53,69,0.04);
    }

    .argument-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .argument-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary);
      word-break: break-all;
    }

    .argument-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .argument-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(0,0,0,0.04);
      color: var(--gray);
    }

    .argument-required {
      background: rgba(220,53,69,0.12);
      color: var(--danger);
      font-weight: 600;
    }

    .argument-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: var(--gray);
      font-size: 12px;
      /* margin-bottom: 24px; */
    }

    .argument-body .argument-description {
      color: var(--dark);
      font-size: 13px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .argument-body .argument-placeholder {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(0,0,0,0.04);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--primary);
      display: inline-block;
    }

    .argument-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s ease;
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px;
      background: linear-gradient(to top, 
        rgba(255, 255, 255, 0.95) 0%,
        rgba(255, 255, 255, 0.9) 50%,
        rgba(255, 255, 255, 0) 100%);
      transform: translateY(100%);
    }

    .argument-card:hover .argument-actions {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .argument-action-btn {
      border: none;
      background: rgba(0,0,0,0.06);
      color: var(--primary);
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .argument-action-btn:hover {
      background: rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    .argument-action-btn.delete {
      color: var(--danger);
      background: rgba(220,53,69,0.12);
    }

    .argument-action-btn.delete:hover {
      background: rgba(220,53,69,0.18);
    }

    .argument-modal {
      position: fixed;
      inset: 0;
      background: rgba(17, 17, 17, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 24px;
      transition: opacity 0.2s ease;
    }

    .argument-modal.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .argument-modal-dialog {
      width: min(520px, 100%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .argument-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
    }

    .argument-modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }

    .argument-modal-close {
      border: none;
      background: transparent;
      font-size: 24px;
      line-height: 1;
      color: var(--gray);
      cursor: pointer;
      padding: 4px;
    }

    .argument-modal-close:hover {
      color: var(--dark);
    }

    .argument-modal-body {
      padding: 20px 24px 8px;
    }

    .argument-form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px 18px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-field.full-width {
      grid-column: 1 / -1;
    }

    .form-field-inline {
      align-self: end;
      height: 100%;
      display: flex;
      align-items: flex-end;
      padding-top: 26px;
    }

    .argument-modal label {
      font-size: 13px;
      color: var(--gray);
      font-weight: 500;
    }

    .argument-modal .required {
      color: var(--danger);
      font-weight: 600;
      font-size: 12px;
    }

    .argument-modal input[type="text"],
    .argument-modal textarea {
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 14px;
      background: white;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .argument-modal input[type="text"]:focus,
    .argument-modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(57,57,57,0.08);
    }

    .argument-modal textarea {
      resize: vertical;
      min-height: 96px;
    }

    .checkbox-field {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--dark);
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .checkbox-field input {
      accent-color: var(--primary);
    }

    .argument-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px 20px;
      border-top: 1px solid var(--border);
      background: rgba(248,249,250,0.65);
    }

    body.modal-open {
      overflow: hidden;
    }

    .editor-body {
      position: relative;
      flex: 1;
      box-sizing: border-box;
      min-height: 0;
    }
    
    .workspace-pane {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      background: white;
      transition: opacity 0.25s ease;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
      min-height: 400px;
      scrollbar-width: none;
    }
    
    .workspace-pane.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    
    .pane-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: white;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray);
    }
    
    .pane-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0;
      min-height: 0;
    }
    
    .pane-content.preview {
      background: var(--preview-bg);
      padding: 24px;
    }

    .CodeMirror {
      flex: 1;
      height: 100%;
      font-size: 14px;
      line-height: 1.5;
      padding-left: 8px;
    }
    
    .CodeMirror-gutters {
      display: none;
    }
    
    .CodeMirror-scroll {
      min-height: 100%;
    }
    
    .preview-content {
      flex: 1;
      padding: 24px;
      overflow: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      scrollbar-width: thin;
      scrollbar-color: var(--gray-light) transparent;
    }
    
    /* 预览模式下的 CodeMirror 样式调整 */
    .preview-content .CodeMirror {
      height: auto;
      background: transparent;
      border: none;
      padding: 0;
      font-size: 14px;
    }

    .preview-content .CodeMirror-scroll {
      overflow: hidden !important;
    }

    .preview-content .CodeMirror-sizer {
      border-right: none !important;
    }

    .preview-content .CodeMirror-gutters {
      display: none;
    }
    
    .preview-content .CodeMirror-cursor {
      display: none !important;
    }

    @media (max-width: 1100px) {
      .arguments-list {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }
    
    .empty-state h3 {
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .empty-state p {
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.92), 
        rgba(248,249,250,0.95),
        rgba(255,255,255,0.98)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(12px);
    }
    
    .login-box {
      width: 400px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
      padding: 48px 40px;
      text-align: center;
      border: 1px solid rgba(0,0,0,0.06);
      position: relative;
      animation: login-box-show 0.5s cubic-bezier(0.21, 1.02, 0.73, 1) forwards;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, 
        rgba(255, 255, 255, 0.98) 0%,
        rgba(255, 255, 255, 0.96) 100%
      );
    }

    @keyframes login-box-show {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .login-box h2 {
      font-size: 28px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 36px;
      position: relative;
      display: inline-block;
    }
    
    .login-box h2::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 45px;
      height: 4px;
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      border-radius: 4px;
      opacity: 0.8;
    }
    
    .login-box .input-group {
      position: relative;
      margin-bottom: 24px;
      width: 100%;
    }

    .login-box .input-group::before {
      content: '';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      opacity: 0.5;
      transition: opacity 0.2s ease;
      background-size: contain;
      background-repeat: no-repeat;
    }

    .login-box .input-group.username::before {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E");
    }

    .login-box .input-group.password::before {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'/%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'/%3E%3C/svg%3E");
    }

    .login-box .input-group:focus-within::before {
      opacity: 1;
    }
    
    .login-box input {
      width: 100%;
      padding: 14px 15px 14px 48px;
      border: 1.5px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      font-weight: 450;
      letter-spacing: -0.01em;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    
    .login-box input:focus {
      outline: none;
      border-color: var(--primary);
      border-width: 1.5px;
      box-shadow: 0 0 0 3px rgba(57,57,57,0.08), 0 2px 8px rgba(0,0,0,0.04);
      background: white;
    }

    .login-box input::placeholder {
      color: #adb5bd;
      font-size: 15px;
      font-weight: 450;
      letter-spacing: -0.01em;
      opacity: 0.85;
    }
    
    .login-box button {
      width: 100%;
      padding: 16px;
      margin-top: 32px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 520;
      background: var(--primary);
      color: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.02em;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .login-box button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
      transform: translateX(-100%);
      transition: transform 0.8s ease;
    }

    .login-box button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }

    .login-box button:active {
      transform: translateY(0);
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      background: var(--primary);
    }

    .login-box button:hover::before {
      transform: translateX(100%);
    }
    
    .error-msg {
      color: var(--danger);
      font-size: 13px;
      margin-top: 12px;
      text-align: center;
      opacity: 0;
      transform: translateY(-10px);
      animation: error-show 0.3s ease forwards;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .error-msg::before {
      content: '';
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23dc3545' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' y1='8' x2='12' y2='12'/%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
    }

    @keyframes error-show {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .success-msg {
      color: var(--success);
      font-size: 13px;
      margin-top: 12px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .success-msg::before {
      content: '';
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2328a745' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 11.08V12a10 10 0 1 1-5.93-9.14'/%3E%3Cpolyline points='22 4 12 14.01 9 11.01'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-badge.enabled {
      background: rgba(40,167,69,0.1);
      color: var(--success);
    }
    
    .status-badge.disabled {
      background: rgba(220,53,69,0.1);
      color: var(--danger);
    }

    .CodeMirror-gutters {
      left: -2px !important;
    }
  </style>
</head>
<body>
  <!-- 登录界面 -->
  <div id="login" class="login-container">
    <div class="login-box">
      <h2>Prompt Manager</h2>
      <div class="input-group username">
        <input type="text" id="username" placeholder="用户名" />
      </div>
      <div class="input-group password">
        <input type="password" id="password" placeholder="密码" />
      </div>
      <button id="loginBtn" class="btn btn-primary">登录</button>
    </div>
  </div>

  <!-- 主界面 -->
  <div id="main" style="display: none; height: 100vh; flex-direction: column;">
    <!-- 顶部导航 -->
    <header>
      <div class="logo">
        Prompt Manager <span>Beta</span>
      </div>
      <div class="nav-right">
        <button id="logoutBtn" class="btn btn-outline">退出</button>
      </div>
    </header>

    <!-- 主体内容 -->
    <main>
      <!-- 左侧边栏 -->
      <aside>
        <div class="sidebar-header">
          <button id="newPromptBtn" class="new-prompt-btn">
            新建 Prompt
          </button>
          <div class="search-container">
            <div class="search-box">
              <input type="text" id="searchInput" placeholder="搜索提示词..." />
              <button type="button" class="clear-btn" title="清除搜索"></button>
            </div>
            <button id="newGroupBtn" class="folder-btn" title="新建目录">
            </button>
          </div>
        </div>
        
        <div id="groupList"></div>
      </aside>

      <!-- 右侧编辑器 -->
      <div class="editor-container">
        <div class="editor-header">
          <div class="editor-header-top">
            <input type="text" id="promptName" placeholder="Prompt 名称" />
            <select id="promptGroup">
              <option value="default">default</option>
              <option value="developer">developer</option>
              <option value="generator">generator</option>
              <option value="operation">operation</option>
            </select>
            <div class="editor-controls">
              <div class="mode-toggle">
                <button id="editModeBtn" class="mode-btn active" data-mode="edit">编辑</button>
                <button id="previewModeBtn" class="mode-btn" data-mode="preview">预览</button>
              </div>
              <button id="saveBtn" class="btn btn-primary btn-sm">
                保存
              </button>
            </div>
          </div>
          <textarea id="promptDescription" class="prompt-description" placeholder="Prompt 描述"></textarea>
        </div>

        <div class="editor-content">
          <section class="arguments-section" id="argumentsSection">
            <div class="arguments-header">
              <div class="arguments-title">
                <span>参数配置</span>
              </div>
              <div class="arguments-actions">
                <button id="addArgumentBtn" class="btn btn-outline btn-sm" type="button">
                  新增
                </button>
              </div>
            </div>
            <div class="arguments-list" id="argumentsList">
              <div class="arguments-empty">暂无参数，点击“新增”开始配置</div>
            </div>
          </section>
          <div class="editor-body" id="editorWorkspace">
            <div class="workspace-pane" id="editorPane">
              <div class="pane-header">编辑器</div>
              <div class="pane-content">
                <textarea id="editor"></textarea>
              </div>
            </div>
            <div class="workspace-pane hidden" id="previewPane">
              <div class="pane-header">实时预览</div>
              <div class="pane-content preview">
                <div class="preview-content" id="previewContent">
                  <p>选择或创建prompt开始编辑</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 消息提示 -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- 参数编辑弹窗 -->
  <div id="argumentModal" class="argument-modal hidden" role="dialog" aria-modal="true" aria-labelledby="argumentModalTitle">
    <div class="argument-modal-dialog">
      <div class="argument-modal-header">
        <h3 id="argumentModalTitle">新增参数</h3>
        <button type="button" id="argumentModalClose" class="argument-modal-close" aria-label="关闭">×</button>
      </div>
      <form id="argumentForm" class="argument-modal-form">
        <div class="argument-modal-body">
          <div class="argument-form-grid">
            <div class="form-field">
              <label for="argumentNameInput">参数名称 <span class="required">*</span></label>
              <input type="text" id="argumentNameInput" placeholder="例如：language" />
            </div>
            <div class="form-field">
              <label for="argumentTypeInput">类型</label>
              <input type="text" id="argumentTypeInput" list="argumentTypeOptions" placeholder="例如：string" />
            </div>
            <div class="form-field">
              <label for="argumentDefaultInput">默认值</label>
              <input type="text" id="argumentDefaultInput" placeholder="可选" />
            </div>
            <div class="form-field form-field-inline">
              <label class="checkbox-field">
                <input type="checkbox" id="argumentRequiredInput" />
                <span>必填</span>
              </label>
            </div>
            <div class="form-field full-width">
              <label for="argumentDescriptionInput">参数说明</label>
              <textarea id="argumentDescriptionInput" rows="3" placeholder="用于提示词中的描述"></textarea>
            </div>
          </div>
        </div>
        <div class="argument-modal-footer">
          <button type="button" class="btn btn-outline" id="argumentCancelBtn">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <datalist id="argumentTypeOptions">
    <option value="string">字符串</option>
    <option value="number">数字</option>
    <option value="boolean">布尔值</option>
  </datalist>

  <script>
    // 应用状态
    let currentToken = localStorage.getItem('prompt-admin-token')
    let currentPrompt = null
    let currentPromptObject = null
    let descriptionInputEl = null
    let allPrompts = []
    let expandedGroups = new Set()
    let editor = null
    let argumentsState = []
    let unusedArgumentNames = new Set()
    let editingArgumentIndex = null
    let argumentModalEl = null
    let argumentFormEl = null
    let argumentModalTitleEl = null
    let argumentNameInput = null
    let argumentTypeInput = null
    let argumentRequiredInput = null
    let argumentDefaultInput = null
    let argumentDescriptionInput = null

    // API 基础配置
    const API_BASE = '/api'

    // 动态加载CodeMirror资源
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = src
        script.onload = resolve
        script.onerror = () => reject(new Error(`加载失败: ${src}`))
        document.head.appendChild(script)
      })
    }

    // API请求封装
    async function apiCall(endpoint, options = {}) {
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      }

      if (currentToken) {
        config.headers.Authorization = `Bearer ${currentToken}`
      }

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, config)
        
        if (response.status === 401) {
          // Token 过期，重新登录
          localStorage.removeItem('prompt-admin-token')
          currentToken = null
          showLogin()
          throw new Error('登录已过期，请重新登录')
        }

        if (!response.ok) {
          const error = await response.text()
          throw new Error(error || '请求失败')
        }

        return await response.json()
      } catch (error) {
        const handledError = error instanceof Error ? error : new Error(error?.message || '请求失败')
        handledError.__shown = true
        console.error('API请求错误:', handledError)
        showMessage(handledError.message, 'error')
        throw handledError
      }
    }

    // 提示组件
    function showMessage(message, type = 'success', options = {}) {
      const container = document.getElementById('toastContainer')
      if (!container) return

      const normalizedType = ['success', 'error', 'info', 'warning'].includes(type) ? type : 'success'
      const titleMap = {
        success: '操作成功',
        error: '操作失败',
        info: '提示信息',
        warning: '注意'
      }
      const iconMap = {
        success: '✓',
        error: '✕',
        info: 'ℹ',
        warning: '!' 
      }

      const toast = document.createElement('div')
      toast.className = `toast toast-${normalizedType}`
      toast.setAttribute('role', normalizedType === 'error' ? 'alert' : 'status')
      toast.setAttribute('aria-live', normalizedType === 'error' ? 'assertive' : 'polite')

      const iconEl = document.createElement('span')
      iconEl.className = 'toast-icon'
      iconEl.textContent = options.icon || iconMap[normalizedType]

      const contentEl = document.createElement('div')
      contentEl.className = 'toast-content'

      const titleText = options.title || titleMap[normalizedType]
      if (titleText) {
        const titleEl = document.createElement('div')
        titleEl.className = 'toast-title'
        titleEl.textContent = titleText
        contentEl.appendChild(titleEl)
      }

      const messageEl = document.createElement('div')
      messageEl.className = 'toast-message'
      messageEl.textContent = message
      contentEl.appendChild(messageEl)

      const closeBtn = document.createElement('button')
      closeBtn.className = 'toast-close'
      closeBtn.type = 'button'
      closeBtn.setAttribute('aria-label', '关闭提示')
      closeBtn.innerHTML = '&times;'

      toast.appendChild(iconEl)
      toast.appendChild(contentEl)
      toast.appendChild(closeBtn)
      container.appendChild(toast)

      let hideTimer
      let removed = false

      const removeToast = () => {
        if (removed) return
        removed = true
        toast.classList.add('toast-leave')
        toast.removeEventListener('mouseenter', pauseTimer)
        toast.removeEventListener('mouseleave', resumeTimer)
        setTimeout(() => {
          if (toast.parentNode === container) {
            container.removeChild(toast)
          }
        }, 250)
      }

      const pauseTimer = () => clearTimeout(hideTimer)
      const resumeTimer = () => {
        clearTimeout(hideTimer)
        hideTimer = setTimeout(removeToast, Number(options.duration) || 5000)
      }

      closeBtn.addEventListener('click', () => {
        pauseTimer()
        removeToast()
      })

      toast.addEventListener('mouseenter', pauseTimer)
      toast.addEventListener('mouseleave', resumeTimer)

      resumeTimer()
    }

    // 登录功能
    async function login(username, password) {
      try {
        const result = await apiCall('/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        })
        
        currentToken = result.token
        localStorage.setItem('prompt-admin-token', currentToken)
        showMain()
        loadPrompts()
      } catch (error) {
        document.getElementById('loginError').textContent = error.message || '登录失败'
      }
    }

    function escapeHtml(input) {
      if (input === null || input === undefined) {
        return ''
      }
      return String(input).replace(/[&<>"']/g, (match) => {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }
        return map[match] || match
      })
    }

    function escapeRegExp(input) {
      return String(input).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
    }

    // 退出登录
    function logout() {
      localStorage.removeItem('prompt-admin-token')
      currentToken = null
      showLogin()
    }

    // 显示登录界面
    function showLogin() {
      document.getElementById('login').style.display = 'flex'
      document.getElementById('main').style.display = 'none'
    }

    // 显示主界面
    function showMain() {
      document.getElementById('login').style.display = 'none'
      document.getElementById('main').style.display = 'block'
    }

    // 加载prompt列表
    async function loadPrompts(search = '', enabledOnly = false, group = null) {
      try {
        const queryParams = new URLSearchParams()
        if (search) queryParams.append('search', search)
        if (enabledOnly) queryParams.append('enabled', 'true')
        if (group) queryParams.append('group', group)
        
        const prompts = await apiCall(`/prompts?${queryParams}`)
        allPrompts = prompts
        renderGroupList(prompts)
      } catch (error) {
        console.error('加载prompt列表失败:', error)
      }
    }

    function createDefaultPromptObject() {
      return {
        name: 'new-prompt',
        description: '新prompt描述',
        enabled: true,
        messages: [
          {
            role: 'user',
            content: {
              text: `这是一个新的prompt模板\n{{variable1}}`
            }
          }
        ],
        arguments: [
          {
            name: 'variable1',
            type: 'string',
            required: false,
            default: '',
            description: '示例变量'
          }
        ],
        variables: [
          {
            name: 'variable1',
            type: 'string',
            required: false,
            default: '',
            description: '示例变量'
          }
        ]
      }
    }

    function clonePromptObject(obj) {
      return obj ? JSON.parse(JSON.stringify(obj)) : null
    }

    function getFirstUserMessage(promptObj) {
      if (!promptObj || !Array.isArray(promptObj.messages)) return null
      return promptObj.messages.find(message => message?.role === 'user') || null
    }

    function buildPromptObjectFromUI() {
      const nameInput = document.getElementById('promptName')
      const name = (nameInput?.value || '').trim() || 'new-prompt'
      const description = descriptionInputEl?.value || ''
      const markdown = editor ? editor.getValue() : ''

      const base = clonePromptObject(currentPromptObject) || createDefaultPromptObject()
      base.name = name
      base.description = description

      if (!Array.isArray(base.messages)) {
        base.messages = []
      }

      let userMessage = getFirstUserMessage(base)
      if (!userMessage) {
        userMessage = { role: 'user', content: { text: '' } }
        base.messages.push(userMessage)
      }

      if (!userMessage.content || typeof userMessage.content !== 'object') {
        userMessage.content = {}
      }

      userMessage.content.text = markdown

      const sanitizedArguments = Array.isArray(argumentsState)
        ? argumentsState
            .map(arg => {
              const nameValue = (arg.name || '').trim()
              if (!nameValue) return null
              const typeValue = (arg.type || '').trim()
              const descriptionValue = (arg.description || '').trim()
              const defaultValue = arg.default
              const argumentResult = {
                name: nameValue,
                type: typeValue || 'string',
                required: Boolean(arg.required)
              }
              if (descriptionValue) {
                argumentResult.description = descriptionValue
              }
              if (defaultValue !== undefined && defaultValue !== null) {
                const defaultText = String(defaultValue).trim()
                if (defaultText) {
                  argumentResult.default = defaultText
                }
              }
              return argumentResult
            })
            .filter(Boolean)
        : []

      base.arguments = sanitizedArguments

      return base
    }

    function adjustDescriptionHeight() {
      if (!descriptionInputEl) return

      const style = window.getComputedStyle(descriptionInputEl)
      const lineHeight = parseFloat(style.lineHeight) || 20
      const padding = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom) || 0
      const border = parseFloat(style.borderTopWidth) + parseFloat(style.borderBottomWidth) || 0
      const maxHeight = lineHeight * 4 + padding + border
      const baseHeight = lineHeight + padding + border

      descriptionInputEl.style.height = 'auto'
      const contentHeight = descriptionInputEl.scrollHeight
      const newHeight = Math.max(baseHeight, Math.min(maxHeight, contentHeight))
      descriptionInputEl.style.height = `${newHeight}px`
      descriptionInputEl.style.overflowY = descriptionInputEl.scrollHeight > maxHeight ? 'auto' : 'hidden'
    }

    function normalizeArgument(argument = {}) {
      return {
        name: argument?.name ? String(argument.name) : '',
        description: argument?.description ? String(argument.description) : '',
        type: argument?.type ? String(argument.type) : 'string',
        required: Boolean(argument?.required),
        default: argument?.default ?? ''
      }
    }

    function setArgumentsState(list = []) {
      argumentsState = Array.isArray(list) ? list.map(item => normalizeArgument(item)) : []
      unusedArgumentNames = new Set()
      const section = document.getElementById('argumentsSection')
      if (section) {
        section.classList.remove('has-error')
      }
      renderArgumentsEditor()
    }

    function removeArgument(index) {
      if (index < 0 || index >= argumentsState.length) return
      argumentsState.splice(index, 1)
      setUnusedArgumentHighlights([])
    }

    function renderArgumentsEditor() {
      const listEl = document.getElementById('argumentsList')
      if (!listEl) return

      listEl.innerHTML = ''

      if (!argumentsState.length) {
        listEl.innerHTML = '<div class="arguments-empty">暂无参数，点击“新增参数”开始配置</div>'
        return
      }

      const fragment = document.createDocumentFragment()

      argumentsState.forEach((rawArgument, index) => {
        const argument = normalizeArgument(rawArgument)
        const displayName = argument.name?.trim() || `参数 ${index + 1}`
        const normalizedName = argument.name?.trim() || ''
        const safeType = escapeHtml(argument.type || 'string')
        const safeDefault = argument.default ? escapeHtml(String(argument.default)) : ''
        const safeDescription = argument.description ? escapeHtml(argument.description) : ''

        const card = document.createElement('div')
        card.className = 'argument-card'
        card.dataset.index = index

        if (normalizedName && unusedArgumentNames.has(normalizedName)) {
          card.classList.add('argument-card-unused')
        }

        const badgeParts = [`<span class="argument-badge">类型：${safeType || 'string'}</span>`]
        if (argument.required) {
          badgeParts.push('<span class="argument-badge argument-required">必填</span>')
        }
        if (safeDefault) {
          badgeParts.push(`<span class="argument-badge">默认：${safeDefault}</span>`)
        }

        const placeholderSnippet = normalizedName
          ? `<div>变量占位：<span class="argument-placeholder">{{${escapeHtml(normalizedName)}}}</span></div>`
          : ''

        card.innerHTML = `
          <div class="argument-card-header">
            <div class="argument-name">${escapeHtml(displayName)}</div>
            <div class="argument-badges">${badgeParts.join('')}</div>
          </div>
          <div class="argument-body">
            ${safeDescription ? `<div class="argument-description">${safeDescription}</div>` : '<div class="argument-description" style="color: var(--gray);">暂无说明</div>'}
            ${placeholderSnippet}
          </div>
          <div class="argument-actions">
            <button type="button" class="argument-action-btn edit" data-action="edit" data-index="${index}">编辑</button>
            <button type="button" class="argument-action-btn delete" data-action="delete" data-index="${index}">删除</button>
          </div>
        `

        fragment.appendChild(card)
      })

      listEl.appendChild(fragment)
    }

    function setUnusedArgumentHighlights(names = []) {
      unusedArgumentNames = new Set(Array.isArray(names) ? names.map(name => String(name).trim()).filter(Boolean) : [])
      const section = document.getElementById('argumentsSection')
      if (section) {
        section.classList.toggle('has-error', unusedArgumentNames.size > 0)
      }
      renderArgumentsEditor()
    }

    function openArgumentModal(index = null) {
      if (!argumentModalEl) return
      editingArgumentIndex = Number.isInteger(index) && index >= 0 ? index : null
      const isEdit = editingArgumentIndex !== null && argumentsState[editingArgumentIndex]
      const payload = isEdit ? normalizeArgument(argumentsState[editingArgumentIndex]) : normalizeArgument({ type: 'string' })

      if (argumentModalTitleEl) {
        argumentModalTitleEl.textContent = isEdit ? '编辑参数' : '新增参数'
      }
      if (argumentNameInput) {
        argumentNameInput.value = payload.name || ''
      }
      if (argumentTypeInput) {
        argumentTypeInput.value = payload.type || 'string'
      }
      if (argumentRequiredInput) {
        argumentRequiredInput.checked = Boolean(payload.required)
      }
      if (argumentDefaultInput) {
        const modalDefaultValue = payload.default
        argumentDefaultInput.value = modalDefaultValue === undefined || modalDefaultValue === null ? '' : String(modalDefaultValue)
      }
      if (argumentDescriptionInput) {
        argumentDescriptionInput.value = payload.description || ''
      }

      argumentModalEl.classList.remove('hidden')
      argumentModalEl.setAttribute('aria-hidden', 'false')
      document.body.classList.add('modal-open')

      requestAnimationFrame(() => {
        if (argumentNameInput) {
          argumentNameInput.focus()
          argumentNameInput.select()
        }
      })
    }

    function closeArgumentModal() {
      if (!argumentModalEl) return
      argumentModalEl.classList.add('hidden')
      argumentModalEl.setAttribute('aria-hidden', 'true')
      document.body.classList.remove('modal-open')
      editingArgumentIndex = null

      if (argumentFormEl) {
        argumentFormEl.reset()
      }
      if (argumentNameInput) {
        argumentNameInput.value = ''
      }
      if (argumentTypeInput) {
        argumentTypeInput.value = 'string'
      }
      if (argumentRequiredInput) {
        argumentRequiredInput.checked = false
      }
      if (argumentDefaultInput) {
        argumentDefaultInput.value = ''
      }
      if (argumentDescriptionInput) {
        argumentDescriptionInput.value = ''
      }
    }

    function handleArgumentFormSubmit(event) {
      event.preventDefault()
      if (!argumentNameInput || !argumentTypeInput) return

      const name = (argumentNameInput.value || '').trim()
      if (!name) {
        showMessage('请输入参数名称', 'error')
        argumentNameInput.focus()
        return
      }

      const type = (argumentTypeInput.value || 'string').trim() || 'string'
      const required = argumentRequiredInput ? argumentRequiredInput.checked : false
      const defaultValue = argumentDefaultInput ? argumentDefaultInput.value : ''
      const description = argumentDescriptionInput ? argumentDescriptionInput.value.trim() : ''

      const payload = normalizeArgument({
        name,
        type,
        required,
        default: defaultValue,
        description
      })

      if (editingArgumentIndex !== null && argumentsState[editingArgumentIndex]) {
        argumentsState[editingArgumentIndex] = payload
      } else {
        argumentsState.push(payload)
      }

      closeArgumentModal()
      setUnusedArgumentHighlights([])
    }

    function collectPromptTextContent(promptObject) {
      const segments = []
      if (!promptObject || !Array.isArray(promptObject.messages)) {
        return ''
      }
      promptObject.messages.forEach(message => {
        if (!message) return
        const content = message.content
        if (Array.isArray(content)) {
          content.forEach(item => {
            if (typeof item === 'string') {
              segments.push(item)
            } else if (item && typeof item === 'object') {
              Object.values(item).forEach(value => {
                if (typeof value === 'string') {
                  segments.push(value)
                }
              })
            }
          })
        } else if (typeof content === 'string') {
          segments.push(content)
        } else if (content && typeof content === 'object') {
          Object.values(content).forEach(value => {
            if (typeof value === 'string') {
              segments.push(value)
            }
          })
        }
      })
      return segments.join('\n')
    }

    function findUnusedArguments(promptObject) {
      const args = Array.isArray(promptObject?.arguments) ? promptObject.arguments : []
      if (!args.length) return []
      const combinedContent = collectPromptTextContent(promptObject)
      return args.filter(arg => {
        const name = arg?.name?.trim()
        if (!name) return false
        const pattern = new RegExp(`{{\\s*${escapeRegExp(name)}\\s*}}`)
        return !pattern.test(combinedContent)
      })
    }

    function handleArgumentListClick(event) {
      const target = event.target.closest('[data-action]')
      if (!target) return
      const action = target.dataset.action
      const index = Number(target.dataset.index)
      if (!Number.isInteger(index)) return
      if (action === 'delete') {
        const argumentName = argumentsState[index]?.name || `参数 ${index + 1}`
        const confirmed = window.confirm(`确定要删除参数 "${argumentName}" 吗？`)
        if (!confirmed) return
        removeArgument(index)
      } else if (action === 'edit') {
        openArgumentModal(index)
      }
    }

    // 渲染分组列表
    async function renderGroupList(prompts) {
      try {
        // 从API获取所有分组及数量信息
        const groups = await apiCall('/groups');
        const container = document.getElementById('groupList');
        container.innerHTML = '';

        const validGroupNames = new Set(groups.map(group => group.name));
        expandedGroups = new Set([...expandedGroups].filter(name => validGroupNames.has(name)));

        // 按照目录顺序渲染分组
        groups.forEach(groupInfo => {
          const groupName = groupInfo.name;
          // 找出属于该分组的prompts
          const groupPrompts = prompts.filter(prompt => (prompt.group || 'default') === groupName);
          const section = document.createElement('div');
          section.className = 'group-section';
          section.innerHTML = `
            <div class="group-header" data-group="${groupName}">
              <span>${groupName}</span>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span class="group-count" id="group-count-${groupName}">0</span>
                <span class="group-toggle"></span>
              </div>
            </div>
            <div class="group-content collapsed">
              <div class="prompt-list" id="promptList-${groupName}">
                <!-- Prompt列表将通过JavaScript动态生成 -->
              </div>
            </div>
          `;
          container.appendChild(section);
          
          // 渲染该分组的prompt列表
          renderGroupPromptList(groupName, groupPrompts);
          
          // 更新分组计数
          const countElement = document.getElementById(`group-count-${groupName}`);
          if (countElement) {
            countElement.textContent = groupPrompts.length;
          }
          
          // 添加点击事件处理
          const header = section.querySelector('.group-header');
          const toggle = section.querySelector('.group-toggle');
          const content = section.querySelector('.group-content');

          const isExpanded = expandedGroups.has(groupName);
          content.classList.toggle('expanded', isExpanded);
          content.classList.toggle('collapsed', !isExpanded);
          toggle.classList.toggle('collapsed', !isExpanded);
          
          header.addEventListener('click', (e) => {
            // 检查点击的目标元素，只在点击分组标题文本部分时才展开/折叠，避开操作按钮
            const isClickOnActions = e.target.closest('.toggle-btn') || e.target.closest('.delete-btn') || e.target.closest('.prompt-actions');
            if (!isClickOnActions) {
              // 只有未点击操作按钮时才执行展开/折叠
              const nextExpanded = !content.classList.contains('expanded');
              content.classList.toggle('expanded', nextExpanded);
              content.classList.toggle('collapsed', !nextExpanded);
              toggle.classList.toggle('collapsed', !nextExpanded);

              if (nextExpanded) {
                expandedGroups.add(groupName);
              } else {
                expandedGroups.delete(groupName);
              }
            }
          });
        });
      } catch (error) {
        console.error('渲染分组列表失败:', error);
      }
    }
    
    // 加载分组列表
    async function loadGroups() {
      try {
        const groups = await apiCall('/groups')
        return groups.map(group => group.name)
      } catch (error) {
        console.error('加载分组列表失败:', error)
        return ['default']
      }
    }
    
    // 渲染分组内的prompt列表
    function renderGroupPromptList(groupName, prompts) {
      const container = document.getElementById(`promptList-${groupName}`)
      container.innerHTML = ''

      prompts.forEach(prompt => {
        const item = document.createElement('div')
        item.className = `prompt-item ${prompt.enabled ? 'enabled' : ''} ${currentPrompt?.name === prompt.name ? 'active' : ''}`
        item.innerHTML = `
          <div class="prompt-info">
            <div class="prompt-name">${prompt.name}</div>
            <div class="prompt-desc" title="${prompt.description || ''}">${prompt.description || ''}</div>
          </div>
          <div class="prompt-meta">
            <div class="prompt-actions">
              <button class="action-btn toggle-btn" data-prompt="${prompt.name}">
                ${prompt.enabled ? '停用' : '启用'}
              </button>
              <button class="action-btn delete-btn" data-prompt="${prompt.name}" style="color: var(--danger);">
                删除
              </button>
            </div>
          </div>
        `
        
        item.addEventListener('click', (e) => {
          // 只有点击prompt信息区域才选择prompt，点击操作按钮不触发
          if (!e.target.closest('.prompt-actions') && !e.target.classList.contains('toggle-btn') && !e.target.classList.contains('delete-btn')) {
            selectPrompt(prompt, e)
          }
        })
        
        // 阻止操作按钮的点击事件冒泡，避免触发目录折叠
        const actions = item.querySelector('.prompt-actions');
        if (actions) {
          actions.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
          });
          
          // 为每个操作按钮单独添加事件监听器，确保完全阻止事件冒泡
          const toggleBtn = item.querySelector('.toggle-btn');
          const deleteBtn = item.querySelector('.delete-btn');
          
          if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              e.preventDefault();
              togglePromptByName(prompt.name);
              // 重新加载列表，传递搜索参数
              const searchInput = document.getElementById('searchInput');
              const searchValue = searchInput ? searchInput.value : '';
              loadPrompts(searchValue);
            });
          }
          
          if (deleteBtn) {
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              e.preventDefault();
              if (confirm(`确定要删除 "${prompt.name}" 吗？`)) {
                deletePromptByName(prompt.name);
                // 重新加载列表，传递搜索参数
                const searchInput = document.getElementById('searchInput');
                const searchValue = searchInput ? searchInput.value : '';
                loadPrompts(searchValue);
              }
            });
          }
        }
        
        container.appendChild(item)
      })
      
      // 操作按钮事件监听已移到上面的item.addEventListener中，避免重复绑定
    }
    
    // 根据名称切换prompt启用状态
    async function togglePromptByName(promptName) {
      try {
        const result = await apiCall(`/prompts/${promptName}/toggle`, {
          method: 'POST'
        })
        // 重新加载列表，传递搜索参数
        const searchInput = document.getElementById('searchInput');
        const searchValue = searchInput ? searchInput.value : '';
        loadPrompts(searchValue)
        const statusText = result?.enabled ? '已启用' : '已停用'
        showMessage(`“${promptName}” ${statusText}`, result?.enabled ? 'success' : 'info')
      } catch (error) {
        console.error('切换prompt状态失败:', error)
        showMessage('启用状态切换失败: ' + error.message, 'error')
      }
    }
    
    // 根据名称删除prompt
    async function deletePromptByName(promptName) {
      try {
        await apiCall(`/prompts/${promptName}`, {
          method: 'DELETE'
        })
        showMessage('删除成功')
        // 重新加载列表，传递搜索参数
        const searchInput = document.getElementById('searchInput');
        const searchValue = searchInput ? searchInput.value : '';
        loadPrompts(searchValue)
      } catch (error) {
        console.error('删除prompt失败:', error)
        showMessage('删除失败: ' + error.message, 'error')
      }
    }

    // 选择prompt
    async function selectPrompt(prompt, triggerEvent) {
      try {
        const promptData = await apiCall(`/prompts/${prompt.name}`)
        currentPrompt = promptData

        let parsedPrompt = null
        try {
          parsedPrompt = window.jsyaml?.load(promptData.yaml || '') || null
        } catch (err) {
          console.error('解析提示词失败:', err)
        }

        currentPromptObject = parsedPrompt ? clonePromptObject(parsedPrompt) : createDefaultPromptObject()
        setArgumentsState(currentPromptObject.arguments || [])

        const nameInput = document.getElementById('promptName')
        if (nameInput) nameInput.value = currentPromptObject.name || promptData.name || ''
        document.getElementById('promptGroup').value = promptData.group || 'default'

        if (descriptionInputEl) {
          descriptionInputEl.value = currentPromptObject.description || ''
          adjustDescriptionHeight()
        }

        const userMessage = getFirstUserMessage(currentPromptObject)
        const messageText = userMessage?.content?.text || ''
        if (editor) {
          editor.setValue(messageText)
        }

        // 更新UI状态
        document.querySelectorAll('.prompt-item').forEach(el => el.classList.remove('active'))
        const targetItem = triggerEvent?.currentTarget || triggerEvent?.target?.closest('.prompt-item')
        if (targetItem) {
          targetItem.classList.add('active')
        }

        // 更新预览
        updatePreview(true)
      } catch (error) {
        console.error('加载prompt详情失败:', error)
      }
    }



    // 切换工作区模式
    function setWorkspaceMode(mode) {
      const isPreview = mode === 'preview'
      const editorPane = document.getElementById('editorPane')
      const previewPane = document.getElementById('previewPane')
      const editModeBtn = document.getElementById('editModeBtn')
      const previewModeBtn = document.getElementById('previewModeBtn')
      const argumentsSection = document.getElementById('argumentsSection')

      if (!editorPane || !previewPane || !editModeBtn || !previewModeBtn) return

      editModeBtn.classList.toggle('active', !isPreview)
      previewModeBtn.classList.toggle('active', isPreview)
      editorPane.classList.toggle('hidden', isPreview)
      previewPane.classList.toggle('hidden', !isPreview)
      
      // 在预览模式下隐藏参数配置区域，编辑模式下显示
      if (argumentsSection) {
        argumentsSection.style.display = isPreview ? 'none' : 'flex'
      }

      if (isPreview) {
        updatePreview(true)
      } else {
        if (editor) {
          editor.refresh()
        }
        // 在切换回编辑模式时清理预览编辑器
        if (previewEditor) {
          const previewContent = document.getElementById('previewContent')
          if (previewContent) {
            previewContent.innerHTML = '<p>切换到预览模式查看内容</p>'
          }
          previewEditor = null
        }
      }
    }

    // 更新预览
    let previewEditor = null;

    async function updatePreview(force = false) {
      if (!editor) return

      const previewPane = document.getElementById('previewPane')
      if (!force && previewPane?.classList.contains('hidden')) {
        return
      }

      try {
        const previewContent = document.getElementById('previewContent')
        if (!previewContent) return

        const content = editor.getValue()
        
        // 如果预览编辑器不存在，创建一个
        if (!previewEditor) {
          previewContent.innerHTML = ''
          previewEditor = CodeMirror((elt) => {
            previewContent.appendChild(elt)
          }, {
            value: content,
            mode: 'markdown',
            theme: 'xq-light',
            lineWrapping: true,
            readOnly: true,
            lineNumbers: false,
            cursorHeight: 0
          })
        } else {
          // 更新预览内容
          previewEditor.setValue(content)
        }

        // 确保预览区域的 CodeMirror 实例能正确显示
        setTimeout(() => {
          if (previewEditor) {
            previewEditor.refresh()
          }
        }, 10)

      } catch (error) {
        console.error('预览更新失败:', error)
        document.getElementById('previewContent').innerHTML = '<p style="color: red;">预览生成失败</p>'
      }
    }

    // 保存prompt
    async function savePrompt() {
      if (!editor) return

      const saveBtn = document.getElementById('saveBtn')
      if (saveBtn?.disabled) return

      const name = document.getElementById('promptName').value.trim()
      const group = document.getElementById('promptGroup').value.trim()

      if (!window.jsyaml) {
        showMessage('资源未准备就绪，请刷新重试', 'error')
        return
      }

      if (!name) {
        showMessage('请输入prompt名称', 'error')
        return
      }

      const promptObject = buildPromptObjectFromUI()
      const unusedArguments = findUnusedArguments(promptObject)
      if (unusedArguments.length > 0) {
        const missingNames = unusedArguments.map(arg => arg.name).filter(Boolean)
        if (missingNames.length) {
          setUnusedArgumentHighlights(missingNames)
          const argumentsSection = document.getElementById('argumentsSection')
          if (argumentsSection) {
            argumentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' })
          }
          showMessage(`以下参数未在内容中使用：${missingNames.join(', ')}`, 'error')
          const firstMissing = missingNames[0]
          requestAnimationFrame(() => {
            const listEl = document.getElementById('argumentsList')
            if (!listEl) return
            const targetCard = Array.from(listEl.querySelectorAll('.argument-card')).find(card => {
              const idx = Number(card.dataset.index)
              const argName = argumentsState[idx]?.name?.trim()
              return argName === firstMissing
            })
            if (targetCard) {
              const targetIndex = Number(targetCard.dataset.index)
              if (Number.isInteger(targetIndex)) {
                openArgumentModal(targetIndex)
              }
            }
          })
          return
        }
      } else {
        setUnusedArgumentHighlights([])
      }
      const yaml = window.jsyaml.dump(promptObject)

      let originalText = ''
      if (saveBtn) {
        originalText = (saveBtn.textContent || '保存').trim()
        saveBtn.disabled = true
        saveBtn.classList.add('loading')
        saveBtn.textContent = '保存中...'
      }
      
      try {
        await apiCall('/prompts', {
          method: 'POST',
          body: JSON.stringify({
            name,
            group,
            yaml
          })
        })
        
        showMessage('保存成功')
        currentPromptObject = clonePromptObject(promptObject)
        currentPrompt = { ...(currentPrompt || {}), name }
        // 重新加载列表，传递搜索参数
        const searchInput = document.getElementById('searchInput');
        const searchValue = searchInput ? searchInput.value : '';
        loadPrompts(searchValue)
      } catch (error) {
        console.error('保存失败:', error)
        if (!error?.__shown) {
          showMessage('保存失败: ' + (error?.message || '未知错误'), 'error')
        }
      } finally {
        if (saveBtn) {
          saveBtn.disabled = false
          saveBtn.classList.remove('loading')
          saveBtn.textContent = originalText
        }
      }
    }

    // 重置编辑器
    function resetEditor() {
      document.getElementById('promptName').value = ''
      document.getElementById('promptGroup').value = 'default'
      if (editor) editor.setValue('')
      if (descriptionInputEl) {
        descriptionInputEl.value = ''
        adjustDescriptionHeight()
      }
      setArgumentsState([])
      currentPrompt = null
      currentPromptObject = null
      document.getElementById('previewContent').innerHTML = '<p>选择或创建prompt开始编辑</p>'
      setWorkspaceMode('edit')
    }

    // 新建prompt
    function newPrompt() {
      currentPrompt = null
      currentPromptObject = createDefaultPromptObject()

      const nameInput = document.getElementById('promptName')
      if (nameInput) nameInput.value = currentPromptObject.name
      document.getElementById('promptGroup').value = 'default'

      const defaultMessage = getFirstUserMessage(currentPromptObject)
      if (editor) {
        editor.setValue(defaultMessage?.content?.text || '')
      }

      setArgumentsState(currentPromptObject.arguments || [])

      if (descriptionInputEl) {
        descriptionInputEl.value = currentPromptObject.description || ''
        adjustDescriptionHeight()
      }

      document.getElementById('previewContent').innerHTML = '<p>选择或创建prompt开始编辑</p>'
      setWorkspaceMode('edit')

      document.querySelectorAll('.prompt-item').forEach(el => el.classList.remove('active'))
      updatePreview(true)
    }
    
    // 创建新分组
    async function createNewGroup() {
      const groupName = prompt('请输入新分组名称:')
      if (!groupName) return
      
      try {
        await apiCall('/groups', {
          method: 'POST',
          body: JSON.stringify({ name: groupName })
        })
        
        showMessage('分组创建成功')
        loadPrompts()
      } catch (error) {
        console.error('创建分组失败:', error)
        showMessage('创建分组失败: ' + error.message, 'error')
      }
    }

    // 初始化应用
    async function initApp() {
      try {
        // 样式资源：https://codemirror.net/5/theme/
        // 效果预览：https://toolshu.com/codemirror-theme-prev#default

        // 并行加载资源
        await Promise.all([
          loadScript('./js/codemirror.min.js'),
          loadScript('./js/markdown.min.js'),
          loadScript('./js/closebrackets.min.js'),
          loadScript('./js/js-yaml.min.js')
        ])

        // 初始化编辑器
        editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
          mode: 'markdown',
          lineNumbers: false,
          theme: 'xq-light',
          lineWrapping: true,
          autoCloseBrackets: true,
          value: '请选择或创建prompt开始编辑'
        })

        editor.on('change', () => updatePreview())

        const editModeBtn = document.getElementById('editModeBtn')
        const previewModeBtn = document.getElementById('previewModeBtn')
        editModeBtn.addEventListener('click', () => setWorkspaceMode('edit'))
        previewModeBtn.addEventListener('click', () => setWorkspaceMode('preview'))
        setWorkspaceMode('edit')

        descriptionInputEl = document.getElementById('promptDescription')
        if (descriptionInputEl) {
          descriptionInputEl.addEventListener('input', adjustDescriptionHeight)
          adjustDescriptionHeight()
        }

        setArgumentsState([])

        argumentModalEl = document.getElementById('argumentModal')
        argumentFormEl = document.getElementById('argumentForm')
        argumentModalTitleEl = document.getElementById('argumentModalTitle')
        argumentNameInput = document.getElementById('argumentNameInput')
        argumentTypeInput = document.getElementById('argumentTypeInput')
        argumentRequiredInput = document.getElementById('argumentRequiredInput')
        argumentDefaultInput = document.getElementById('argumentDefaultInput')
        argumentDescriptionInput = document.getElementById('argumentDescriptionInput')

        if (argumentTypeInput && !argumentTypeInput.value) {
          argumentTypeInput.value = 'string'
        }

        const addArgumentBtn = document.getElementById('addArgumentBtn')
        if (addArgumentBtn) {
          addArgumentBtn.addEventListener('click', () => openArgumentModal(null))
        }

        const argumentsListEl = document.getElementById('argumentsList')
        if (argumentsListEl) {
          argumentsListEl.addEventListener('click', handleArgumentListClick)
        }

        if (argumentFormEl) {
          argumentFormEl.addEventListener('submit', handleArgumentFormSubmit)
        }

        const argumentCancelBtn = document.getElementById('argumentCancelBtn')
        if (argumentCancelBtn) {
          argumentCancelBtn.addEventListener('click', closeArgumentModal)
        }

        const argumentModalClose = document.getElementById('argumentModalClose')
        if (argumentModalClose) {
          argumentModalClose.addEventListener('click', closeArgumentModal)
        }

        if (argumentModalEl) {
          argumentModalEl.addEventListener('click', (event) => {
            if (event.target === argumentModalEl) {
              closeArgumentModal()
            }
          })
        }

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && argumentModalEl && !argumentModalEl.classList.contains('hidden')) {
            closeArgumentModal()
          }
        })

        // 绑定事件
        document.getElementById('loginBtn').addEventListener('click', () => {
          const username = document.getElementById('username').value.trim()
          const password = document.getElementById('password').value.trim()
          
          if (!username || !password) {
            document.getElementById('loginError').textContent = '请输入用户名和密码'
            return
          }
          
          login(username, password)
        })

        document.getElementById('logoutBtn').addEventListener('click', logout)
        document.getElementById('newPromptBtn').addEventListener('click', newPrompt)
        document.getElementById('newGroupBtn').addEventListener('click', createNewGroup)
        document.getElementById('saveBtn').addEventListener('click', savePrompt)

        // 搜索功能
        const searchInput = document.getElementById('searchInput')
        const searchBox = searchInput.closest('.search-box')
        const clearBtn = searchBox.querySelector('.clear-btn')
        let searchTimeout

        // 搜索输入事件
        searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout)
          searchTimeout = setTimeout(() => {
            loadPrompts(searchInput.value)
          }, 300)
        })

        // 清除按钮点击事件
        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            searchInput.value = ''
            searchInput.focus()
            loadPrompts('')
          })
        }

        // ESC 键清除搜索
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            searchInput.value = ''
            loadPrompts('')
          }
        })

        // 检查登录状态
        if (currentToken) {
          showMain()
          loadPrompts()
        } else {
          showLogin()
        }

      } catch (err) {
        console.error('初始化错误:', err)
        document.getElementById('loginError').textContent = '资源加载失败，请刷新重试'
        throw err
      }
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', initApp)
  </script>
</body>
</html>
