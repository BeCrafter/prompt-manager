<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Manager 后台</title>
  <link rel="stylesheet" href="./css/codemirror.css">
  <link rel="stylesheet" href="./css/codemirror-theme_xq-light.css">
  <style>
    :root {
      --primary: #393939;
      --primary-dark: #393939;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --dark: #1a1a1a;
      --light: #f8f9fa;
      --gray: #6c757d;
      --gray-light: #dee2e6;
      --border: #e0e0e0;
      --sidebar-bg: #f8f9fa;
      --editor-bg: #263238;
      --preview-bg: #f5f5f5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    body {
      background-color: var(--light);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      letter-spacing: -0.01em;
      font-weight: 420;
    }
    
    header {
      background-color: white;
      padding: 12px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      font-size: 24px;
      font-weight: 580;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.02em;
    }
    
    .logo span {
      color: #8e8989;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 5px;
      font-weight: 450;
      border: 1px solid var(--border);
      letter-spacing: 0;
    }
    
    .nav-right {
      display: flex;
      gap: 12px;
      align-items: center;
      position: relative;
    }

    .user-profile {
      position: relative;
    }

    .avatar-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      border: none;
      background: rgba(0,0,0,0.02);
      cursor: pointer;
      border-radius: 50%;
      overflow: hidden;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-btn:hover {
      transform: translateY(-1px);
      background: rgba(0,0,0,0.04);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .avatar-img {
      width: 26px;
      height: 26px;
      object-fit: cover;
      border-radius: 50%;
      opacity: 0.75;
      transition: opacity 0.2s ease;
    }

    .avatar-btn:hover .avatar-img {
      opacity: 0.9;
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 240px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px) scale(0.96);
      transform-origin: top right;
      transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 1000;
      border: 1px solid var(--border);
    }

    .dropdown-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    .dropdown-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--light);
      padding: 3px;
      opacity: 0.8;
    }

    .user-details {
      flex: 1;
      min-width: 0;
      padding: 2px 0;
    }

    .user-name {
      font-size: 15px;
      font-weight: 500;
      color: var(--dark);
      margin-bottom: 2px;
    }

    .user-role {
      font-size: 13px;
      color: var(--gray);
    }

    .dropdown-divider {
      height: 1px;
      background: var(--border);
      margin: 8px 0;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: none;
      font-size: 14px;
      color: var(--dark);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dropdown-item:last-child {
      border-radius: 0 0 12px 12px;
    }

    .dropdown-item:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    .dropdown-item .dropdown-icon {
      width: 18px;
      height: 18px;
      color: var(--gray);
    }

    .dropdown-item:hover .dropdown-icon {
      color: var(--primary);
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--dark);
    }
    
    .btn-outline:hover {
      background: var(--light);
    }

    .btn-light {
      background: white;
      border: 1px solid var(--border);
      color: var(--dark);
    }

    .btn-light:hover {
      background: var(--light);
    }

    .btn-dark {
      background: var(--dark);
      color: white;
    }

    .btn-dark:hover {
      background: #000;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #b71f31;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    #addArgumentBtn {
      padding: 6px 12px;
      font-size: 12px;
    }

    button#saveBtn{
      padding: 10px 18px;
      font-size: 14px;
    }
    
    .btn.loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .btn-icon {
      padding: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
      height: 93%;
    }
    
    aside {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
      max-height: 100%;
      overflow-y: auto;
      scrollbar-width: none;
    }
    
    .sidebar-header {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    
    .new-prompt-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .new-prompt-btn:hover {
      background: #333;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .new-prompt-btn::before {
      content: '+';
      font-size: 18px;
      font-weight: 400;
      margin-right: 2px;
    }
    
    .search-container {
      display: flex;
      gap: 10px;
      margin-top: 2px;
    }
    
    .search-box {
      position: relative;
      flex: 1;
    }
    
    .search-box input {
      width: 100%;
      padding: 9px 32px 9px 38px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: white;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(57,57,57,0.1);
    }
    
    .search-box::before {
      content: '';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      opacity: 0.6;
    }

    .search-box .clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      display: none;
      align-items: center;
      justify-content: center;
      color: var(--gray);
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }

    .search-box .clear-btn::before {
      content: '';
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='15' y1='9' x2='9' y2='15'/%3E%3Cline x1='9' y1='9' x2='15' y2='15'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
    }

    .search-box .clear-btn:hover {
      opacity: 1;
    }

    .search-box input:not(:placeholder-shown) + .clear-btn {
      display: flex;
    }
    
    .folder-btn {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 38px;
      height: 38px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .folder-btn::before {
      content: '';
      width: 18px;
      height: 18px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z'/%3E%3Cline x1='12' y1='11' x2='12' y2='17'/%3E%3Cline x1='9' y1='14' x2='15' y2='14'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }
    
    .folder-btn:hover {
      background: #f8f9fa;
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .folder-btn:hover::before {
      opacity: 1;
    }
    
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column-reverse;
      gap: 12px;
      z-index: 5000;
      align-items: flex-end;
    }

    .toast {
      min-width: 280px;
      max-width: 360px;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 12px;
      padding: 16px 18px;
      display: flex;
      align-items: flex-start;
      gap: 14px;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.18);
      border: 1px solid transparent;
      opacity: 0;
      transform: translateY(16px);
      animation: toast-enter 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      pointer-events: auto;
    }

    .toast.toast-leave {
      animation: toast-leave 0.25s ease forwards;
    }

    .toast-success {
      border-color: rgba(40,167,69,0.35);
      background: linear-gradient(145deg, rgba(40,167,69,0.08), rgba(40,167,69,0.02));
    }

    .toast-error {
      border-color: rgba(220,53,69,0.35);
      background: linear-gradient(145deg, rgba(220,53,69,0.08), rgba(220,53,69,0.02));
    }

    .toast-info {
      border-color: rgba(0,102,255,0.3);
      background: linear-gradient(145deg, rgba(0,102,255,0.08), rgba(0,102,255,0.02));
    }

    .toast-warning {
      border-color: rgba(255,193,7,0.35);
      background: linear-gradient(145deg, rgba(255,193,7,0.1), rgba(255,193,7,0.03));
    }

    .toast-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      flex-shrink: 0;
      background: rgba(0,0,0,0.05);
      color: var(--dark);
    }

    .toast-success .toast-icon {
      background: rgba(40,167,69,0.15);
      color: var(--success);
    }

    .toast-error .toast-icon {
      background: rgba(220,53,69,0.15);
      color: var(--danger);
    }

    .toast-info .toast-icon {
      background: rgba(0,102,255,0.15);
      color: var(--primary);
    }

    .toast-warning .toast-icon {
      background: rgba(255,193,7,0.2);
      color: #b58100;
    }

    .toast-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .toast-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--dark);
    }

    .toast-message {
      font-size: 13px;
      color: var(--gray);
      line-height: 1.5;
      white-space: pre-line;
    }

    .toast-close {
      border: none;
      background: transparent;
      color: var(--gray);
      font-size: 18px;
      cursor: pointer;
      padding: 2px;
      line-height: 1;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .toast-close:hover {
      color: var(--dark);
    }
    
    @keyframes toast-enter {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes toast-leave {
      to {
        opacity: 0;
        transform: translateY(12px);
      }
    }
    
    .variable-desc {
      font-size: 12px;
      color: var(--gray);
      margin-top: 2px;
    }
    
    .group-section {
      margin-bottom: 8px;
    }
    
    .group-header {
      padding: 12px 15px;
      font-size: 14px;
      font-weight: 500;
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    
    .group-header:hover {
      background: #f0f0f0;
    }
    
    
    
    .group-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .group-content.collapsed {
      max-height: 0;
    }
    
    .group-content.expanded {
      max-height: 2400px;
      overflow: visible;
      padding-top: 8px;
      scrollbar-width: none;
    }

    .group-children {
      display: flex;
      flex-direction: column;
      margin-top: 4px;
    }
    
    .group-count {
      background: #9ea2a6;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    .prompt-list {
      padding: 0 15px 15px;
    }
    
    .prompt-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      background: #f5f5f5;
      border: 1px solid transparent;
      transition: all 0.2s;
      margin-right: 10px;
      overflow: hidden;
    }
    
    .prompt-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100%;
      min-width: 0;
      padding-right: 10px; /* 为 prompt-meta 预留空间 */
    }
    
    .prompt-name {
      font-weight: 500;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .prompt-meta {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .prompt-item:hover {
      background: #eeeeee;
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,102,255,0.1);
    }
    
    .prompt-item.active {
      background: rgba(0,102,255,0.05);
      border-color: var(--primary);
    }

    .prompt-desc {
      font-size: 12px;
      color: var(--gray);
      line-height: 1.3;
      height: 16px;
      overflow: hidden;
      position: relative;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }

    .prompt-meta-hint {
      font-size: 11px;
      color: var(--gray);
      margin-top: 4px;
      text-transform: none;
    }

    
    
    /* Tooltip样式 */
    .tooltip {
      position: relative;
    }
    
    .tooltip::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-width: 300px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: none;
    }
    
    .tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }
    
    /* 启用状态边框样式 */
    .prompt-item.enabled {
      border-left: 4px solid #b8b3b3; /* 浅30%的深灰色，原#333调浅30%约为#666 */
    }
    
    /* 选中状态样式 */
    .prompt-item.active {
      border-left: 4px solid #666; /* 选中时的灰色边框 */
    }
    
    /* 悬停状态样式 */
    .prompt-item:hover {
      border-color: #666; /* 鼠标悬停时的灰色边框 */
    }
    
    /* 操作按钮样式 */
    .prompt-actions {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 100px;
      opacity: 0;
      visibility: hidden;
      padding: 12px 16px;
      transform: translateX(100%);
      transition: all 0.25s ease;
      background: linear-gradient(to left,
        rgba(238, 238, 238, 0.95) 0%,
        rgba(238, 238, 238, 0.9) 30%,
        rgba(238, 238, 238, 0.6) 60%,
        rgba(238, 238, 238, 0) 100%);
      z-index: 1;
    }
    
    .prompt-item {
      padding-right: 24px; /* 为操作按钮预留空间 */
    }
    
    .prompt-item:hover .prompt-actions {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }
    
    .action-btn {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px;
      margin: -3px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      text-align: center;
      transition: all 0.2s ease;
      backdrop-filter: blur(2px);
      width: 100%;
    }
    
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: translateX(-2px);
      box-shadow: 0 1px 23px rgba(0,0,0,0.1);
    }
    
    /* 美化目录三角图标 */
    .group-toggle {
      position: relative;
      width: 20px;
      height: 20px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .group-toggle::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }
    
    .group-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .group-header:hover .group-toggle::before {
      opacity: 1;
    }
    
    .prompt-meta {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .prompt-tag {
      background: rgba(0,102,255,0.1);
      color: var(--primary);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .prompt-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .prompt-status.enabled {
      background: var(--success);
    }
    
    .prompt-status.disabled {
      background: var(--gray-light);
    }
    
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-left: 1px solid var(--border);
    }
    
    .editor-header {
      padding: 15px 20px;
      /* border-bottom: 1px solid var(--border); */
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: white;
    }
    
    .editor-header-top {
      display: flex;
      gap: 16px;
      align-items: center;
      width: 100%;
    }
    
    .editor-header-top input,
    .prompt-description {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    
    .editor-header-top input {
      flex: 1;
      min-width: 0;
    }
    
    .editor-header-top input:focus,
    .prompt-description:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .group-selector {
      position: relative;
      flex-shrink: 0;
    }
    
    .group-selector-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      font-size: 14px;
      color: var(--dark);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .group-selector-btn:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transform: translateY(-1px);
    }
    
    .group-selector-label {
      color: var(--gray);
      font-size: 12px;
      letter-spacing: 0;
    }
    
    .group-selector-value {
      font-weight: 500;
      color: var(--primary);
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .group-selector-icon {
      margin-left: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray);
    }
    
    .group-selector-input {
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
    }
    
    .prompt-description {
      width: 100%;
      min-height: 38px;
      line-height: 1.5;
      resize: none;
      overflow-y: hidden;
      transition: border-color 0.2s ease;
    }
    
    .prompt-description::-webkit-scrollbar {
      width: 6px;
    }
    
    .prompt-description::-webkit-scrollbar-thumb {
      background: var(--gray-light);
      border-radius: 3px;
    }
    
    .editor-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-left: auto;
    }
    
    .mode-toggle {
      display: inline-flex;
      align-items: center;
      padding: 4px;
      border-radius: 999px;
      background: var(--light);
      border: 1px solid var(--border);
    }
    
    .mode-btn {
      padding: 6px 18px;
      border: none;
      background: transparent;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      color: var(--gray);
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    
    .editor-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 16px;
      margin: 12px 20px 20px;
      overflow-y: auto;
      scrollbar-width: none;
    }

    .arguments-section {
      padding: 18px 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .arguments-section.has-error {
      border-color: rgba(220,53,69,0.4);
      box-shadow: 0 0 0 2px rgba(220,53,69,0.08), 0 8px 24px rgba(220,53,69,0.08);
    }

    .arguments-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .arguments-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .arguments-title span {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }

    .arguments-title small {
      font-size: 12px;
      color: var(--gray);
    }

    .arguments-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .arguments-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
    }

    .arguments-empty {
      grid-column: 1 / -1;
      font-size: 13px;
      color: var(--gray);
      background: var(--light);
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .argument-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(248,249,250,0.9), rgba(255,255,255,0.9));
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      /* min-height: 150px; */
      position: relative;
      overflow: hidden;
    }

    .argument-card.argument-card-unused {
      border-color: rgba(220,53,69,0.45);
      box-shadow: 0 0 0 1px rgba(220,53,69,0.18);
      background: rgba(220,53,69,0.04);
    }

    .argument-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .argument-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary);
      word-break: break-all;
    }

    .argument-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .argument-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(0,0,0,0.04);
      color: var(--gray);
    }

    .argument-required {
      background: rgba(220,53,69,0.12);
      color: var(--danger);
      font-weight: 600;
    }

    .argument-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: var(--gray);
      font-size: 12px;
      /* margin-bottom: 24px; */
    }

    .argument-body .argument-description {
      color: var(--dark);
      font-size: 13px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .argument-body .argument-placeholder {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(0,0,0,0.04);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--primary);
      display: inline-block;
    }

    .argument-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s ease;
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px;
      background: linear-gradient(to top, 
        rgba(255, 255, 255, 0.95) 0%,
        rgba(255, 255, 255, 0.9) 50%,
        rgba(255, 255, 255, 0) 100%);
      transform: translateY(100%);
    }

    .argument-card:hover .argument-actions {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .argument-action-btn {
      border: none;
      background: rgba(0,0,0,0.06);
      color: var(--primary);
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .argument-action-btn:hover {
      background: rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    .argument-action-btn.delete {
      color: var(--danger);
      background: rgba(220,53,69,0.12);
    }

    .argument-action-btn.delete:hover {
      background: rgba(220,53,69,0.18);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(17, 17, 17, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(4px);
    }

    .modal.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .modal.hidden .modal-content {
      transform: scale(0.95) translateY(10px);
    }

    .modal-dialog {
      width: min(420px, 90vw);
      margin: auto;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
      overflow: hidden;
      transform: scale(1) translateY(0);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(0,0,0,0.08);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to bottom, rgba(255,255,255,1), rgba(255,255,255,0.95));
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 580;
      color: var(--dark);
      letter-spacing: -0.01em;
      margin: 0;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 8px;
      color: var(--gray);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      padding: 0;
    }

    .modal-close:hover {
      background: rgba(0,0,0,0.04);
      color: var(--dark);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: rgba(248,249,250,0.65);
    }

    .group-modal-body {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-height: min(60vh, 460px);
    }

    .group-modal-search input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .group-modal-search input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(57, 57, 57, 0.08);
    }

    .group-modal-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .group-modal-option {
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }

    .group-modal-option:hover {
      border-color: var(--primary);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }

    .group-modal-option.active {
      border-color: var(--primary);
      background: rgba(57,57,57,0.06);
      box-shadow: inset 0 0 0 1px var(--primary);
    }

    .group-modal-name {
      font-size: 14px;
      font-weight: 560;
      color: var(--dark);
      letter-spacing: -0.01em;
    }

    .group-modal-path {
      font-size: 12px;
      color: var(--gray);
      letter-spacing: 0;
    }

    .group-modal-empty {
      padding: 20px;
      text-align: center;
      color: var(--gray);
      font-size: 14px;
      background: rgba(0,0,0,0.03);
      border-radius: 10px;
    }

    .group-modal-empty.hidden {
      display: none;
    }

    .group-modal-tree {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .group-modal-node {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .group-modal-node-row {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 6px 10px;
      border-radius: 10px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .group-modal-node-row:hover {
      background: rgba(0,0,0,0.04);
    }

    .group-modal-node-row.active {
      background: rgba(57,57,57,0.08);
    }

    .group-modal-node-row:hover .group-modal-name,
    .group-modal-node-row.active .group-modal-name {
      color: var(--primary);
    }

    .group-modal-toggle,
    .group-modal-toggle-placeholder {
      position: relative;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.15);
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--gray);
      padding: 0;
      flex-shrink: 0;
      transition: color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .group-modal-toggle::before {
      content: '';
      width: 10px;
      height: 2px;
      background: currentColor;
      border-radius: 1px;
      transition: transform 0.2s ease;
      transform-origin: center;
    }

    .group-modal-toggle::after {
      content: '';
      position: absolute;
      width: 2px;
      height: 10px;
      background: currentColor;
      border-radius: 1px;
      transition: opacity 0.2s ease, transform 0.2s ease;
      transform-origin: center;
    }

    .group-modal-toggle.expanded::after {
      opacity: 0;
      transform: scaleY(0);
    }

    .group-modal-toggle:hover {
      color: var(--primary);
      border-color: rgba(57,57,57,0.35);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .group-modal-toggle-placeholder {
      border: none;
      background: transparent;
      box-shadow: none;
      cursor: default;
      pointer-events: none;
      opacity: 0;
    }

    .group-modal-option {
      flex: 1;
    }

    .group-modal-children {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .group-modal-children.collapsed {
      display: none;
    }

    .group-modal-tree .group-modal-option {
      border: none;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
      padding: 0;
      margin: 0;
      gap: 2px;
      align-items: flex-start;
      justify-content: center;
      flex: 1;
      text-align: left;
      transition: color 0.2s ease;
    }

    .group-modal-tree .group-modal-option:hover {
      border: none;
      box-shadow: none;
      color: var(--primary);
    }

    .group-modal-tree .group-modal-option.active {
      color: var(--primary);
      font-weight: 560;
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray);
    }

    .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.2s ease;
      background: white;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(57,57,57,0.08);
    }

    .form-group input::placeholder {
      color: #adb5bd;
      opacity: 0.8;
    }

    .argument-modal {
      position: fixed;
      inset: 0;
      background: rgba(17, 17, 17, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 24px;
      transition: opacity 0.2s ease;
    }

    .argument-modal.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .argument-modal-dialog {
      width: min(520px, 100%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .argument-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
    }

    .argument-modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }

    .argument-modal-close {
      border: none;
      background: transparent;
      font-size: 24px;
      line-height: 1;
      color: var(--gray);
      cursor: pointer;
      padding: 4px;
    }

    .argument-modal-close:hover {
      color: var(--dark);
    }

    .argument-modal-body {
      padding: 20px 24px 8px;
    }

    .argument-form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px 18px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-field.full-width {
      grid-column: 1 / -1;
    }

    .form-field-inline {
      align-self: end;
      height: 100%;
      display: flex;
      align-items: flex-end;
      padding-top: 26px;
    }

    .argument-modal label {
      font-size: 13px;
      color: var(--gray);
      font-weight: 500;
    }

    .argument-modal .required {
      color: var(--danger);
      font-weight: 600;
      font-size: 12px;
    }

    .argument-modal input[type="text"],
    .argument-modal textarea {
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 14px;
      background: white;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .argument-modal input[type="text"]:focus,
    .argument-modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(57,57,57,0.08);
    }

    .argument-modal textarea {
      resize: vertical;
      min-height: 96px;
    }

    .checkbox-field {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--dark);
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .checkbox-field input {
      accent-color: var(--primary);
    }

    .argument-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px 20px;
      border-top: 1px solid var(--border);
      background: rgba(248,249,250,0.65);
    }

    body.modal-open {
      overflow: hidden;
    }

    .editor-body {
      position: relative;
      flex: 1;
      box-sizing: border-box;
      min-height: 0;
    }
    
    .workspace-pane {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      background: white;
      transition: opacity 0.25s ease;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
      min-height: 400px;
      scrollbar-width: none;
    }
    
    .workspace-pane.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    
    .pane-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: white;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray);
    }
    
    .pane-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0;
      min-height: 0;
    }
    
    .pane-content.preview {
      background: var(--preview-bg);
      padding: 24px;
    }

    .CodeMirror {
      flex: 1;
      height: 100%;
      font-size: 14px;
      line-height: 1.5;
      padding-left: 8px;
    }
    
    .CodeMirror-gutters {
      display: none;
    }
    
    .CodeMirror-scroll {
      min-height: 100%;
    }
    
    .preview-content {
      flex: 1;
      padding: 24px;
      overflow: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      scrollbar-width: thin;
      scrollbar-color: var(--gray-light) transparent;
    }
    
    /* 预览模式下的 CodeMirror 样式调整 */
    .preview-content .CodeMirror {
      height: auto;
      background: transparent;
      border: none;
      padding: 0;
      font-size: 14px;
    }

    .preview-content .CodeMirror-scroll {
      overflow: hidden !important;
    }

    .preview-content .CodeMirror-sizer {
      border-right: none !important;
    }

    .preview-content .CodeMirror-gutters {
      display: none;
    }
    
    .preview-content .CodeMirror-cursor {
      display: none !important;
    }

    @media (max-width: 1100px) {
      .arguments-list {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }
    
    .empty-state h3 {
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .empty-state p {
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.92), 
        rgba(248,249,250,0.95),
        rgba(255,255,255,0.98)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(12px);
    }
    
    .login-box {
      width: 400px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
      padding: 48px 40px;
      text-align: center;
      border: 1px solid rgba(0,0,0,0.06);
      position: relative;
      animation: login-box-show 0.5s cubic-bezier(0.21, 1.02, 0.73, 1) forwards;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, 
        rgba(255, 255, 255, 0.98) 0%,
        rgba(255, 255, 255, 0.96) 100%
      );
    }

    @keyframes login-box-show {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .login-box h2 {
      font-size: 28px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 36px;
      position: relative;
      display: inline-block;
    }
    
    .login-box h2::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 45px;
      height: 4px;
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      border-radius: 4px;
      opacity: 0.8;
    }
    
    .login-box .input-group {
      position: relative;
      margin-bottom: 24px;
      width: 100%;
    }

    .login-box .input-group::before {
      content: '';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      opacity: 0.5;
      transition: opacity 0.2s ease;
      background-size: contain;
      background-repeat: no-repeat;
    }

    .login-box .input-group.username::before {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E");
    }

    .login-box .input-group.password::before {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'/%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'/%3E%3C/svg%3E");
    }

    .login-box .input-group:focus-within::before {
      opacity: 1;
    }
    
    .login-box input {
      width: 100%;
      padding: 14px 15px 14px 48px;
      border: 1.5px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      font-weight: 450;
      letter-spacing: -0.01em;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    
    .login-box input:focus {
      outline: none;
      border-color: var(--primary);
      border-width: 1.5px;
      box-shadow: 0 0 0 3px rgba(57,57,57,0.08), 0 2px 8px rgba(0,0,0,0.04);
      background: white;
    }

    .login-box input::placeholder {
      color: #adb5bd;
      font-size: 15px;
      font-weight: 450;
      letter-spacing: -0.01em;
      opacity: 0.85;
    }
    
    .login-box button {
      width: 100%;
      padding: 16px;
      margin-top: 32px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 520;
      background: var(--primary);
      color: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.02em;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .login-box button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
      transform: translateX(-100%);
      transition: transform 0.8s ease;
    }

    .login-box button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }

    .login-box button:active {
      transform: translateY(0);
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      background: var(--primary);
    }

    .login-box button:hover::before {
      transform: translateX(100%);
    }
    
    .error-msg {
      color: var(--danger);
      font-size: 13px;
      margin-top: 12px;
      text-align: center;
      opacity: 0;
      transform: translateY(-10px);
      animation: error-show 0.3s ease forwards;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .error-msg::before {
      content: '';
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23dc3545' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' y1='8' x2='12' y2='12'/%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
    }

    @keyframes error-show {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .success-msg {
      color: var(--success);
      font-size: 13px;
      margin-top: 12px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .success-msg::before {
      content: '';
      width: 16px;
      height: 16px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2328a745' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 11.08V12a10 10 0 1 1-5.93-9.14'/%3E%3Cpolyline points='22 4 12 14.01 9 11.01'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-badge.enabled {
      background: rgba(40,167,69,0.1);
      color: var(--success);
    }
    
    .status-badge.disabled {
      background: rgba(220,53,69,0.1);
      color: var(--danger);
    }
  </style>
</head>
<body>
  <!-- 登录界面 -->
  <div id="login" class="login-container">
    <div class="login-box">
      <h2>Prompt Manager</h2>
      <div class="input-group username">
        <input type="text" id="username" placeholder="用户名" />
      </div>
      <div class="input-group password">
        <input type="password" id="password" placeholder="密码" />
      </div>
      <button id="loginBtn" class="btn btn-primary">登录</button>
    </div>
  </div>

  <!-- 主界面 -->
  <!-- 新建目录弹窗 -->
  <div id="newFolderModal" class="modal hidden">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3>新建目录</h3>
          <button type="button" class="modal-close" onclick="toggleNewFolderModal()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>目录名称</label>
            <input type="text" id="newFolderName" placeholder="请输入目录名称" onkeydown="handleNewFolderKeydown(event)">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" onclick="toggleNewFolderModal()">取消</button>
          <button type="button" class="btn btn-dark" onclick="createNewFolder()">创建</button>
        </div>
      </div>
    </div>
  </div>

  <div id="main" style="display: none; height: 100vh; flex-direction: column;">
    <!-- 顶部导航 -->
    <header>
      <div class="logo">
        Prompt Manager <span>Beta</span>
      </div>
      <div class="nav-right">
        <div class="user-profile">
          <button class="avatar-btn" id="avatarBtn" aria-haspopup="true" aria-expanded="false">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="用户头像" class="avatar-img">
          </button>
          <div class="dropdown-menu" id="userMenu">
            <div class="dropdown-header">
              <div class="user-info">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="用户头像" class="user-avatar">
                <div class="user-details">
                  <div class="user-name">管理员</div>
                  <div class="user-role">Admin</div>
                </div>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <button id="logoutBtn" class="dropdown-item">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dropdown-icon"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
              退出登录
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- 主体内容 -->
    <main>
      <!-- 左侧边栏 -->
      <aside>
        <div class="sidebar-header">
          <button id="newPromptBtn" class="new-prompt-btn">
            新建 Prompt
          </button>
          <div class="search-container">
            <div class="search-box">
              <input type="text" id="searchInput" placeholder="搜索提示词..." />
              <button type="button" class="clear-btn" title="清除搜索"></button>
            </div>
            <button id="newGroupBtn" class="folder-btn" title="新建目录">
            </button>
          </div>
        </div>
        
        <div id="groupList"></div>
      </aside>

      <!-- 右侧编辑器 -->
      <div class="editor-container">
        <div class="editor-header">
          <div class="editor-header-top">
            <input type="text" id="promptName" placeholder="Prompt 名称" />
            <div class="group-selector">
              <button type="button" id="promptGroupBtn" class="group-selector-btn" aria-haspopup="dialog" aria-expanded="false">
                <span class="group-selector-label">关联类目</span>
                <span class="group-selector-value" id="promptGroupLabel">default</span>
                <span class="group-selector-icon" aria-hidden="true">
                  <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
                    <path d="M5 8L10 13L15 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
              </button>
              <select id="promptGroup" class="group-selector-input" aria-hidden="true" tabindex="-1">
                <option value="default">default</option>
                <option value="developer">developer</option>
                <option value="generator">generator</option>
                <option value="operation">operation</option>
              </select>
            </div>
            <div class="editor-controls">
              <div class="mode-toggle">
                <button id="editModeBtn" class="mode-btn active" data-mode="edit">编辑</button>
                <button id="previewModeBtn" class="mode-btn" data-mode="preview">预览</button>
              </div>
              <button id="saveBtn" class="btn btn-primary btn-sm">
                保存
              </button>
            </div>
          </div>
          <textarea id="promptDescription" class="prompt-description" placeholder="Prompt 描述"></textarea>
        </div>

        <div class="editor-content">
          <section class="arguments-section" id="argumentsSection">
            <div class="arguments-header">
              <div class="arguments-title">
                <span>参数配置</span>
              </div>
              <div class="arguments-actions">
                <button id="addArgumentBtn" class="btn btn-outline btn-sm" type="button">
                  新增
                </button>
              </div>
            </div>
            <div class="arguments-list" id="argumentsList">
              <div class="arguments-empty">暂无参数，点击“新增”开始配置</div>
            </div>
          </section>
          <div class="editor-body" id="editorWorkspace">
            <div class="workspace-pane" id="editorPane">
              <div class="pane-header">编辑器</div>
              <div class="pane-content">
                <textarea id="editor"></textarea>
              </div>
            </div>
            <div class="workspace-pane hidden" id="previewPane">
              <div class="pane-header">实时预览</div>
              <div class="pane-content preview">
                <div class="preview-content" id="previewContent">
                  <p>选择或创建prompt开始编辑</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 消息提示 -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- 删除 Prompt 弹窗 -->
  <div id="deletePromptModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="deletePromptTitle">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="deletePromptTitle">删除 Prompt</h3>
          <button type="button" class="modal-close" id="deletePromptCloseBtn" aria-label="关闭">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <p style="font-size: 14px; color: var(--gray); line-height: 1.6;">
            确认删除 <span id="deletePromptName" style="color: var(--dark); font-weight: 600;"></span> 吗？该操作不可撤销。
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" id="deletePromptCancelBtn">取消</button>
          <button type="button" class="btn btn-danger" id="deletePromptConfirmBtn">删除</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 类目选择弹窗 -->
  <div id="promptGroupModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="promptGroupModalTitle">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="promptGroupModalTitle">选择关联类目</h3>
          <button type="button" class="modal-close" id="promptGroupModalClose" aria-label="关闭">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="group-modal-body">
            <div class="group-modal-search">
              <input type="text" id="promptGroupSearch" placeholder="搜索类目..." />
            </div>
            <div class="group-modal-list" id="promptGroupList"></div>
            <div class="group-modal-empty hidden" id="promptGroupEmpty">没有匹配的类目</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 参数编辑弹窗 -->
  <div id="argumentModal" class="argument-modal hidden" role="dialog" aria-modal="true" aria-labelledby="argumentModalTitle">
    <div class="argument-modal-dialog">
      <div class="argument-modal-header">
        <h3 id="argumentModalTitle">新增参数</h3>
        <button type="button" id="argumentModalClose" class="argument-modal-close" aria-label="关闭">×</button>
      </div>
      <form id="argumentForm" class="argument-modal-form">
        <div class="argument-modal-body">
          <div class="argument-form-grid">
            <div class="form-field">
              <label for="argumentNameInput">参数名称 <span class="required">*</span></label>
              <input type="text" id="argumentNameInput" placeholder="例如：language" />
            </div>
            <div class="form-field">
              <label for="argumentTypeInput">类型</label>
              <input type="text" id="argumentTypeInput" list="argumentTypeOptions" placeholder="例如：string" />
            </div>
            <div class="form-field">
              <label for="argumentDefaultInput">默认值</label>
              <input type="text" id="argumentDefaultInput" placeholder="可选" />
            </div>
            <div class="form-field form-field-inline">
              <label class="checkbox-field">
                <input type="checkbox" id="argumentRequiredInput" />
                <span>必填</span>
              </label>
            </div>
            <div class="form-field full-width">
              <label for="argumentDescriptionInput">参数说明</label>
              <textarea id="argumentDescriptionInput" rows="3" placeholder="用于提示词中的描述"></textarea>
            </div>
          </div>
        </div>
        <div class="argument-modal-footer">
          <button type="button" class="btn btn-outline" id="argumentCancelBtn">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <datalist id="argumentTypeOptions">
    <option value="string">字符串</option>
    <option value="number">数字</option>
    <option value="boolean">布尔值</option>
  </datalist>

  <script>
    // 应用状态
    let currentToken = localStorage.getItem('prompt-admin-token')
    let currentPrompt = null
    let currentPromptObject = null
    let descriptionInputEl = null
    let allPrompts = []
    let expandedGroups = new Set()
    let editor = null
    let argumentsState = []
    let unusedArgumentNames = new Set()
    let editingArgumentIndex = null
    let argumentModalEl = null
    let argumentFormEl = null
    let argumentModalTitleEl = null
    let argumentNameInput = null
    let argumentTypeInput = null
    let argumentRequiredInput = null
    let argumentDefaultInput = null
    let argumentDescriptionInput = null
    let deletePromptModalEl = null
    let deletePromptNameEl = null
    let deletePromptConfirmBtn = null
    let deletePromptCancelBtn = null
    let deletePromptCloseBtn = null
    let pendingDeletePromptName = null
    let pendingDeletePromptPath = null
    let promptGroupModalEl = null
    let promptGroupBtnEl = null
    let promptGroupLabelEl = null
    let promptGroupSearchInput = null
    let promptGroupListEl = null
    let promptGroupEmptyEl = null
    let promptGroupModalCloseBtn = null
    let groupTreeState = []
    let expandedModalGroups = new Set()

    function refreshModalOpenState() {
      const hasOpenModal =
        (argumentModalEl && !argumentModalEl.classList.contains('hidden')) ||
        (deletePromptModalEl && !deletePromptModalEl.classList.contains('hidden')) ||
        (promptGroupModalEl && !promptGroupModalEl.classList.contains('hidden'))
      if (hasOpenModal) {
        document.body.classList.add('modal-open')
      } else {
        document.body.classList.remove('modal-open')
      }
    }

    // API 基础配置
    const API_BASE = '/api'

    // 动态加载CodeMirror资源
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = src
        script.onload = resolve
        script.onerror = () => reject(new Error(`加载失败: ${src}`))
        document.head.appendChild(script)
      })
    }

    // API请求封装
    async function apiCall(endpoint, options = {}) {
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      }

      if (currentToken) {
        config.headers.Authorization = `Bearer ${currentToken}`
      }

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, config)
        
        if (response.status === 401) {
          // Token 过期，重新登录
          localStorage.removeItem('prompt-admin-token')
          currentToken = null
          showLogin()
          throw new Error('登录已过期，请重新登录')
        }

        if (!response.ok) {
          const error = await response.text()
          throw new Error(error || '请求失败')
        }

        return await response.json()
      } catch (error) {
        const handledError = error instanceof Error ? error : new Error(error?.message || '请求失败')
        handledError.__shown = true
        console.error('API请求错误:', handledError)
        showMessage(handledError.message, 'error')
        throw handledError
      }
    }

    // 提示组件
    function showMessage(message, type = 'success', options = {}) {
      const container = document.getElementById('toastContainer')
      if (!container) return

      const normalizedType = ['success', 'error', 'info', 'warning'].includes(type) ? type : 'success'
      const titleMap = {
        success: '操作成功',
        error: '操作失败',
        info: '提示信息',
        warning: '注意'
      }
      const iconMap = {
        success: '✓',
        error: '✕',
        info: 'ℹ',
        warning: '!' 
      }

      const toast = document.createElement('div')
      toast.className = `toast toast-${normalizedType}`
      toast.setAttribute('role', normalizedType === 'error' ? 'alert' : 'status')
      toast.setAttribute('aria-live', normalizedType === 'error' ? 'assertive' : 'polite')

      const iconEl = document.createElement('span')
      iconEl.className = 'toast-icon'
      iconEl.textContent = options.icon || iconMap[normalizedType]

      const contentEl = document.createElement('div')
      contentEl.className = 'toast-content'

      const titleText = options.title || titleMap[normalizedType]
      if (titleText) {
        const titleEl = document.createElement('div')
        titleEl.className = 'toast-title'
        titleEl.textContent = titleText
        contentEl.appendChild(titleEl)
      }

      const messageEl = document.createElement('div')
      messageEl.className = 'toast-message'
      messageEl.textContent = message
      contentEl.appendChild(messageEl)

      const closeBtn = document.createElement('button')
      closeBtn.className = 'toast-close'
      closeBtn.type = 'button'
      closeBtn.setAttribute('aria-label', '关闭提示')
      closeBtn.innerHTML = '&times;'

      toast.appendChild(iconEl)
      toast.appendChild(contentEl)
      toast.appendChild(closeBtn)
      container.appendChild(toast)

      let hideTimer
      let removed = false

      const removeToast = () => {
        if (removed) return
        removed = true
        toast.classList.add('toast-leave')
        toast.removeEventListener('mouseenter', pauseTimer)
        toast.removeEventListener('mouseleave', resumeTimer)
        setTimeout(() => {
          if (toast.parentNode === container) {
            container.removeChild(toast)
          }
        }, 250)
      }

      const pauseTimer = () => clearTimeout(hideTimer)
      const resumeTimer = () => {
        clearTimeout(hideTimer)
        hideTimer = setTimeout(removeToast, Number(options.duration) || 5000)
      }

      closeBtn.addEventListener('click', () => {
        pauseTimer()
        removeToast()
      })

      toast.addEventListener('mouseenter', pauseTimer)
      toast.addEventListener('mouseleave', resumeTimer)

      resumeTimer()
    }

    // 登录功能
    async function login(username, password) {
      try {
        const result = await apiCall('/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        })
        
        currentToken = result.token
        localStorage.setItem('prompt-admin-token', currentToken)
        showMain()
        loadPrompts()
      } catch (error) {
        document.getElementById('loginError').textContent = error.message || '登录失败'
      }
    }

    // 处理登录页面的回车事件和按钮点击
    function setupLoginEvents() {
      const loginForm = document.getElementById('login')
      const usernameInput = document.getElementById('username')
      const passwordInput = document.getElementById('password')
      const loginBtn = document.getElementById('loginBtn')

      // 自动聚焦到用户名输入框
      usernameInput.focus()

      function handleLogin() {
        const username = usernameInput.value.trim()
        const password = passwordInput.value
        if (username && password) {
          login(username, password)
        }
      }

      // 监听整个页面的回车事件
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && loginForm.style.display !== 'none') {
          e.preventDefault()
          handleLogin()
        }
      })

      // 登录按钮点击事件
      loginBtn.addEventListener('click', (e) => {
        e.preventDefault()
        handleLogin()
      })

      // Tab 键切换焦点时的优化
      usernameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault()
          if (!usernameInput.value.trim()) {
            usernameInput.focus()
          } else {
            passwordInput.focus()
          }
        }
      })

      passwordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault()
          if (!passwordInput.value) {
            passwordInput.focus()
          } else {
            handleLogin()
          }
        }
      })
    }

    // 页面加载完成后初始化事件
    document.addEventListener('DOMContentLoaded', () => {
      setupLoginEvents()
    })

    function escapeHtml(input) {
      if (input === null || input === undefined) {
        return ''
      }
      return String(input).replace(/[&<>"']/g, (match) => {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }
        return map[match] || match
      })
    }

    function escapeRegExp(input) {
      return String(input).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
    }

    // 退出登录
    function logout() {
      localStorage.removeItem('prompt-admin-token')
      currentToken = null
      showLogin()
    }

    // 显示登录界面
    function showLogin() {
      document.getElementById('login').style.display = 'flex'
      document.getElementById('main').style.display = 'none'
    }

    // 显示主界面
    function showMain() {
      document.getElementById('login').style.display = 'none'
      document.getElementById('main').style.display = 'block'
    }

    // 加载prompt列表
    async function loadPrompts(search = '', enabledOnly = false, group = null) {
      try {
        const queryParams = new URLSearchParams()
        if (search) queryParams.append('search', search)
        if (enabledOnly) queryParams.append('enabled', 'true')
        if (group) queryParams.append('group', group)
        
        const prompts = await apiCall(`/prompts?${queryParams}`)
        allPrompts = prompts
        await renderGroupList(prompts)
      } catch (error) {
        console.error('加载prompt列表失败:', error)
      }
    }

    function createDefaultPromptObject() {
      return {
        name: 'new-prompt',
        description: '新prompt描述',
        enabled: true,
        messages: [
          {
            role: 'user',
            content: {
              text: `这是一个新的prompt模板\n{{variable1}}`
            }
          }
        ],
        arguments: [
          {
            name: 'variable1',
            type: 'string',
            required: false,
            default: '',
            description: '示例变量'
          }
        ],
        variables: [
          {
            name: 'variable1',
            type: 'string',
            required: false,
            default: '',
            description: '示例变量'
          }
        ]
      }
    }

    // 用户头像下拉菜单控制
    const avatarBtn = document.getElementById('avatarBtn')
    const userMenu = document.getElementById('userMenu')
    
    // 点击头像显示/隐藏下拉菜单
    avatarBtn.addEventListener('click', (e) => {
      e.stopPropagation()
      userMenu.classList.toggle('show')
      avatarBtn.setAttribute('aria-expanded', userMenu.classList.contains('show'))
    })
    
    // 点击页面其他地方关闭下拉菜单
    document.addEventListener('click', (e) => {
      if (!userMenu.contains(e.target) && !avatarBtn.contains(e.target)) {
        userMenu.classList.remove('show')
        avatarBtn.setAttribute('aria-expanded', 'false')
      }
    })
    
    // ESC 键关闭下拉菜单
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && userMenu.classList.contains('show')) {
        userMenu.classList.remove('show')
        avatarBtn.setAttribute('aria-expanded', 'false')
      }
    })

    function clonePromptObject(obj) {
      return obj ? JSON.parse(JSON.stringify(obj)) : null
    }

    function getFirstUserMessage(promptObj) {
      if (!promptObj || !Array.isArray(promptObj.messages)) return null
      return promptObj.messages.find(message => message?.role === 'user') || null
    }

    function buildPromptObjectFromUI() {
      const nameInput = document.getElementById('promptName')
      const name = (nameInput?.value || '').trim() || 'new-prompt'
      const description = descriptionInputEl?.value || ''
      const markdown = editor ? editor.getValue() : ''

      const base = clonePromptObject(currentPromptObject) || createDefaultPromptObject()
      base.name = name
      base.description = description

      if (!Array.isArray(base.messages)) {
        base.messages = []
      }

      let userMessage = getFirstUserMessage(base)
      if (!userMessage) {
        userMessage = { role: 'user', content: { text: '' } }
        base.messages.push(userMessage)
      }

      if (!userMessage.content || typeof userMessage.content !== 'object') {
        userMessage.content = {}
      }

      userMessage.content.text = markdown

      const sanitizedArguments = Array.isArray(argumentsState)
        ? argumentsState
            .map(arg => {
              const nameValue = (arg.name || '').trim()
              if (!nameValue) return null
              const typeValue = (arg.type || '').trim()
              const descriptionValue = (arg.description || '').trim()
              const defaultValue = arg.default
              const argumentResult = {
                name: nameValue,
                type: typeValue || 'string',
                required: Boolean(arg.required)
              }
              if (descriptionValue) {
                argumentResult.description = descriptionValue
              }
              if (defaultValue !== undefined && defaultValue !== null) {
                const defaultText = String(defaultValue).trim()
                if (defaultText) {
                  argumentResult.default = defaultText
                }
              }
              return argumentResult
            })
            .filter(Boolean)
        : []

      base.arguments = sanitizedArguments

      return base
    }

    function adjustDescriptionHeight() {
      if (!descriptionInputEl) return

      const style = window.getComputedStyle(descriptionInputEl)
      const lineHeight = parseFloat(style.lineHeight) || 20
      const padding = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom) || 0
      const border = parseFloat(style.borderTopWidth) + parseFloat(style.borderBottomWidth) || 0
      const maxHeight = lineHeight * 4 + padding + border
      const baseHeight = lineHeight + padding + border

      descriptionInputEl.style.height = 'auto'
      const contentHeight = descriptionInputEl.scrollHeight
      const newHeight = Math.max(baseHeight, Math.min(maxHeight, contentHeight))
      descriptionInputEl.style.height = `${newHeight}px`
      descriptionInputEl.style.overflowY = descriptionInputEl.scrollHeight > maxHeight ? 'auto' : 'hidden'
    }

    function normalizeArgument(argument = {}) {
      return {
        name: argument?.name ? String(argument.name) : '',
        description: argument?.description ? String(argument.description) : '',
        type: argument?.type ? String(argument.type) : 'string',
        required: Boolean(argument?.required),
        default: argument?.default ?? ''
      }
    }

    function setArgumentsState(list = []) {
      argumentsState = Array.isArray(list) ? list.map(item => normalizeArgument(item)) : []
      unusedArgumentNames = new Set()
      const section = document.getElementById('argumentsSection')
      if (section) {
        section.classList.remove('has-error')
      }
      renderArgumentsEditor()
    }

    function removeArgument(index) {
      if (index < 0 || index >= argumentsState.length) return
      argumentsState.splice(index, 1)
      setUnusedArgumentHighlights([])
    }

    function renderArgumentsEditor() {
      const listEl = document.getElementById('argumentsList')
      if (!listEl) return

      listEl.innerHTML = ''

      if (!argumentsState.length) {
        listEl.innerHTML = '<div class="arguments-empty">暂无参数，点击“新增参数”开始配置</div>'
        return
      }

      const fragment = document.createDocumentFragment()

      argumentsState.forEach((rawArgument, index) => {
        const argument = normalizeArgument(rawArgument)
        const displayName = argument.name?.trim() || `参数 ${index + 1}`
        const normalizedName = argument.name?.trim() || ''
        const safeType = escapeHtml(argument.type || 'string')
        const safeDefault = argument.default ? escapeHtml(String(argument.default)) : ''
        const safeDescription = argument.description ? escapeHtml(argument.description) : ''

        const card = document.createElement('div')
        card.className = 'argument-card'
        card.dataset.index = index

        if (normalizedName && unusedArgumentNames.has(normalizedName)) {
          card.classList.add('argument-card-unused')
        }

        const badgeParts = [`<span class="argument-badge">类型：${safeType || 'string'}</span>`]
        if (argument.required) {
          badgeParts.push('<span class="argument-badge argument-required">必填</span>')
        }
        if (safeDefault) {
          badgeParts.push(`<span class="argument-badge">默认：${safeDefault}</span>`)
        }

        const placeholderSnippet = normalizedName
          ? `<div>变量占位：<span class="argument-placeholder">{{${escapeHtml(normalizedName)}}}</span></div>`
          : ''

        card.innerHTML = `
          <div class="argument-card-header">
            <div class="argument-name">${escapeHtml(displayName)}</div>
            <div class="argument-badges">${badgeParts.join('')}</div>
          </div>
          <div class="argument-body">
            ${safeDescription ? `<div class="argument-description">${safeDescription}</div>` : '<div class="argument-description" style="color: var(--gray);">暂无说明</div>'}
            ${placeholderSnippet}
          </div>
          <div class="argument-actions">
            <button type="button" class="argument-action-btn edit" data-action="edit" data-index="${index}">编辑</button>
            <button type="button" class="argument-action-btn delete" data-action="delete" data-index="${index}">删除</button>
          </div>
        `

        fragment.appendChild(card)
      })

      listEl.appendChild(fragment)
    }

    function setUnusedArgumentHighlights(names = []) {
      unusedArgumentNames = new Set(Array.isArray(names) ? names.map(name => String(name).trim()).filter(Boolean) : [])
      const section = document.getElementById('argumentsSection')
      if (section) {
        section.classList.toggle('has-error', unusedArgumentNames.size > 0)
      }
      renderArgumentsEditor()
    }

    function openDeletePromptModal(promptName, relativePath) {
      if (!deletePromptModalEl) return
      pendingDeletePromptName = promptName
      pendingDeletePromptPath = relativePath || null
      if (deletePromptNameEl) {
        deletePromptNameEl.textContent = relativePath ? `“${promptName}” (${relativePath})` : `“${promptName}”`
      }
      deletePromptModalEl.classList.remove('hidden')
      deletePromptModalEl.setAttribute('aria-hidden', 'false')
      refreshModalOpenState()
      if (deletePromptConfirmBtn) {
        requestAnimationFrame(() => deletePromptConfirmBtn.focus())
      }
    }

    function closeDeletePromptModal() {
      if (!deletePromptModalEl) return
      deletePromptModalEl.classList.add('hidden')
      deletePromptModalEl.setAttribute('aria-hidden', 'true')
      refreshModalOpenState()
      pendingDeletePromptName = null
      pendingDeletePromptPath = null
    }

    async function confirmDeletePrompt() {
      if (!pendingDeletePromptName) {
        closeDeletePromptModal()
        return
      }
      const promptToDelete = pendingDeletePromptName
      const pathToDelete = pendingDeletePromptPath
      closeDeletePromptModal()
      await deletePrompt(promptToDelete, pathToDelete)
    }

    function openArgumentModal(index = null) {
      if (!argumentModalEl) return
      editingArgumentIndex = Number.isInteger(index) && index >= 0 ? index : null
      const isEdit = editingArgumentIndex !== null && argumentsState[editingArgumentIndex]
      const payload = isEdit ? normalizeArgument(argumentsState[editingArgumentIndex]) : normalizeArgument({ type: 'string' })

      if (argumentModalTitleEl) {
        argumentModalTitleEl.textContent = isEdit ? '编辑参数' : '新增参数'
      }
      if (argumentNameInput) {
        argumentNameInput.value = payload.name || ''
      }
      if (argumentTypeInput) {
        argumentTypeInput.value = payload.type || 'string'
      }
      if (argumentRequiredInput) {
        argumentRequiredInput.checked = Boolean(payload.required)
      }
      if (argumentDefaultInput) {
        const modalDefaultValue = payload.default
        argumentDefaultInput.value = modalDefaultValue === undefined || modalDefaultValue === null ? '' : String(modalDefaultValue)
      }
      if (argumentDescriptionInput) {
        argumentDescriptionInput.value = payload.description || ''
      }

      argumentModalEl.classList.remove('hidden')
      argumentModalEl.setAttribute('aria-hidden', 'false')
      refreshModalOpenState()

      requestAnimationFrame(() => {
        if (argumentNameInput) {
          argumentNameInput.focus()
          argumentNameInput.select()
        }
      })
    }

    function closeArgumentModal() {
      if (!argumentModalEl) return
      argumentModalEl.classList.add('hidden')
      argumentModalEl.setAttribute('aria-hidden', 'true')
      refreshModalOpenState()
      editingArgumentIndex = null

      if (argumentFormEl) {
        argumentFormEl.reset()
      }
      if (argumentNameInput) {
        argumentNameInput.value = ''
      }
      if (argumentTypeInput) {
        argumentTypeInput.value = 'string'
      }
      if (argumentRequiredInput) {
        argumentRequiredInput.checked = false
      }
      if (argumentDefaultInput) {
        argumentDefaultInput.value = ''
      }
      if (argumentDescriptionInput) {
        argumentDescriptionInput.value = ''
      }
    }

    function handleArgumentFormSubmit(event) {
      event.preventDefault()
      if (!argumentNameInput || !argumentTypeInput) return

      const name = (argumentNameInput.value || '').trim()
      if (!name) {
        showMessage('请输入参数名称', 'error')
        argumentNameInput.focus()
        return
      }

      const type = (argumentTypeInput.value || 'string').trim() || 'string'
      const required = argumentRequiredInput ? argumentRequiredInput.checked : false
      const defaultValue = argumentDefaultInput ? argumentDefaultInput.value : ''
      const description = argumentDescriptionInput ? argumentDescriptionInput.value.trim() : ''

      const payload = normalizeArgument({
        name,
        type,
        required,
        default: defaultValue,
        description
      })

      if (editingArgumentIndex !== null && argumentsState[editingArgumentIndex]) {
        argumentsState[editingArgumentIndex] = payload
      } else {
        argumentsState.push(payload)
      }

      closeArgumentModal()
      setUnusedArgumentHighlights([])
    }

    function collectPromptTextContent(promptObject) {
      const segments = []
      if (!promptObject || !Array.isArray(promptObject.messages)) {
        return ''
      }
      promptObject.messages.forEach(message => {
        if (!message) return
        const content = message.content
        if (Array.isArray(content)) {
          content.forEach(item => {
            if (typeof item === 'string') {
              segments.push(item)
            } else if (item && typeof item === 'object') {
              Object.values(item).forEach(value => {
                if (typeof value === 'string') {
                  segments.push(value)
                }
              })
            }
          })
        } else if (typeof content === 'string') {
          segments.push(content)
        } else if (content && typeof content === 'object') {
          Object.values(content).forEach(value => {
            if (typeof value === 'string') {
              segments.push(value)
            }
          })
        }
      })
      return segments.join('\n')
    }

    function findUnusedArguments(promptObject) {
      const args = Array.isArray(promptObject?.arguments) ? promptObject.arguments : []
      if (!args.length) return []
      const combinedContent = collectPromptTextContent(promptObject)
      return args.filter(arg => {
        const name = arg?.name?.trim()
        if (!name) return false
        const pattern = new RegExp(`{{\\s*${escapeRegExp(name)}\\s*}}`)
        return !pattern.test(combinedContent)
      })
    }

    function handleArgumentListClick(event) {
      const target = event.target.closest('[data-action]')
      if (!target) return
      const action = target.dataset.action
      const index = Number(target.dataset.index)
      if (!Number.isInteger(index)) return
      if (action === 'delete') {
        const argumentName = argumentsState[index]?.name || `参数 ${index + 1}`
        const confirmed = window.confirm(`确定要删除参数 "${argumentName}" 吗？`)
        if (!confirmed) return
        removeArgument(index)
      } else if (action === 'edit') {
        openArgumentModal(index)
      }
    }

    function sanitizeGroupId(pathValue = 'default') {
      return pathValue.replace(/[^a-zA-Z0-9-_]/g, '__') || 'default'
    }

    function collectAncestorPaths(pathValue) {
      if (!pathValue) return []
      const segments = pathValue.split('/')
      const paths = []
      let current = ''
      segments.forEach(segment => {
        current = current ? `${current}/${segment}` : segment
        paths.push(current)
      })
      return paths
    }

    function flattenGroupTree(nodes, depth = 0, accumulator = []) {
      if (!Array.isArray(nodes)) return accumulator
      nodes.forEach(node => {
        const value = node?.path || 'default'
        const name = node?.name || value
        accumulator.push({
          value,
          name,
          depth,
          path: value
        })
        if (Array.isArray(node?.children) && node.children.length) {
          flattenGroupTree(node.children, depth + 1, accumulator)
        }
      })
      return accumulator
    }

    function syncExpandedModalGroups() {
      const valid = new Set(flattenGroupTree(groupTreeState || []).map(item => item.value))
      expandedModalGroups = new Set([...expandedModalGroups].filter(value => valid.has(value)))
    }

    function ensureModalAncestorsExpanded(pathValue) {
      if (!pathValue) return
      collectAncestorPaths(pathValue).forEach(value => {
        if (value) {
          expandedModalGroups.add(value)
        }
      })
    }

    function renderModalGroupTree(nodes, container, depth = 0) {
      if (!Array.isArray(nodes) || !container) return
      const selectEl = document.getElementById('promptGroup')
      const currentValue = selectEl?.value || 'default'

      nodes.forEach(node => {
        const pathValue = node?.path || 'default'
        const nameValue = node?.name || pathValue
        const hasChildren = Array.isArray(node?.children) && node.children.length > 0
        const isExpanded = expandedModalGroups.has(pathValue)

        const nodeEl = document.createElement('div')
        nodeEl.className = 'group-modal-node'

        const row = document.createElement('div')
        row.className = 'group-modal-node-row'
        row.style.paddingLeft = `${10 + depth * 18}px`

        let childrenContainer = null

        if (hasChildren) {
          const toggleBtn = document.createElement('button')
          toggleBtn.type = 'button'
          toggleBtn.className = `group-modal-toggle${isExpanded ? ' expanded' : ''}`
          toggleBtn.setAttribute('aria-label', isExpanded ? '折叠子类目' : '展开子类目')
          toggleBtn.setAttribute('aria-expanded', String(isExpanded))
          toggleBtn.addEventListener('click', () => {
            const nextExpanded = !expandedModalGroups.has(pathValue)
            if (nextExpanded) {
              expandedModalGroups.add(pathValue)
            } else {
              expandedModalGroups.delete(pathValue)
            }
            toggleBtn.classList.toggle('expanded', nextExpanded)
            toggleBtn.setAttribute('aria-expanded', String(nextExpanded))
            toggleBtn.setAttribute('aria-label', nextExpanded ? '折叠子类目' : '展开子类目')
            if (childrenContainer) {
              childrenContainer.classList.toggle('collapsed', !nextExpanded)
            }
          })
          row.appendChild(toggleBtn)
        } else {
          const placeholder = document.createElement('div')
          placeholder.className = 'group-modal-toggle-placeholder'
          row.appendChild(placeholder)
        }

        const optionBtn = document.createElement('button')
        optionBtn.type = 'button'
        const isActive = pathValue === currentValue
        optionBtn.className = `group-modal-option${isActive ? ' active' : ''}`
        optionBtn.dataset.value = pathValue
        const safeName = escapeHtml(nameValue)
        const safePath = escapeHtml(pathValue)
        optionBtn.innerHTML = `
          <span class="group-modal-name">${safeName}</span>
          <span class="group-modal-path">${safePath}</span>
        `
        if (isActive) {
          row.classList.add('active')
        }
        optionBtn.addEventListener('click', () => {
          if (selectEl) {
            selectEl.value = pathValue
            updatePromptGroupDisplay()
          }
          closePromptGroupModal()
        })

        row.appendChild(optionBtn)
        nodeEl.appendChild(row)

        if (hasChildren) {
          childrenContainer = document.createElement('div')
          childrenContainer.className = `group-modal-children${isExpanded ? '' : ' collapsed'}`
          renderModalGroupTree(node.children, childrenContainer, depth + 1)
          nodeEl.appendChild(childrenContainer)
        }

        container.appendChild(nodeEl)
      })
    }

    function updatePromptGroupDisplay() {
      const selectEl = document.getElementById('promptGroup')
      if (!selectEl || !promptGroupLabelEl || !promptGroupBtnEl) return
      const value = selectEl.value || 'default'
      const option = Array.from(selectEl.options || []).find(opt => opt.value === value)
      const displayText = option ? option.textContent.trim() : value
      promptGroupLabelEl.textContent = displayText || value || 'default'
      promptGroupBtnEl.dataset.value = value
    }

    function updateGroupSelectOptions(tree) {
      const selectEl = document.getElementById('promptGroup')
      if (!selectEl) return
      const previousValue = selectEl.value || 'default'
      const optionsData = flattenGroupTree(tree || [])
      selectEl.innerHTML = ''
      optionsData.forEach(optionData => {
        const optionEl = document.createElement('option')
        optionEl.value = optionData.value
        optionEl.textContent = optionData.path
        selectEl.appendChild(optionEl)
      })
      const hasPrevious = optionsData.some(optionData => optionData.value === previousValue)
      selectEl.value = hasPrevious ? previousValue : (optionsData[0]?.value || 'default')
      syncExpandedModalGroups()
      updatePromptGroupDisplay()
      if (promptGroupModalEl && !promptGroupModalEl.classList.contains('hidden')) {
        populatePromptGroupModal(promptGroupSearchInput?.value || '')
      }
    }

    function getFilteredGroupOptions(keyword = '') {
      const normalized = keyword.trim().toLowerCase()
      let options = flattenGroupTree(groupTreeState || [])
      if (!options.length) {
        const selectEl = document.getElementById('promptGroup')
        if (selectEl) {
          options = Array.from(selectEl.options || []).map(opt => {
            const optionValue = opt.value || 'default'
            const text = opt.textContent?.trim() || optionValue
            return {
              value: optionValue,
              name: text,
              depth: 0,
              path: optionValue
            }
          })
        }
      }
      if (!normalized) return options
      return options.filter(option => {
        const name = option.name ? option.name.toLowerCase() : ''
        const path = option.path ? option.path.toLowerCase() : ''
        return name.includes(normalized) || path.includes(normalized)
      })
    }

    function populatePromptGroupModal(keyword = '') {
      if (!promptGroupListEl || !promptGroupEmptyEl) return
      const selectEl = document.getElementById('promptGroup')
      const trimmedKeyword = (keyword || '').trim()
      const isSearching = trimmedKeyword.length > 0
      syncExpandedModalGroups()
      promptGroupListEl.innerHTML = ''

      if (!isSearching && Array.isArray(groupTreeState) && groupTreeState.length) {
        const currentValue = selectEl?.value || 'default'
        ensureModalAncestorsExpanded(currentValue)
        promptGroupEmptyEl.classList.add('hidden')
        const treeContainer = document.createElement('div')
        treeContainer.className = 'group-modal-tree'
        renderModalGroupTree(groupTreeState, treeContainer, 0)
        promptGroupListEl.appendChild(treeContainer)
        return
      }

      const options = getFilteredGroupOptions(trimmedKeyword)
      if (!options.length) {
        promptGroupEmptyEl.classList.remove('hidden')
        return
      }

      promptGroupEmptyEl.classList.add('hidden')
      const currentValue = selectEl?.value || 'default'
      const fragment = document.createDocumentFragment()
      options.forEach(option => {
        const button = document.createElement('button')
        button.type = 'button'
        button.className = `group-modal-option${option.value === currentValue ? ' active' : ''}`
        button.dataset.value = option.value
        const safeName = escapeHtml(option.name)
        const safePath = escapeHtml(option.path)
        button.innerHTML = `
          <span class="group-modal-name">${safeName}</span>
          <span class="group-modal-path">${safePath}</span>
        `
        if (Number.isFinite(option.depth) && option.depth > 0) {
          button.style.paddingLeft = `${12 + option.depth * 16}px`
        } else {
          button.style.paddingLeft = ''
        }
        button.addEventListener('click', () => {
          if (selectEl) {
            selectEl.value = option.value
            updatePromptGroupDisplay()
          }
          closePromptGroupModal()
        })
        fragment.appendChild(button)
      })
      promptGroupListEl.appendChild(fragment)
    }

    function openPromptGroupModal() {
      if (!promptGroupModalEl) return
      promptGroupModalEl.classList.remove('hidden')
      promptGroupModalEl.setAttribute('aria-hidden', 'false')
      promptGroupBtnEl?.setAttribute('aria-expanded', 'true')
      const selectEl = document.getElementById('promptGroup')
      const currentValue = selectEl?.value || 'default'
      if (!expandedModalGroups.size && Array.isArray(groupTreeState)) {
        groupTreeState.forEach(node => {
          if (node && node.path) {
            expandedModalGroups.add(node.path)
          }
        })
      }
      ensureModalAncestorsExpanded(currentValue)
      populatePromptGroupModal(promptGroupSearchInput?.value || '')
      refreshModalOpenState()
      requestAnimationFrame(() => {
        if (promptGroupSearchInput) {
          promptGroupSearchInput.focus()
          promptGroupSearchInput.select()
        }
      })
    }

    function closePromptGroupModal() {
      if (!promptGroupModalEl) return
      promptGroupModalEl.classList.add('hidden')
      promptGroupModalEl.setAttribute('aria-hidden', 'true')
      promptGroupBtnEl?.setAttribute('aria-expanded', 'false')
      if (promptGroupSearchInput) {
        promptGroupSearchInput.value = ''
      }
      refreshModalOpenState()
      if (promptGroupBtnEl) {
        promptGroupBtnEl.focus()
      }
    }

    async function renderGroupList(prompts) {
      try {
        const groupTree = await apiCall('/groups')
        const container = document.getElementById('groupList')
        container.innerHTML = ''

        const promptMap = new Map()
        ;(Array.isArray(prompts) ? prompts : []).forEach(prompt => {
          const pathValue = prompt.groupPath || prompt.group || 'default'
          if (!promptMap.has(pathValue)) {
            promptMap.set(pathValue, [])
          }
          promptMap.get(pathValue).push(prompt)
        })

        if (currentPrompt) {
          const activePath = currentPrompt.groupPath || currentPrompt.group || 'default'
          collectAncestorPaths(activePath).forEach(pathValue => expandedGroups.add(pathValue))
        }

        const ensureDefaultNode = nodes => {
          const hasDefault = nodes.some(node => node.path === 'default')
          if (!hasDefault) {
            nodes.unshift({ name: 'default', path: 'default', children: [] })
          }
        }

        ensureDefaultNode(groupTree)
        groupTreeState = Array.isArray(groupTree) ? groupTree : []
        updateGroupSelectOptions(groupTreeState)

        const validPaths = new Set()
        const collectPaths = nodes => {
          nodes.forEach(node => {
            const nodePath = node.path || 'default'
            validPaths.add(nodePath)
            if (Array.isArray(node.children) && node.children.length) {
              collectPaths(node.children)
            }
          })
        }
        collectPaths(groupTree)
        expandedGroups = new Set([...expandedGroups].filter(pathValue => validPaths.has(pathValue)))

        const renderNode = (node, parentEl, depth = 0) => {
          const pathValue = node.path || 'default'
          const promptsInGroup = promptMap.get(pathValue) || []

          const section = document.createElement('div')
          section.className = 'group-section'
          section.dataset.path = pathValue
          section.dataset.depth = depth

          const header = document.createElement('div')
          header.className = 'group-header'
          header.dataset.group = pathValue
          header.style.paddingLeft = `${16 + depth * 18}px`

          const titleSpan = document.createElement('span')
          titleSpan.textContent = node.name
          header.appendChild(titleSpan)

          const headerActions = document.createElement('div')
          headerActions.style.display = 'flex'
          headerActions.style.alignItems = 'center'
          headerActions.style.gap = '6px'

          const countEl = document.createElement('span')
          countEl.className = 'group-count'
          countEl.id = `group-count-${sanitizeGroupId(pathValue)}`
          countEl.textContent = promptsInGroup.length

          const toggleEl = document.createElement('span')
          toggleEl.className = 'group-toggle'

          headerActions.appendChild(countEl)
          headerActions.appendChild(toggleEl)
          header.appendChild(headerActions)

          const content = document.createElement('div')
          content.className = 'group-content collapsed'

          const promptListEl = document.createElement('div')
          promptListEl.className = 'prompt-list'
          promptListEl.id = `promptList-${sanitizeGroupId(pathValue)}`
          content.appendChild(promptListEl)

          renderGroupPromptList(promptListEl, pathValue, promptsInGroup)

          let totalCount = promptsInGroup.length

          if (Array.isArray(node.children) && node.children.length) {
            const childrenWrap = document.createElement('div')
            childrenWrap.className = 'group-children'
            node.children.forEach(child => {
              const childCount = renderNode(child, childrenWrap, depth + 1)
              totalCount += childCount
            })
            if (childrenWrap.childNodes.length) {
              content.appendChild(childrenWrap)
            }
          }

          countEl.textContent = totalCount

          const shouldExpandByDefault = expandedGroups.size === 0 && depth === 0
          const isExpanded = expandedGroups.has(pathValue) || shouldExpandByDefault
          if (shouldExpandByDefault) {
            expandedGroups.add(pathValue)
          }

          content.classList.toggle('expanded', isExpanded)
          content.classList.toggle('collapsed', !isExpanded)
          toggleEl.classList.toggle('collapsed', !isExpanded)

          header.addEventListener('click', (e) => {
            const isClickOnActions = e.target.closest('.toggle-btn') || e.target.closest('.delete-btn') || e.target.closest('.prompt-actions')
            if (!isClickOnActions) {
              const nextExpanded = !content.classList.contains('expanded')
              content.classList.toggle('expanded', nextExpanded)
              content.classList.toggle('collapsed', !nextExpanded)
              toggleEl.classList.toggle('collapsed', !nextExpanded)
              if (nextExpanded) {
                expandedGroups.add(pathValue)
              } else {
                expandedGroups.delete(pathValue)
              }
            }
          })

          section.appendChild(header)
          section.appendChild(content)
          parentEl.appendChild(section)
          return totalCount
        }

        const fragment = document.createDocumentFragment()
        groupTree.forEach(node => renderNode(node, fragment, 0))
        container.appendChild(fragment)
      } catch (error) {
        console.error('渲染分组列表失败:', error)
      }
    }

    function renderGroupPromptList(container, groupPath, prompts) {
      container.innerHTML = ''

      const sortedPrompts = [...prompts].sort((a, b) => (a.name || '').localeCompare(b.name || '', 'zh-CN'))

      sortedPrompts.forEach(prompt => {
        const item = document.createElement('div')
        const isActive = currentPrompt?.relativePath
          ? prompt.relativePath === currentPrompt.relativePath
          : currentPrompt?.name === prompt.name
        item.className = `prompt-item ${prompt.enabled ? 'enabled' : ''} ${isActive ? 'active' : ''}`
        const hasSubGroup = prompt.groupPath && prompt.groupPath.includes('/')
        const groupHint = hasSubGroup ? prompt.groupPath : (prompt.group || 'default')
        item.innerHTML = `
          <div class="prompt-info">
            <div class="prompt-name">${prompt.name}</div>
            <div class="prompt-desc" title="${prompt.description || ''}">${prompt.description || ''}</div>
            ${hasSubGroup ? `<div class="prompt-meta-hint">${groupHint}</div>` : ''}
          </div>
          <div class="prompt-meta">
            <div class="prompt-actions">
              <button class="action-btn toggle-btn" data-prompt="${prompt.name}" data-path="${prompt.relativePath || ''}">
                ${prompt.enabled ? '停用' : '启用'}
              </button>
              <button class="action-btn delete-btn" data-prompt="${prompt.name}" data-path="${prompt.relativePath || ''}" style="color: var(--danger);">
                删除
              </button>
            </div>
          </div>
        `

        item.addEventListener('click', (e) => {
          if (!e.target.closest('.prompt-actions') && !e.target.classList.contains('toggle-btn') && !e.target.classList.contains('delete-btn')) {
            selectPrompt(prompt, e)
          }
        })

        const actions = item.querySelector('.prompt-actions')
        if (actions) {
          actions.addEventListener('click', (e) => {
            e.stopPropagation()
            e.preventDefault()
          })

          const toggleBtn = item.querySelector('.toggle-btn')
          const deleteBtn = item.querySelector('.delete-btn')

          if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
              e.stopPropagation()
              e.preventDefault()
              const targetPath = toggleBtn.getAttribute('data-path')
              togglePrompt(prompt.name, targetPath)
            })
          }

          if (deleteBtn) {
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation()
              e.preventDefault()
              const targetPath = deleteBtn.getAttribute('data-path')
              openDeletePromptModal(prompt.name, targetPath)
            })
          }
        }

        container.appendChild(item)
      })
    }

    async function togglePrompt(promptName, relativePath) {
      try {
        const query = relativePath ? `?path=${encodeURIComponent(relativePath)}` : ''
        const result = await apiCall(`/prompts/${encodeURIComponent(promptName)}/toggle${query}`, {
          method: 'POST'
        })
        const searchInput = document.getElementById('searchInput')
        const searchValue = searchInput ? searchInput.value : ''
        await loadPrompts(searchValue)
        const descriptor = relativePath ? `${promptName} (${relativePath})` : promptName
        const statusText = result?.enabled ? '已启用' : '已停用'
        showMessage(`“${descriptor}” ${statusText}`, result?.enabled ? 'success' : 'info')
        if (currentPrompt?.relativePath === relativePath) {
          currentPrompt.enabled = result?.enabled
          currentPromptObject = currentPromptObject ? { ...currentPromptObject, enabled: result?.enabled } : currentPromptObject
        }
      } catch (error) {
        console.error('切换prompt状态失败:', error)
        showMessage('启用状态切换失败: ' + error.message, 'error')
      }
    }

    async function deletePrompt(promptName, relativePath) {
      try {
        const query = relativePath ? `?path=${encodeURIComponent(relativePath)}` : ''
        await apiCall(`/prompts/${encodeURIComponent(promptName)}${query}`, {
          method: 'DELETE'
        })
        if (currentPrompt?.relativePath === relativePath || (!currentPrompt?.relativePath && currentPrompt?.name === promptName)) {
          resetEditor()
        }
        const searchInput = document.getElementById('searchInput')
        const searchValue = searchInput ? searchInput.value : ''
        await loadPrompts(searchValue)
        const descriptor = relativePath ? `${promptName} (${relativePath})` : promptName
        showMessage(`已删除 “${descriptor}”`)
      } catch (error) {
        console.error('删除prompt失败:', error)
        showMessage('删除失败: ' + error.message, 'error')
      }
    }


    // 选择prompt
    async function selectPrompt(prompt, triggerEvent) {
      try {
        const query = prompt.relativePath ? `?path=${encodeURIComponent(prompt.relativePath)}` : ''
        const promptData = await apiCall(`/prompts/${encodeURIComponent(prompt.name)}${query}`)
        currentPrompt = {
          ...promptData,
          relativePath: promptData.relativePath || prompt.relativePath || null,
          groupPath: promptData.groupPath || prompt.groupPath || null,
          group: promptData.group || prompt.group || null
        }

        let parsedPrompt = null
        try {
          parsedPrompt = window.jsyaml?.load(promptData.yaml || '') || null
        } catch (err) {
          console.error('解析提示词失败:', err)
        }

        currentPromptObject = parsedPrompt ? clonePromptObject(parsedPrompt) : createDefaultPromptObject()
        setArgumentsState(currentPromptObject.arguments || [])

        const nameInput = document.getElementById('promptName')
        if (nameInput) nameInput.value = currentPromptObject.name || promptData.name || ''
        document.getElementById('promptGroup').value = promptData.group || 'default'
        updatePromptGroupDisplay()

        if (descriptionInputEl) {
          descriptionInputEl.value = currentPromptObject.description || ''
          adjustDescriptionHeight()
        }

        const userMessage = getFirstUserMessage(currentPromptObject)
        const messageText = userMessage?.content?.text || ''
        if (editor) {
          editor.setValue(messageText)
        }

        // 更新UI状态
        document.querySelectorAll('.prompt-item').forEach(el => el.classList.remove('active'))
        const targetItem = triggerEvent?.currentTarget || triggerEvent?.target?.closest('.prompt-item')
        if (targetItem) {
          targetItem.classList.add('active')
        }

        // 更新预览
        updatePreview(true)
      } catch (error) {
        console.error('加载prompt详情失败:', error)
      }
    }



    // 切换工作区模式
    function setWorkspaceMode(mode) {
      const isPreview = mode === 'preview'
      const editorPane = document.getElementById('editorPane')
      const previewPane = document.getElementById('previewPane')
      const editModeBtn = document.getElementById('editModeBtn')
      const previewModeBtn = document.getElementById('previewModeBtn')
      const argumentsSection = document.getElementById('argumentsSection')

      if (!editorPane || !previewPane || !editModeBtn || !previewModeBtn) return

      editModeBtn.classList.toggle('active', !isPreview)
      previewModeBtn.classList.toggle('active', isPreview)
      editorPane.classList.toggle('hidden', isPreview)
      previewPane.classList.toggle('hidden', !isPreview)
      
      // 在预览模式下隐藏参数配置区域，编辑模式下显示
      if (argumentsSection) {
        argumentsSection.style.display = isPreview ? 'none' : 'flex'
      }

      if (isPreview) {
        updatePreview(true)
      } else {
        if (editor) {
          editor.refresh()
        }
        // 在切换回编辑模式时清理预览编辑器
        if (previewEditor) {
          const previewContent = document.getElementById('previewContent')
          if (previewContent) {
            previewContent.innerHTML = '<p>切换到预览模式查看内容</p>'
          }
          previewEditor = null
        }
      }
    }

    // 更新预览
    let previewEditor = null;

    async function updatePreview(force = false) {
      if (!editor) return

      const previewPane = document.getElementById('previewPane')
      if (!force && previewPane?.classList.contains('hidden')) {
        return
      }

      try {
        const previewContent = document.getElementById('previewContent')
        if (!previewContent) return

        const content = editor.getValue()
        
        // 如果预览编辑器不存在，创建一个
        if (!previewEditor) {
          previewContent.innerHTML = ''
          previewEditor = CodeMirror((elt) => {
            previewContent.appendChild(elt)
          }, {
            value: content,
            mode: 'markdown',
            theme: 'xq-light',
            lineWrapping: true,
            readOnly: true,
            lineNumbers: false,
            cursorHeight: 0
          })
        } else {
          // 更新预览内容
          previewEditor.setValue(content)
        }

        // 确保预览区域的 CodeMirror 实例能正确显示
        setTimeout(() => {
          if (previewEditor) {
            previewEditor.refresh()
          }
        }, 10)

      } catch (error) {
        console.error('预览更新失败:', error)
        document.getElementById('previewContent').innerHTML = '<p style="color: red;">预览生成失败</p>'
      }
    }

    // 保存prompt
    async function savePrompt() {
      if (!editor) return

      const saveBtn = document.getElementById('saveBtn')
      if (saveBtn?.disabled) return

      const name = document.getElementById('promptName').value.trim()
      const group = document.getElementById('promptGroup').value.trim()

      if (!window.jsyaml) {
        showMessage('资源未准备就绪，请刷新重试', 'error')
        return
      }

      if (!name) {
        showMessage('请输入prompt名称', 'error')
        return
      }

      const promptObject = buildPromptObjectFromUI()
      const unusedArguments = findUnusedArguments(promptObject)
      if (unusedArguments.length > 0) {
        const missingNames = unusedArguments.map(arg => arg.name).filter(Boolean)
        if (missingNames.length) {
          setUnusedArgumentHighlights(missingNames)
          const argumentsSection = document.getElementById('argumentsSection')
          if (argumentsSection) {
            argumentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' })
          }
          showMessage(`以下参数未在内容中使用：${missingNames.join(', ')}`, 'error')
          const firstMissing = missingNames[0]
          requestAnimationFrame(() => {
            const listEl = document.getElementById('argumentsList')
            if (!listEl) return
            const targetCard = Array.from(listEl.querySelectorAll('.argument-card')).find(card => {
              const idx = Number(card.dataset.index)
              const argName = argumentsState[idx]?.name?.trim()
              return argName === firstMissing
            })
            if (targetCard) {
              const targetIndex = Number(targetCard.dataset.index)
              if (Number.isInteger(targetIndex)) {
                openArgumentModal(targetIndex)
              }
            }
          })
          return
        }
      } else {
        setUnusedArgumentHighlights([])
      }
      const yaml = window.jsyaml.dump(promptObject)

      let originalText = ''
      if (saveBtn) {
        originalText = (saveBtn.textContent || '保存').trim()
        saveBtn.disabled = true
        saveBtn.classList.add('loading')
        saveBtn.textContent = '保存中...'
      }
      
      try {
        const result = await apiCall('/prompts', {
          method: 'POST',
          body: JSON.stringify({
            name,
            group,
            yaml,
            relativePath: currentPrompt?.relativePath || null
          })
        })
        
        showMessage('保存成功')
        currentPromptObject = clonePromptObject(promptObject)
        const updatedRelativePath = result?.relativePath || currentPrompt?.relativePath || null
        const pathSegments = updatedRelativePath ? updatedRelativePath.split('/') : []
        const updatedGroupPath = pathSegments.length > 1 ? pathSegments.slice(0, -1).join('/') : (pathSegments[0] || currentPrompt?.groupPath || group || 'default')
        currentPrompt = {
          ...(currentPrompt || {}),
          name,
          relativePath: updatedRelativePath,
          group: result?.group || group,
          groupPath: updatedGroupPath
        }
        // 重新加载列表，传递搜索参数
        const searchInput = document.getElementById('searchInput');
        const searchValue = searchInput ? searchInput.value : '';
        await loadPrompts(searchValue)
      } catch (error) {
        console.error('保存失败:', error)
        if (!error?.__shown) {
          showMessage('保存失败: ' + (error?.message || '未知错误'), 'error')
        }
      } finally {
        if (saveBtn) {
          saveBtn.disabled = false
          saveBtn.classList.remove('loading')
          saveBtn.textContent = originalText
        }
      }
    }

    // 重置编辑器
    function resetEditor() {
      document.getElementById('promptName').value = ''
      document.getElementById('promptGroup').value = 'default'
      updatePromptGroupDisplay()
      if (editor) editor.setValue('')
      if (descriptionInputEl) {
        descriptionInputEl.value = ''
        adjustDescriptionHeight()
      }
      setArgumentsState([])
      currentPrompt = null
      currentPromptObject = null
      document.getElementById('previewContent').innerHTML = '<p>选择或创建prompt开始编辑</p>'
      setWorkspaceMode('edit')
    }

    // 新建prompt
    function newPrompt() {
      currentPrompt = null
      currentPromptObject = createDefaultPromptObject()

      const nameInput = document.getElementById('promptName')
      if (nameInput) nameInput.value = currentPromptObject.name
      document.getElementById('promptGroup').value = 'default'
      updatePromptGroupDisplay()

      const defaultMessage = getFirstUserMessage(currentPromptObject)
      if (editor) {
        editor.setValue(defaultMessage?.content?.text || '')
      }

      setArgumentsState(currentPromptObject.arguments || [])

      if (descriptionInputEl) {
        descriptionInputEl.value = currentPromptObject.description || ''
        adjustDescriptionHeight()
      }

      document.getElementById('previewContent').innerHTML = '<p>选择或创建prompt开始编辑</p>'
      setWorkspaceMode('edit')

      document.querySelectorAll('.prompt-item').forEach(el => el.classList.remove('active'))
      updatePreview(true)
    }
    
    // 打开/关闭新建目录弹窗
    function toggleNewFolderModal(show) {
      const modal = document.getElementById('newFolderModal')
      const input = document.getElementById('newFolderName')
      
      if (typeof show === 'boolean') {
        modal.classList.toggle('hidden', !show)
      } else {
        modal.classList.toggle('hidden')
      }

      if (!modal.classList.contains('hidden')) {
        setTimeout(() => input?.focus(), 100)
        document.body.style.overflow = 'hidden'
      } else {
        document.body.style.overflow = ''
        if (input) input.value = ''
      }
    }

    // 处理目录名输入框的键盘事件
    function handleNewFolderKeydown(event) {
      if (event.key === 'Enter') {
        event.preventDefault()
        createNewFolder()
      } else if (event.key === 'Escape') {
        event.preventDefault()
        toggleNewFolderModal(false)
      }
    }

    // 创建新目录
    async function createNewFolder() {
      const input = document.getElementById('newFolderName')
      const folderName = (input?.value || '').trim()
      
      if (!folderName) {
        showMessage('请输入目录名称', 'error')
        input?.focus()
        return
      }

      try {
        await apiCall('/groups', {
          method: 'POST',
          body: JSON.stringify({ name: folderName })
        })
        
        showMessage('目录创建成功')
        toggleNewFolderModal(false)
        loadPrompts()
      } catch (error) {
        console.error('创建目录失败:', error)
        showMessage(error.message || '创建目录失败', 'error')
      }
    }

    // 初始化应用
    async function initApp() {
      try {
        // 样式资源：https://codemirror.net/5/theme/
        // 效果预览：https://toolshu.com/codemirror-theme-prev#default

        // 并行加载资源
        await Promise.all([
          loadScript('./js/codemirror.min.js'),
          loadScript('./js/markdown.min.js'),
          loadScript('./js/closebrackets.min.js'),
          loadScript('./js/js-yaml.min.js')
        ])

        // 初始化编辑器
        editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
          mode: 'markdown',
          lineNumbers: false,
          theme: 'xq-light',
          lineWrapping: true,
          autoCloseBrackets: true,
          value: '请选择或创建prompt开始编辑'
        })

        editor.on('change', () => updatePreview())

        const editModeBtn = document.getElementById('editModeBtn')
        const previewModeBtn = document.getElementById('previewModeBtn')
        editModeBtn.addEventListener('click', () => setWorkspaceMode('edit'))
        previewModeBtn.addEventListener('click', () => setWorkspaceMode('preview'))
        setWorkspaceMode('edit')

        descriptionInputEl = document.getElementById('promptDescription')
        if (descriptionInputEl) {
          descriptionInputEl.addEventListener('input', adjustDescriptionHeight)
          adjustDescriptionHeight()
        }

        setArgumentsState([])

        argumentModalEl = document.getElementById('argumentModal')
        argumentFormEl = document.getElementById('argumentForm')
        argumentModalTitleEl = document.getElementById('argumentModalTitle')
        argumentNameInput = document.getElementById('argumentNameInput')
        argumentTypeInput = document.getElementById('argumentTypeInput')
        argumentRequiredInput = document.getElementById('argumentRequiredInput')
        argumentDefaultInput = document.getElementById('argumentDefaultInput')
        argumentDescriptionInput = document.getElementById('argumentDescriptionInput')
        deletePromptModalEl = document.getElementById('deletePromptModal')
        deletePromptNameEl = document.getElementById('deletePromptName')
        deletePromptConfirmBtn = document.getElementById('deletePromptConfirmBtn')
        deletePromptCancelBtn = document.getElementById('deletePromptCancelBtn')
        deletePromptCloseBtn = document.getElementById('deletePromptCloseBtn')
        promptGroupBtnEl = document.getElementById('promptGroupBtn')
        promptGroupLabelEl = document.getElementById('promptGroupLabel')
        promptGroupModalEl = document.getElementById('promptGroupModal')
        promptGroupSearchInput = document.getElementById('promptGroupSearch')
        promptGroupListEl = document.getElementById('promptGroupList')
        promptGroupEmptyEl = document.getElementById('promptGroupEmpty')
        promptGroupModalCloseBtn = document.getElementById('promptGroupModalClose')
        updatePromptGroupDisplay()

        if (argumentTypeInput && !argumentTypeInput.value) {
          argumentTypeInput.value = 'string'
        }

        const addArgumentBtn = document.getElementById('addArgumentBtn')
        if (addArgumentBtn) {
          addArgumentBtn.addEventListener('click', () => openArgumentModal(null))
        }

        const argumentsListEl = document.getElementById('argumentsList')
        if (argumentsListEl) {
          argumentsListEl.addEventListener('click', handleArgumentListClick)
        }

        if (argumentFormEl) {
          argumentFormEl.addEventListener('submit', handleArgumentFormSubmit)
        }

        const argumentCancelBtn = document.getElementById('argumentCancelBtn')
        if (argumentCancelBtn) {
          argumentCancelBtn.addEventListener('click', closeArgumentModal)
        }

        const argumentModalClose = document.getElementById('argumentModalClose')
        if (argumentModalClose) {
          argumentModalClose.addEventListener('click', closeArgumentModal)
        }

        if (argumentModalEl) {
          argumentModalEl.addEventListener('click', (event) => {
            if (event.target === argumentModalEl) {
              closeArgumentModal()
            }
          })
        }

        if (promptGroupBtnEl) {
          promptGroupBtnEl.addEventListener('click', openPromptGroupModal)
        }
        if (promptGroupModalCloseBtn) {
          promptGroupModalCloseBtn.addEventListener('click', closePromptGroupModal)
        }
        if (promptGroupModalEl) {
          promptGroupModalEl.addEventListener('click', (event) => {
            if (event.target === promptGroupModalEl) {
              closePromptGroupModal()
            }
          })
        }
        if (promptGroupSearchInput) {
          promptGroupSearchInput.addEventListener('input', (event) => {
            populatePromptGroupModal(event.target.value || '')
          })
        }

        if (deletePromptConfirmBtn) {
          deletePromptConfirmBtn.addEventListener('click', confirmDeletePrompt)
        }
        const closeDeleteHandlers = [deletePromptCancelBtn, deletePromptCloseBtn]
        closeDeleteHandlers.forEach(btn => {
          if (btn) {
            btn.addEventListener('click', closeDeletePromptModal)
          }
        })
        if (deletePromptModalEl) {
          deletePromptModalEl.addEventListener('click', (event) => {
            if (event.target === deletePromptModalEl) {
              closeDeletePromptModal()
            }
          })
        }

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            if (promptGroupModalEl && !promptGroupModalEl.classList.contains('hidden')) {
              closePromptGroupModal()
              return
            }
            if (argumentModalEl && !argumentModalEl.classList.contains('hidden')) {
              closeArgumentModal()
              return
            }
            if (deletePromptModalEl && !deletePromptModalEl.classList.contains('hidden')) {
              closeDeletePromptModal()
            }
          }
        })

        // 绑定事件
        document.getElementById('loginBtn').addEventListener('click', () => {
          const username = document.getElementById('username').value.trim()
          const password = document.getElementById('password').value.trim()
          
          if (!username || !password) {
            document.getElementById('loginError').textContent = '请输入用户名和密码'
            return
          }
          
          login(username, password)
        })

        document.getElementById('logoutBtn').addEventListener('click', logout)
        document.getElementById('newPromptBtn').addEventListener('click', newPrompt)
        document.getElementById('newGroupBtn').addEventListener('click', () => toggleNewFolderModal(true))
        document.getElementById('saveBtn').addEventListener('click', savePrompt)

        // 搜索功能
        const searchInput = document.getElementById('searchInput')
        const searchBox = searchInput.closest('.search-box')
        const clearBtn = searchBox.querySelector('.clear-btn')
        let searchTimeout

        // 搜索输入事件
        searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout)
          searchTimeout = setTimeout(() => {
            loadPrompts(searchInput.value)
          }, 300)
        })

        // 清除按钮点击事件
        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            searchInput.value = ''
            searchInput.focus()
            loadPrompts('')
          })
        }

        // ESC 键清除搜索
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            searchInput.value = ''
            loadPrompts('')
          }
        })

        // 检查登录状态
        if (currentToken) {
          showMain()
          loadPrompts()
        } else {
          showLogin()
        }

      } catch (err) {
        console.error('初始化错误:', err)
        document.getElementById('loginError').textContent = '资源加载失败，请刷新重试'
        throw err
      }
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', initApp)
  </script>
</body>
</html>
