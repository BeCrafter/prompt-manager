<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt ÁÆ°ÁêÜÂêéÂè∞</title>
  <link rel="stylesheet" href="./css/codemirror.css">
  <link rel="stylesheet" href="./css/codemirror-theme_xq-light.css">
  <style>
    :root {
      --primary: #393939;
      --primary-dark: #393939;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --dark: #1a1a1a;
      --light: #f8f9fa;
      --gray: #6c757d;
      --gray-light: #dee2e6;
      --border: #e0e0e0;
      --sidebar-bg: #f8f9fa;
      --editor-bg: #263238;
      --preview-bg: #f5f5f5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    body {
      background-color: var(--light);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background-color: white;
      padding: 12px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .logo span {
      /* background: var(--primary);
      color: white; */
      color: #8e8989;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 400;
      border: 1px solid var(--border);
    }
    
    .nav-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--dark);
    }
    
    .btn-outline:hover {
      background: var(--light);
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    #addArgumentBtn {
      padding: 6px 12px;
      font-size: 12px;
    }

    button#saveBtn{
      padding: 10px 18px;
      font-size: 14px;
    }
    
    .btn.loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .btn-icon {
      padding: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
      height: 93%;
    }
    
    aside {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
      max-height: 100%;
      overflow-y: auto;
      scrollbar-width: none;
    }
    
    .sidebar-header {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    
    .new-prompt-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }
    
    .new-prompt-btn:hover {
      background: #333;
    }
    
    .search-container {
      display: flex;
      gap: 8px;
    }
    
    .search-box {
      position: relative;
      flex: 1;
    }
    
    .search-box input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .search-box::before {
      content: 'üîç';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 14px;
    }
    
    .folder-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .folder-btn:hover {
      background: #f5f5f5;
    }
    
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column-reverse;
      gap: 12px;
      z-index: 1100;
      align-items: flex-end;
    }

    .toast {
      min-width: 280px;
      max-width: 360px;
      background: white;
      border-radius: 12px;
      padding: 16px 18px;
      display: flex;
      align-items: flex-start;
      gap: 14px;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12);
      border: 1px solid transparent;
      opacity: 0;
      transform: translateY(16px);
      animation: toast-enter 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      pointer-events: auto;
    }

    .toast.toast-leave {
      animation: toast-leave 0.25s ease forwards;
    }

    .toast-success {
      border-color: rgba(40,167,69,0.35);
      background: linear-gradient(145deg, rgba(40,167,69,0.08), rgba(40,167,69,0.02));
    }

    .toast-error {
      border-color: rgba(220,53,69,0.35);
      background: linear-gradient(145deg, rgba(220,53,69,0.08), rgba(220,53,69,0.02));
    }

    .toast-info {
      border-color: rgba(0,102,255,0.3);
      background: linear-gradient(145deg, rgba(0,102,255,0.08), rgba(0,102,255,0.02));
    }

    .toast-warning {
      border-color: rgba(255,193,7,0.35);
      background: linear-gradient(145deg, rgba(255,193,7,0.1), rgba(255,193,7,0.03));
    }

    .toast-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      flex-shrink: 0;
      background: rgba(0,0,0,0.05);
      color: var(--dark);
    }

    .toast-success .toast-icon {
      background: rgba(40,167,69,0.15);
      color: var(--success);
    }

    .toast-error .toast-icon {
      background: rgba(220,53,69,0.15);
      color: var(--danger);
    }

    .toast-info .toast-icon {
      background: rgba(0,102,255,0.15);
      color: var(--primary);
    }

    .toast-warning .toast-icon {
      background: rgba(255,193,7,0.2);
      color: #b58100;
    }

    .toast-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .toast-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--dark);
    }

    .toast-message {
      font-size: 13px;
      color: var(--gray);
      line-height: 1.5;
      white-space: pre-line;
    }

    .toast-close {
      border: none;
      background: transparent;
      color: var(--gray);
      font-size: 18px;
      cursor: pointer;
      padding: 2px;
      line-height: 1;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .toast-close:hover {
      color: var(--dark);
    }
    
    @keyframes toast-enter {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes toast-leave {
      to {
        opacity: 0;
        transform: translateY(12px);
      }
    }
    
    .variable-desc {
      font-size: 12px;
      color: var(--gray);
      margin-top: 2px;
    }
    
    .group-section {
      margin-bottom: 8px;
    }
    
    .group-header {
      padding: 12px 15px;
      font-size: 14px;
      font-weight: 500;
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    
    .group-header:hover {
      background: #f0f0f0;
    }
    
    .group-toggle {
      transition: transform 0.2s;
    }
    
    .group-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .group-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .group-content.collapsed {
      max-height: 0;
    }
    
    .group-content.expanded {
      max-height: 1000px;
      overflow-y: auto;
      padding-top: 8px;
      scrollbar-width: none;
    }
    
    .group-count {
      background: #9ea2a6;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    .prompt-list {
      padding: 0 15px 15px;
    }
    
    .prompt-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      background: #f5f5f5;
      border: 1px solid transparent;
      transition: all 0.2s;
      margin-right: 10px; /* ÂêëÂè≥ËæπÊ°ÜÁßªÂä®‰∏ÄÂçäÁöÑË∑ùÁ¶ª */
    }
    
    .prompt-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0; /* ÂÖÅËÆ∏ÂÜÖÂÆπÊî∂Áº© */
      padding-right: 15px; /* Ë°•ÂÖÖÂÆΩÂ∫¶ */
    }
    
    .prompt-name {
      font-weight: 500;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .prompt-meta {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px; /* ÂáèÂ∞èÊåâÈíÆÂå∫ÂüüÂÆΩÂ∫¶ */
    }
    
    .prompt-item:hover {
      background: #eeeeee;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .prompt-item:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,102,255,0.1);
    }
    
    .prompt-item.active {
      background: rgba(0,102,255,0.05);
      border-color: var(--primary);
    }
    
    .prompt-info {
      flex: 1;
    }
    
    .prompt-name {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .prompt-desc {
      font-size: 12px;
      color: var(--gray);
      line-height: 1.3;
      height: 16px; /* ÂçïË°åÈ´òÂ∫¶ */
      overflow: hidden;
      position: relative;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }
    
    /* TooltipÊ†∑Âºè */
    .tooltip {
      position: relative;
    }
    
    .tooltip::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-width: 300px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: none;
    }
    
    .tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }
    
    /* ÂêØÁî®Áä∂ÊÄÅËæπÊ°ÜÊ†∑Âºè */
    .prompt-item.enabled {
      border-left: 4px solid #b8b3b3; /* ÊµÖ30%ÁöÑÊ∑±ÁÅ∞Ëâ≤ÔºåÂéü#333Ë∞ÉÊµÖ30%Á∫¶‰∏∫#666 */
    }
    
    /* ÈÄâ‰∏≠Áä∂ÊÄÅÊ†∑Âºè */
    .prompt-item.active {
      border-left: 4px solid #666; /* ÈÄâ‰∏≠Êó∂ÁöÑÁÅ∞Ëâ≤ËæπÊ°Ü */
    }
    
    /* ÊÇ¨ÂÅúÁä∂ÊÄÅÊ†∑Âºè */
    .prompt-item:hover {
      border-color: #666; /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÁöÑÁÅ∞Ëâ≤ËæπÊ°Ü */
    }
    
    /* Êìç‰ΩúÊåâÈíÆÊ†∑Âºè */
    .prompt-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      justify-content: center;
      height: 100%;
    }
    
    .prompt-item:hover .prompt-actions {
      opacity: 1;
    }
    
    .action-btn {
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      text-align: center;
    }
    
    .action-btn:hover {
      background: var(--gray-light);
    }
    
    /* ÁæéÂåñÁõÆÂΩï‰∏âËßíÂõæÊ†á */
    .group-toggle {
      transition: transform 0.3s ease;
      font-size: 12px;
      color: var(--gray);
    }
    
    .group-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .prompt-meta {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .prompt-tag {
      background: rgba(0,102,255,0.1);
      color: var(--primary);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .prompt-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .prompt-status.enabled {
      background: var(--success);
    }
    
    .prompt-status.disabled {
      background: var(--gray-light);
    }
    
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-left: 1px solid var(--border);
    }
    
    .editor-header {
      padding: 15px 20px;
      /* border-bottom: 1px solid var(--border); */
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: white;
    }
    
    .editor-header-top {
      display: flex;
      gap: 16px;
      align-items: center;
      width: 100%;
    }
    
    .editor-header-top input,
    .editor-header-top select,
    .prompt-description {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    
    .editor-header-top input {
      flex: 1;
      min-width: 0;
    }
    
    .editor-header-top select {
      min-width: 140px;
      flex-shrink: 0;
    }
    
    .editor-header-top input:focus,
    .editor-header-top select:focus,
    .prompt-description:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .prompt-description {
      width: 100%;
      min-height: 38px;
      line-height: 1.5;
      resize: none;
      overflow-y: hidden;
      transition: border-color 0.2s ease;
    }
    
    .prompt-description::-webkit-scrollbar {
      width: 6px;
    }
    
    .prompt-description::-webkit-scrollbar-thumb {
      background: var(--gray-light);
      border-radius: 3px;
    }
    
    .editor-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-left: auto;
    }
    
    .mode-toggle {
      display: inline-flex;
      align-items: center;
      padding: 4px;
      border-radius: 999px;
      background: var(--light);
      border: 1px solid var(--border);
    }
    
    .mode-btn {
      padding: 6px 18px;
      border: none;
      background: transparent;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      color: var(--gray);
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    
    .editor-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 16px;
      margin: 12px 20px 20px;
    }

    .arguments-section {
      padding: 18px 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .arguments-section.has-error {
      border-color: rgba(220,53,69,0.4);
      box-shadow: 0 0 0 2px rgba(220,53,69,0.08), 0 8px 24px rgba(220,53,69,0.08);
    }

    .arguments-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .arguments-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .arguments-title span {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }

    .arguments-title small {
      font-size: 12px;
      color: var(--gray);
    }

    .arguments-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .arguments-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
    }

    .arguments-empty {
      grid-column: 1 / -1;
      font-size: 13px;
      color: var(--gray);
      background: var(--light);
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .argument-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(248,249,250,0.9), rgba(255,255,255,0.9));
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 150px;
      position: relative;
    }

    .argument-card.argument-card-unused {
      border-color: rgba(220,53,69,0.45);
      box-shadow: 0 0 0 1px rgba(220,53,69,0.18);
      background: rgba(220,53,69,0.04);
    }

    .argument-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .argument-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary);
      word-break: break-all;
    }

    .argument-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .argument-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(0,0,0,0.04);
      color: var(--gray);
    }

    .argument-required {
      background: rgba(220,53,69,0.12);
      color: var(--danger);
      font-weight: 600;
    }

    .argument-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: var(--gray);
      font-size: 12px;
    }

    .argument-body .argument-description {
      color: var(--dark);
      font-size: 13px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .argument-body .argument-placeholder {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(0,0,0,0.04);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--primary);
      display: inline-block;
    }

    .argument-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: auto;
    }

    .argument-action-btn {
      border: none;
      background: rgba(0,0,0,0.04);
      color: var(--primary);
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .argument-action-btn:hover {
      background: rgba(0,0,0,0.08);
    }

    .argument-action-btn.delete {
      color: var(--danger);
      background: rgba(220,53,69,0.08);
    }

    .argument-action-btn.delete:hover {
      background: rgba(220,53,69,0.12);
    }

    .argument-modal {
      position: fixed;
      inset: 0;
      background: rgba(17, 17, 17, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 24px;
      transition: opacity 0.2s ease;
    }

    .argument-modal.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .argument-modal-dialog {
      width: min(520px, 100%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .argument-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
    }

    .argument-modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }

    .argument-modal-close {
      border: none;
      background: transparent;
      font-size: 24px;
      line-height: 1;
      color: var(--gray);
      cursor: pointer;
      padding: 4px;
    }

    .argument-modal-close:hover {
      color: var(--dark);
    }

    .argument-modal-body {
      padding: 20px 24px 8px;
    }

    .argument-form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px 18px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-field.full-width {
      grid-column: 1 / -1;
    }

    .form-field-inline {
      align-self: end;
      height: 100%;
      display: flex;
      align-items: flex-end;
      padding-top: 26px;
    }

    .argument-modal label {
      font-size: 13px;
      color: var(--gray);
      font-weight: 500;
    }

    .argument-modal .required {
      color: var(--danger);
      font-weight: 600;
      font-size: 12px;
    }

    .argument-modal input[type="text"],
    .argument-modal textarea {
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 14px;
      background: white;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .argument-modal input[type="text"]:focus,
    .argument-modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(57,57,57,0.08);
    }

    .argument-modal textarea {
      resize: vertical;
      min-height: 96px;
    }

    .checkbox-field {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--dark);
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .checkbox-field input {
      accent-color: var(--primary);
    }

    .argument-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px 20px;
      border-top: 1px solid var(--border);
      background: rgba(248,249,250,0.65);
    }

    body.modal-open {
      overflow: hidden;
    }

    .editor-body {
      position: relative;
      flex: 1;
      box-sizing: border-box;
      min-height: 0;
    }
    
    .workspace-pane {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      background: white;
      transition: opacity 0.25s ease;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
    }
    
    .workspace-pane.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    
    .pane-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: white;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray);
    }
    
    .pane-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0;
      min-height: 0;
    }
    
    .pane-content.preview {
      background: var(--preview-bg);
      padding: 24px;
    }

    .CodeMirror {
      flex: 1;
      height: 100%;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .CodeMirror-scroll {
      min-height: 100%;
    }
    
    .preview-content {
      flex: 1;
      padding: 24px;
      overflow: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      scrollbar-width: thin;
      scrollbar-color: var(--gray-light) transparent;
    }

    @media (max-width: 1100px) {
      .arguments-list {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }
    
    .empty-state h3 {
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .empty-state p {
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .login-box {
      width: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 40px;
      text-align: center;
    }
    
    .login-box h2 {
      margin-bottom: 30px;
      color: var(--dark);
    }
    
    .login-box input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
    }
    
    .login-box input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .login-box button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
    }
    
    .error-msg {
      color: var(--danger);
      font-size: 13px;
      margin-top: 5px;
      text-align: left;
    }
    
    .success-msg {
      color: var(--success);
      font-size: 13px;
      margin-top: 5px;
      text-align: center;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-badge.enabled {
      background: rgba(40,167,69,0.1);
      color: var(--success);
    }
    
    .status-badge.disabled {
      background: rgba(220,53,69,0.1);
      color: var(--danger);
    }

    .CodeMirror-gutters {
      left: -2px !important;
    }
  </style>
</head>
<body>
  <!-- ÁôªÂΩïÁïåÈù¢ -->
  <div id="login" class="login-container">
    <div class="login-box">
      <h2>Prompt ÁÆ°ÁêÜÂêéÂè∞</h2>
      <input type="text" id="username" placeholder="Áî®Êà∑Âêç" />
      <input type="password" id="password" placeholder="ÂØÜÁ†Å" />
      <div id="loginError" class="error-msg"></div>
      <button id="loginBtn" class="btn btn-primary">ÁôªÂΩï</button>
    </div>
  </div>

  <!-- ‰∏ªÁïåÈù¢ -->
  <div id="main" style="display: none; height: 100vh; flex-direction: column;">
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <header>
      <div class="logo">
        Prompt Manager <span>Beta</span>
      </div>
      <div class="nav-right">
        <button id="logoutBtn" class="btn btn-outline">ÈÄÄÂá∫</button>
      </div>
    </header>

    <!-- ‰∏ª‰ΩìÂÜÖÂÆπ -->
    <main>
      <!-- Â∑¶‰æßËæπÊ†è -->
      <aside>
        <div class="sidebar-header">
          <button id="newPromptBtn" class="new-prompt-btn">
            <span>+</span> Êñ∞Âª∫ Prompt
          </button>
          <div class="search-container">
            <div class="search-box">
              <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢Prompts..." />
            </div>
            <button id="newGroupBtn" class="folder-btn">
              üìÅ
            </button>
          </div>
        </div>
        
        <div id="groupList"></div>
      </aside>

      <!-- Âè≥‰æßÁºñËæëÂô® -->
      <div class="editor-container">
        <div class="editor-header">
          <div class="editor-header-top">
            <input type="text" id="promptName" placeholder="Prompt ÂêçÁß∞" />
            <select id="promptGroup">
              <option value="default">default</option>
              <option value="developer">developer</option>
              <option value="generator">generator</option>
              <option value="operation">operation</option>
            </select>
            <div class="editor-controls">
              <div class="mode-toggle">
                <button id="editModeBtn" class="mode-btn active" data-mode="edit">ÁºñËæë</button>
                <button id="previewModeBtn" class="mode-btn" data-mode="preview">È¢ÑËßà</button>
              </div>
              <button id="saveBtn" class="btn btn-primary btn-sm">
                ‰øùÂ≠ò
              </button>
            </div>
          </div>
          <textarea id="promptDescription" class="prompt-description" placeholder="Prompt ÊèèËø∞"></textarea>
        </div>

        <div class="editor-content">
          <section class="arguments-section" id="argumentsSection">
            <div class="arguments-header">
              <div class="arguments-title">
                <span>ÂèÇÊï∞ÈÖçÁΩÆ</span>
              </div>
              <div class="arguments-actions">
                <button id="addArgumentBtn" class="btn btn-outline btn-sm" type="button">
                  Êñ∞Â¢û
                </button>
              </div>
            </div>
            <div class="arguments-list" id="argumentsList">
              <div class="arguments-empty">ÊöÇÊó†ÂèÇÊï∞ÔºåÁÇπÂáª‚ÄúÊñ∞Â¢û‚ÄùÂºÄÂßãÈÖçÁΩÆ</div>
            </div>
          </section>
          <div class="editor-body" id="editorWorkspace">
            <div class="workspace-pane" id="editorPane">
              <div class="pane-header">Markdown ÁºñËæëÂô®</div>
              <div class="pane-content">
                <textarea id="editor"></textarea>
              </div>
            </div>
            <div class="workspace-pane hidden" id="previewPane">
              <div class="pane-header">ÂÆûÊó∂È¢ÑËßà</div>
              <div class="pane-content preview">
                <div class="preview-content" id="previewContent">
                  <p>ÈÄâÊã©ÊàñÂàõÂª∫promptÂºÄÂßãÁºñËæë</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Ê∂àÊÅØÊèêÁ§∫ -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- ÂèÇÊï∞ÁºñËæëÂºπÁ™ó -->
  <div id="argumentModal" class="argument-modal hidden" role="dialog" aria-modal="true" aria-labelledby="argumentModalTitle">
    <div class="argument-modal-dialog">
      <div class="argument-modal-header">
        <h3 id="argumentModalTitle">Êñ∞Â¢ûÂèÇÊï∞</h3>
        <button type="button" id="argumentModalClose" class="argument-modal-close" aria-label="ÂÖ≥Èó≠">√ó</button>
      </div>
      <form id="argumentForm" class="argument-modal-form">
        <div class="argument-modal-body">
          <div class="argument-form-grid">
            <div class="form-field">
              <label for="argumentNameInput">ÂèÇÊï∞ÂêçÁß∞ <span class="required">*</span></label>
              <input type="text" id="argumentNameInput" placeholder="‰æãÂ¶ÇÔºölanguage" />
            </div>
            <div class="form-field">
              <label for="argumentTypeInput">Á±ªÂûã</label>
              <input type="text" id="argumentTypeInput" list="argumentTypeOptions" placeholder="‰æãÂ¶ÇÔºöstring" />
            </div>
            <div class="form-field">
              <label for="argumentDefaultInput">ÈªòËÆ§ÂÄº</label>
              <input type="text" id="argumentDefaultInput" placeholder="ÂèØÈÄâ" />
            </div>
            <div class="form-field form-field-inline">
              <label class="checkbox-field">
                <input type="checkbox" id="argumentRequiredInput" />
                <span>ÂøÖÂ°´</span>
              </label>
            </div>
            <div class="form-field full-width">
              <label for="argumentDescriptionInput">ÂèÇÊï∞ËØ¥Êòé</label>
              <textarea id="argumentDescriptionInput" rows="3" placeholder="Áî®‰∫éÊèêÁ§∫ËØç‰∏≠ÁöÑÊèèËø∞"></textarea>
            </div>
          </div>
        </div>
        <div class="argument-modal-footer">
          <button type="button" class="btn btn-outline" id="argumentCancelBtn">ÂèñÊ∂à</button>
          <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
        </div>
      </form>
    </div>
  </div>

  <datalist id="argumentTypeOptions">
    <option value="string">Â≠óÁ¨¶‰∏≤</option>
    <option value="number">Êï∞Â≠ó</option>
    <option value="boolean">Â∏ÉÂ∞îÂÄº</option>
    <option value="array">Êï∞ÁªÑ</option>
    <option value="object">ÂØπË±°</option>
    <option value="json">JSON</option>
    <option value="enum">Êûö‰∏æ</option>
  </datalist>

  <script>
    // Â∫îÁî®Áä∂ÊÄÅ
    let currentToken = localStorage.getItem('prompt-admin-token')
    let currentPrompt = null
    let currentPromptObject = null
    let descriptionInputEl = null
    let allPrompts = []
    let expandedGroups = new Set()
    let editor = null
    let argumentsState = []
    let unusedArgumentNames = new Set()
    let editingArgumentIndex = null
    let argumentModalEl = null
    let argumentFormEl = null
    let argumentModalTitleEl = null
    let argumentNameInput = null
    let argumentTypeInput = null
    let argumentRequiredInput = null
    let argumentDefaultInput = null
    let argumentDescriptionInput = null

    // API Âü∫Á°ÄÈÖçÁΩÆ
    const API_BASE = '/api'

    // Âä®ÊÄÅÂä†ËΩΩCodeMirrorËµÑÊ∫ê
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = src
        script.onload = resolve
        script.onerror = () => reject(new Error(`Âä†ËΩΩÂ§±Ë¥•: ${src}`))
        document.head.appendChild(script)
      })
    }

    // APIËØ∑Ê±ÇÂ∞ÅË£Ö
    async function apiCall(endpoint, options = {}) {
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      }

      if (currentToken) {
        config.headers.Authorization = `Bearer ${currentToken}`
      }

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, config)
        
        if (response.status === 401) {
          // Token ËøáÊúüÔºåÈáçÊñ∞ÁôªÂΩï
          localStorage.removeItem('prompt-admin-token')
          currentToken = null
          showLogin()
          throw new Error('ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï')
        }

        if (!response.ok) {
          const error = await response.text()
          throw new Error(error || 'ËØ∑Ê±ÇÂ§±Ë¥•')
        }

        return await response.json()
      } catch (error) {
        const handledError = error instanceof Error ? error : new Error(error?.message || 'ËØ∑Ê±ÇÂ§±Ë¥•')
        handledError.__shown = true
        console.error('APIËØ∑Ê±ÇÈîôËØØ:', handledError)
        showMessage(handledError.message, 'error')
        throw handledError
      }
    }

    // ÊèêÁ§∫ÁªÑ‰ª∂
    function showMessage(message, type = 'success', options = {}) {
      const container = document.getElementById('toastContainer')
      if (!container) return

      const normalizedType = ['success', 'error', 'info', 'warning'].includes(type) ? type : 'success'
      const titleMap = {
        success: 'Êìç‰ΩúÊàêÂäü',
        error: 'Êìç‰ΩúÂ§±Ë¥•',
        info: 'ÊèêÁ§∫‰ø°ÊÅØ',
        warning: 'Ê≥®ÊÑè'
      }
      const iconMap = {
        success: '‚úì',
        error: '‚úï',
        info: '‚Ñπ',
        warning: '!' 
      }

      const toast = document.createElement('div')
      toast.className = `toast toast-${normalizedType}`
      toast.setAttribute('role', normalizedType === 'error' ? 'alert' : 'status')
      toast.setAttribute('aria-live', normalizedType === 'error' ? 'assertive' : 'polite')

      const iconEl = document.createElement('span')
      iconEl.className = 'toast-icon'
      iconEl.textContent = options.icon || iconMap[normalizedType]

      const contentEl = document.createElement('div')
      contentEl.className = 'toast-content'

      const titleText = options.title || titleMap[normalizedType]
      if (titleText) {
        const titleEl = document.createElement('div')
        titleEl.className = 'toast-title'
        titleEl.textContent = titleText
        contentEl.appendChild(titleEl)
      }

      const messageEl = document.createElement('div')
      messageEl.className = 'toast-message'
      messageEl.textContent = message
      contentEl.appendChild(messageEl)

      const closeBtn = document.createElement('button')
      closeBtn.className = 'toast-close'
      closeBtn.type = 'button'
      closeBtn.setAttribute('aria-label', 'ÂÖ≥Èó≠ÊèêÁ§∫')
      closeBtn.innerHTML = '&times;'

      toast.appendChild(iconEl)
      toast.appendChild(contentEl)
      toast.appendChild(closeBtn)
      container.appendChild(toast)

      let hideTimer
      let removed = false

      const removeToast = () => {
        if (removed) return
        removed = true
        toast.classList.add('toast-leave')
        toast.removeEventListener('mouseenter', pauseTimer)
        toast.removeEventListener('mouseleave', resumeTimer)
        setTimeout(() => {
          if (toast.parentNode === container) {
            container.removeChild(toast)
          }
        }, 250)
      }

      const pauseTimer = () => clearTimeout(hideTimer)
      const resumeTimer = () => {
        clearTimeout(hideTimer)
        hideTimer = setTimeout(removeToast, Number(options.duration) || 5000)
      }

      closeBtn.addEventListener('click', () => {
        pauseTimer()
        removeToast()
      })

      toast.addEventListener('mouseenter', pauseTimer)
      toast.addEventListener('mouseleave', resumeTimer)

      resumeTimer()
    }

    // ÁôªÂΩïÂäüËÉΩ
    async function login(username, password) {
      try {
        const result = await apiCall('/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        })
        
        currentToken = result.token
        localStorage.setItem('prompt-admin-token', currentToken)
        showMain()
        loadPrompts()
      } catch (error) {
        document.getElementById('loginError').textContent = error.message || 'ÁôªÂΩïÂ§±Ë¥•'
      }
    }

    function escapeHtml(input) {
      if (input === null || input === undefined) {
        return ''
      }
      return String(input).replace(/[&<>"']/g, (match) => {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }
        return map[match] || match
      })
    }

    function escapeRegExp(input) {
      return String(input).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
    }

    // ÈÄÄÂá∫ÁôªÂΩï
    function logout() {
      localStorage.removeItem('prompt-admin-token')
      currentToken = null
      showLogin()
    }

    // ÊòæÁ§∫ÁôªÂΩïÁïåÈù¢
    function showLogin() {
      document.getElementById('login').style.display = 'flex'
      document.getElementById('main').style.display = 'none'
    }

    // ÊòæÁ§∫‰∏ªÁïåÈù¢
    function showMain() {
      document.getElementById('login').style.display = 'none'
      document.getElementById('main').style.display = 'block'
    }

    // Âä†ËΩΩpromptÂàóË°®
    async function loadPrompts(search = '', enabledOnly = false, group = null) {
      try {
        const queryParams = new URLSearchParams()
        if (search) queryParams.append('search', search)
        if (enabledOnly) queryParams.append('enabled', 'true')
        if (group) queryParams.append('group', group)
        
        const prompts = await apiCall(`/prompts?${queryParams}`)
        allPrompts = prompts
        renderGroupList(prompts)
      } catch (error) {
        console.error('Âä†ËΩΩpromptÂàóË°®Â§±Ë¥•:', error)
      }
    }

    function createDefaultPromptObject() {
      return {
        name: 'new-prompt',
        description: 'Êñ∞promptÊèèËø∞',
        enabled: true,
        messages: [
          {
            role: 'user',
            content: {
              text: `ËøôÊòØ‰∏Ä‰∏™Êñ∞ÁöÑpromptÊ®°Êùø\n{{variable1}}`
            }
          }
        ],
        arguments: [
          {
            name: 'variable1',
            type: 'string',
            required: false,
            default: '',
            description: 'Á§∫‰æãÂèòÈáè'
          }
        ],
        variables: [
          {
            name: 'variable1',
            type: 'string',
            required: false,
            default: '',
            description: 'Á§∫‰æãÂèòÈáè'
          }
        ]
      }
    }

    function clonePromptObject(obj) {
      return obj ? JSON.parse(JSON.stringify(obj)) : null
    }

    function getFirstUserMessage(promptObj) {
      if (!promptObj || !Array.isArray(promptObj.messages)) return null
      return promptObj.messages.find(message => message?.role === 'user') || null
    }

    function buildPromptObjectFromUI() {
      const nameInput = document.getElementById('promptName')
      const name = (nameInput?.value || '').trim() || 'new-prompt'
      const description = descriptionInputEl?.value || ''
      const markdown = editor ? editor.getValue() : ''

      const base = clonePromptObject(currentPromptObject) || createDefaultPromptObject()
      base.name = name
      base.description = description

      if (!Array.isArray(base.messages)) {
        base.messages = []
      }

      let userMessage = getFirstUserMessage(base)
      if (!userMessage) {
        userMessage = { role: 'user', content: { text: '' } }
        base.messages.push(userMessage)
      }

      if (!userMessage.content || typeof userMessage.content !== 'object') {
        userMessage.content = {}
      }

      userMessage.content.text = markdown

      const sanitizedArguments = Array.isArray(argumentsState)
        ? argumentsState
            .map(arg => {
              const nameValue = (arg.name || '').trim()
              if (!nameValue) return null
              const typeValue = (arg.type || '').trim()
              const descriptionValue = (arg.description || '').trim()
              const defaultValue = arg.default
              const argumentResult = {
                name: nameValue,
                type: typeValue || 'string',
                required: Boolean(arg.required)
              }
              if (descriptionValue) {
                argumentResult.description = descriptionValue
              }
              if (defaultValue !== undefined && defaultValue !== null) {
                const defaultText = String(defaultValue).trim()
                if (defaultText) {
                  argumentResult.default = defaultText
                }
              }
              return argumentResult
            })
            .filter(Boolean)
        : []

      base.arguments = sanitizedArguments

      return base
    }

    function adjustDescriptionHeight() {
      if (!descriptionInputEl) return

      const style = window.getComputedStyle(descriptionInputEl)
      const lineHeight = parseFloat(style.lineHeight) || 20
      const padding = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom) || 0
      const border = parseFloat(style.borderTopWidth) + parseFloat(style.borderBottomWidth) || 0
      const maxHeight = lineHeight * 4 + padding + border
      const baseHeight = lineHeight + padding + border

      descriptionInputEl.style.height = 'auto'
      const contentHeight = descriptionInputEl.scrollHeight
      const newHeight = Math.max(baseHeight, Math.min(maxHeight, contentHeight))
      descriptionInputEl.style.height = `${newHeight}px`
      descriptionInputEl.style.overflowY = descriptionInputEl.scrollHeight > maxHeight ? 'auto' : 'hidden'
    }

    function normalizeArgument(argument = {}) {
      return {
        name: argument?.name ? String(argument.name) : '',
        description: argument?.description ? String(argument.description) : '',
        type: argument?.type ? String(argument.type) : 'string',
        required: Boolean(argument?.required),
        default: argument?.default ?? ''
      }
    }

    function setArgumentsState(list = []) {
      argumentsState = Array.isArray(list) ? list.map(item => normalizeArgument(item)) : []
      unusedArgumentNames = new Set()
      const section = document.getElementById('argumentsSection')
      if (section) {
        section.classList.remove('has-error')
      }
      renderArgumentsEditor()
    }

    function removeArgument(index) {
      if (index < 0 || index >= argumentsState.length) return
      argumentsState.splice(index, 1)
      setUnusedArgumentHighlights([])
    }

    function renderArgumentsEditor() {
      const listEl = document.getElementById('argumentsList')
      if (!listEl) return

      listEl.innerHTML = ''

      if (!argumentsState.length) {
        listEl.innerHTML = '<div class="arguments-empty">ÊöÇÊó†ÂèÇÊï∞ÔºåÁÇπÂáª‚ÄúÊñ∞Â¢ûÂèÇÊï∞‚ÄùÂºÄÂßãÈÖçÁΩÆ</div>'
        return
      }

      const fragment = document.createDocumentFragment()

      argumentsState.forEach((rawArgument, index) => {
        const argument = normalizeArgument(rawArgument)
        const displayName = argument.name?.trim() || `ÂèÇÊï∞ ${index + 1}`
        const normalizedName = argument.name?.trim() || ''
        const safeType = escapeHtml(argument.type || 'string')
        const safeDefault = argument.default ? escapeHtml(String(argument.default)) : ''
        const safeDescription = argument.description ? escapeHtml(argument.description) : ''

        const card = document.createElement('div')
        card.className = 'argument-card'
        card.dataset.index = index

        if (normalizedName && unusedArgumentNames.has(normalizedName)) {
          card.classList.add('argument-card-unused')
        }

        const badgeParts = [`<span class="argument-badge">Á±ªÂûãÔºö${safeType || 'string'}</span>`]
        if (argument.required) {
          badgeParts.push('<span class="argument-badge argument-required">ÂøÖÂ°´</span>')
        }
        if (safeDefault) {
          badgeParts.push(`<span class="argument-badge">ÈªòËÆ§Ôºö${safeDefault}</span>`)
        }

        const placeholderSnippet = normalizedName
          ? `<div>ÂèòÈáèÂç†‰ΩçÔºö<span class="argument-placeholder">{{${escapeHtml(normalizedName)}}}</span></div>`
          : ''

        card.innerHTML = `
          <div class="argument-card-header">
            <div class="argument-name">${escapeHtml(displayName)}</div>
            <div class="argument-badges">${badgeParts.join('')}</div>
          </div>
          <div class="argument-body">
            ${safeDescription ? `<div class="argument-description">${safeDescription}</div>` : '<div class="argument-description" style="color: var(--gray);">ÊöÇÊó†ËØ¥Êòé</div>'}
            ${placeholderSnippet}
          </div>
          <div class="argument-actions">
            <button type="button" class="argument-action-btn edit" data-action="edit" data-index="${index}">ÁºñËæë</button>
            <button type="button" class="argument-action-btn delete" data-action="delete" data-index="${index}">Âà†Èô§</button>
          </div>
        `

        fragment.appendChild(card)
      })

      listEl.appendChild(fragment)
    }

    function setUnusedArgumentHighlights(names = []) {
      unusedArgumentNames = new Set(Array.isArray(names) ? names.map(name => String(name).trim()).filter(Boolean) : [])
      const section = document.getElementById('argumentsSection')
      if (section) {
        section.classList.toggle('has-error', unusedArgumentNames.size > 0)
      }
      renderArgumentsEditor()
    }

    function openArgumentModal(index = null) {
      if (!argumentModalEl) return
      editingArgumentIndex = Number.isInteger(index) && index >= 0 ? index : null
      const isEdit = editingArgumentIndex !== null && argumentsState[editingArgumentIndex]
      const payload = isEdit ? normalizeArgument(argumentsState[editingArgumentIndex]) : normalizeArgument({ type: 'string' })

      if (argumentModalTitleEl) {
        argumentModalTitleEl.textContent = isEdit ? 'ÁºñËæëÂèÇÊï∞' : 'Êñ∞Â¢ûÂèÇÊï∞'
      }
      if (argumentNameInput) {
        argumentNameInput.value = payload.name || ''
      }
      if (argumentTypeInput) {
        argumentTypeInput.value = payload.type || 'string'
      }
      if (argumentRequiredInput) {
        argumentRequiredInput.checked = Boolean(payload.required)
      }
      if (argumentDefaultInput) {
        const modalDefaultValue = payload.default
        argumentDefaultInput.value = modalDefaultValue === undefined || modalDefaultValue === null ? '' : String(modalDefaultValue)
      }
      if (argumentDescriptionInput) {
        argumentDescriptionInput.value = payload.description || ''
      }

      argumentModalEl.classList.remove('hidden')
      argumentModalEl.setAttribute('aria-hidden', 'false')
      document.body.classList.add('modal-open')

      requestAnimationFrame(() => {
        if (argumentNameInput) {
          argumentNameInput.focus()
          argumentNameInput.select()
        }
      })
    }

    function closeArgumentModal() {
      if (!argumentModalEl) return
      argumentModalEl.classList.add('hidden')
      argumentModalEl.setAttribute('aria-hidden', 'true')
      document.body.classList.remove('modal-open')
      editingArgumentIndex = null

      if (argumentFormEl) {
        argumentFormEl.reset()
      }
      if (argumentNameInput) {
        argumentNameInput.value = ''
      }
      if (argumentTypeInput) {
        argumentTypeInput.value = 'string'
      }
      if (argumentRequiredInput) {
        argumentRequiredInput.checked = false
      }
      if (argumentDefaultInput) {
        argumentDefaultInput.value = ''
      }
      if (argumentDescriptionInput) {
        argumentDescriptionInput.value = ''
      }
    }

    function handleArgumentFormSubmit(event) {
      event.preventDefault()
      if (!argumentNameInput || !argumentTypeInput) return

      const name = (argumentNameInput.value || '').trim()
      if (!name) {
        showMessage('ËØ∑ËæìÂÖ•ÂèÇÊï∞ÂêçÁß∞', 'error')
        argumentNameInput.focus()
        return
      }

      const type = (argumentTypeInput.value || 'string').trim() || 'string'
      const required = argumentRequiredInput ? argumentRequiredInput.checked : false
      const defaultValue = argumentDefaultInput ? argumentDefaultInput.value : ''
      const description = argumentDescriptionInput ? argumentDescriptionInput.value.trim() : ''

      const payload = normalizeArgument({
        name,
        type,
        required,
        default: defaultValue,
        description
      })

      if (editingArgumentIndex !== null && argumentsState[editingArgumentIndex]) {
        argumentsState[editingArgumentIndex] = payload
      } else {
        argumentsState.push(payload)
      }

      closeArgumentModal()
      setUnusedArgumentHighlights([])
    }

    function collectPromptTextContent(promptObject) {
      const segments = []
      if (!promptObject || !Array.isArray(promptObject.messages)) {
        return ''
      }
      promptObject.messages.forEach(message => {
        if (!message) return
        const content = message.content
        if (Array.isArray(content)) {
          content.forEach(item => {
            if (typeof item === 'string') {
              segments.push(item)
            } else if (item && typeof item === 'object') {
              Object.values(item).forEach(value => {
                if (typeof value === 'string') {
                  segments.push(value)
                }
              })
            }
          })
        } else if (typeof content === 'string') {
          segments.push(content)
        } else if (content && typeof content === 'object') {
          Object.values(content).forEach(value => {
            if (typeof value === 'string') {
              segments.push(value)
            }
          })
        }
      })
      return segments.join('\n')
    }

    function findUnusedArguments(promptObject) {
      const args = Array.isArray(promptObject?.arguments) ? promptObject.arguments : []
      if (!args.length) return []
      const combinedContent = collectPromptTextContent(promptObject)
      return args.filter(arg => {
        const name = arg?.name?.trim()
        if (!name) return false
        const pattern = new RegExp(`{{\\s*${escapeRegExp(name)}\\s*}}`)
        return !pattern.test(combinedContent)
      })
    }

    function handleArgumentListClick(event) {
      const target = event.target.closest('[data-action]')
      if (!target) return
      const action = target.dataset.action
      const index = Number(target.dataset.index)
      if (!Number.isInteger(index)) return
      if (action === 'delete') {
        const argumentName = argumentsState[index]?.name || `ÂèÇÊï∞ ${index + 1}`
        const confirmed = window.confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÂèÇÊï∞ "${argumentName}" ÂêóÔºü`)
        if (!confirmed) return
        removeArgument(index)
      } else if (action === 'edit') {
        openArgumentModal(index)
      }
    }

    // Ê∏≤ÊüìÂàÜÁªÑÂàóË°®
    async function renderGroupList(prompts) {
      try {
        // ‰ªéAPIËé∑ÂèñÊâÄÊúâÂàÜÁªÑÂèäÊï∞Èáè‰ø°ÊÅØ
        const groups = await apiCall('/groups');
        const container = document.getElementById('groupList');
        container.innerHTML = '';

        const validGroupNames = new Set(groups.map(group => group.name));
        expandedGroups = new Set([...expandedGroups].filter(name => validGroupNames.has(name)));

        // ÊåâÁÖßÁõÆÂΩïÈ°∫Â∫èÊ∏≤ÊüìÂàÜÁªÑ
        groups.forEach(groupInfo => {
          const groupName = groupInfo.name;
          // ÊâæÂá∫Â±û‰∫éËØ•ÂàÜÁªÑÁöÑprompts
          const groupPrompts = prompts.filter(prompt => (prompt.group || 'default') === groupName);
          const section = document.createElement('div');
          section.className = 'group-section';
          section.innerHTML = `
            <div class="group-header" data-group="${groupName}">
              <span>${groupName}</span>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span class="group-count" id="group-count-${groupName}">0</span>
                <span class="group-toggle">‚ñº</span>
              </div>
            </div>
            <div class="group-content collapsed">
              <div class="prompt-list" id="promptList-${groupName}">
                <!-- PromptÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
              </div>
            </div>
          `;
          container.appendChild(section);
          
          // Ê∏≤ÊüìËØ•ÂàÜÁªÑÁöÑpromptÂàóË°®
          renderGroupPromptList(groupName, groupPrompts);
          
          // Êõ¥Êñ∞ÂàÜÁªÑËÆ°Êï∞
          const countElement = document.getElementById(`group-count-${groupName}`);
          if (countElement) {
            countElement.textContent = groupPrompts.length;
          }
          
          // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
          const header = section.querySelector('.group-header');
          const toggle = section.querySelector('.group-toggle');
          const content = section.querySelector('.group-content');

          const isExpanded = expandedGroups.has(groupName);
          content.classList.toggle('expanded', isExpanded);
          content.classList.toggle('collapsed', !isExpanded);
          toggle.classList.toggle('collapsed', !isExpanded);
          
          header.addEventListener('click', (e) => {
            // Ê£ÄÊü•ÁÇπÂáªÁöÑÁõÆÊ†áÂÖÉÁ¥†ÔºåÂè™Âú®ÁÇπÂáªÂàÜÁªÑÊ†áÈ¢òÊñáÊú¨ÈÉ®ÂàÜÊó∂ÊâçÂ±ïÂºÄ/ÊäòÂè†ÔºåÈÅøÂºÄÊìç‰ΩúÊåâÈíÆ
            const isClickOnActions = e.target.closest('.toggle-btn') || e.target.closest('.delete-btn') || e.target.closest('.prompt-actions');
            if (!isClickOnActions) {
              // Âè™ÊúâÊú™ÁÇπÂáªÊìç‰ΩúÊåâÈíÆÊó∂ÊâçÊâßË°åÂ±ïÂºÄ/ÊäòÂè†
              const nextExpanded = !content.classList.contains('expanded');
              content.classList.toggle('expanded', nextExpanded);
              content.classList.toggle('collapsed', !nextExpanded);
              toggle.classList.toggle('collapsed', !nextExpanded);

              if (nextExpanded) {
                expandedGroups.add(groupName);
              } else {
                expandedGroups.delete(groupName);
              }
            }
          });
        });
      } catch (error) {
        console.error('Ê∏≤ÊüìÂàÜÁªÑÂàóË°®Â§±Ë¥•:', error);
      }
    }
    
    // Âä†ËΩΩÂàÜÁªÑÂàóË°®
    async function loadGroups() {
      try {
        const groups = await apiCall('/groups')
        return groups.map(group => group.name)
      } catch (error) {
        console.error('Âä†ËΩΩÂàÜÁªÑÂàóË°®Â§±Ë¥•:', error)
        return ['default']
      }
    }
    
    // Ê∏≤ÊüìÂàÜÁªÑÂÜÖÁöÑpromptÂàóË°®
    function renderGroupPromptList(groupName, prompts) {
      const container = document.getElementById(`promptList-${groupName}`)
      container.innerHTML = ''

      prompts.forEach(prompt => {
        const item = document.createElement('div')
        item.className = `prompt-item ${prompt.enabled ? 'enabled' : ''} ${currentPrompt?.name === prompt.name ? 'active' : ''}`
        item.innerHTML = `
          <div class="prompt-info">
            <div class="prompt-name">${prompt.name}</div>
            <div class="prompt-desc" title="${prompt.description || ''}">${prompt.description || ''}</div>
          </div>
          <div class="prompt-meta">
            <div class="prompt-actions">
              <button class="action-btn toggle-btn" data-prompt="${prompt.name}">
                ${prompt.enabled ? 'ÂÅúÁî®' : 'ÂêØÁî®'}
              </button>
              <button class="action-btn delete-btn" data-prompt="${prompt.name}" style="color: var(--danger);">
                Âà†Èô§
              </button>
            </div>
          </div>
        `
        
        item.addEventListener('click', (e) => {
          // Âè™ÊúâÁÇπÂáªprompt‰ø°ÊÅØÂå∫ÂüüÊâçÈÄâÊã©promptÔºåÁÇπÂáªÊìç‰ΩúÊåâÈíÆ‰∏çËß¶Âèë
          if (!e.target.closest('.prompt-actions') && !e.target.classList.contains('toggle-btn') && !e.target.classList.contains('delete-btn')) {
            selectPrompt(prompt, e)
          }
        })
        
        // ÈòªÊ≠¢Êìç‰ΩúÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÁõÆÂΩïÊäòÂè†
        const actions = item.querySelector('.prompt-actions');
        if (actions) {
          actions.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
          });
          
          // ‰∏∫ÊØè‰∏™Êìç‰ΩúÊåâÈíÆÂçïÁã¨Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÁ°Æ‰øùÂÆåÂÖ®ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
          const toggleBtn = item.querySelector('.toggle-btn');
          const deleteBtn = item.querySelector('.delete-btn');
          
          if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              e.preventDefault();
              togglePromptByName(prompt.name);
              // ÈáçÊñ∞Âä†ËΩΩÂàóË°®Ôºå‰º†ÈÄíÊêúÁ¥¢ÂèÇÊï∞
              const searchInput = document.getElementById('searchInput');
              const searchValue = searchInput ? searchInput.value : '';
              loadPrompts(searchValue);
            });
          }
          
          if (deleteBtn) {
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              e.preventDefault();
              if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ "${prompt.name}" ÂêóÔºü`)) {
                deletePromptByName(prompt.name);
                // ÈáçÊñ∞Âä†ËΩΩÂàóË°®Ôºå‰º†ÈÄíÊêúÁ¥¢ÂèÇÊï∞
                const searchInput = document.getElementById('searchInput');
                const searchValue = searchInput ? searchInput.value : '';
                loadPrompts(searchValue);
              }
            });
          }
        }
        
        container.appendChild(item)
      })
      
      // Êìç‰ΩúÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Â∑≤ÁßªÂà∞‰∏äÈù¢ÁöÑitem.addEventListener‰∏≠ÔºåÈÅøÂÖçÈáçÂ§çÁªëÂÆö
    }
    
    // Ê†πÊçÆÂêçÁß∞ÂàáÊç¢promptÂêØÁî®Áä∂ÊÄÅ
    async function togglePromptByName(promptName) {
      try {
        const result = await apiCall(`/prompts/${promptName}/toggle`, {
          method: 'POST'
        })
        // ÈáçÊñ∞Âä†ËΩΩÂàóË°®Ôºå‰º†ÈÄíÊêúÁ¥¢ÂèÇÊï∞
        const searchInput = document.getElementById('searchInput');
        const searchValue = searchInput ? searchInput.value : '';
        loadPrompts(searchValue)
        const statusText = result?.enabled ? 'Â∑≤ÂêØÁî®' : 'Â∑≤ÂÅúÁî®'
        showMessage(`‚Äú${promptName}‚Äù ${statusText}`, result?.enabled ? 'success' : 'info')
      } catch (error) {
        console.error('ÂàáÊç¢promptÁä∂ÊÄÅÂ§±Ë¥•:', error)
        showMessage('ÂêØÁî®Áä∂ÊÄÅÂàáÊç¢Â§±Ë¥•: ' + error.message, 'error')
      }
    }
    
    // Ê†πÊçÆÂêçÁß∞Âà†Èô§prompt
    async function deletePromptByName(promptName) {
      try {
        await apiCall(`/prompts/${promptName}`, {
          method: 'DELETE'
        })
        showMessage('Âà†Èô§ÊàêÂäü')
        // ÈáçÊñ∞Âä†ËΩΩÂàóË°®Ôºå‰º†ÈÄíÊêúÁ¥¢ÂèÇÊï∞
        const searchInput = document.getElementById('searchInput');
        const searchValue = searchInput ? searchInput.value : '';
        loadPrompts(searchValue)
      } catch (error) {
        console.error('Âà†Èô§promptÂ§±Ë¥•:', error)
        showMessage('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error')
      }
    }

    // ÈÄâÊã©prompt
    async function selectPrompt(prompt, triggerEvent) {
      try {
        const promptData = await apiCall(`/prompts/${prompt.name}`)
        currentPrompt = promptData

        let parsedPrompt = null
        try {
          parsedPrompt = window.jsyaml?.load(promptData.yaml || '') || null
        } catch (err) {
          console.error('Ëß£ÊûêÊèêÁ§∫ËØçÂ§±Ë¥•:', err)
        }

        currentPromptObject = parsedPrompt ? clonePromptObject(parsedPrompt) : createDefaultPromptObject()
        setArgumentsState(currentPromptObject.arguments || [])

        const nameInput = document.getElementById('promptName')
        if (nameInput) nameInput.value = currentPromptObject.name || promptData.name || ''
        document.getElementById('promptGroup').value = promptData.group || 'default'

        if (descriptionInputEl) {
          descriptionInputEl.value = currentPromptObject.description || ''
          adjustDescriptionHeight()
        }

        const userMessage = getFirstUserMessage(currentPromptObject)
        const messageText = userMessage?.content?.text || ''
        if (editor) {
          editor.setValue(messageText)
        }

        // Êõ¥Êñ∞UIÁä∂ÊÄÅ
        document.querySelectorAll('.prompt-item').forEach(el => el.classList.remove('active'))
        const targetItem = triggerEvent?.currentTarget || triggerEvent?.target?.closest('.prompt-item')
        if (targetItem) {
          targetItem.classList.add('active')
        }

        // Êõ¥Êñ∞È¢ÑËßà
        updatePreview(true)
      } catch (error) {
        console.error('Âä†ËΩΩpromptËØ¶ÊÉÖÂ§±Ë¥•:', error)
      }
    }



    // ÂàáÊç¢Â∑•‰ΩúÂå∫Ê®°Âºè
    function setWorkspaceMode(mode) {
      const isPreview = mode === 'preview'
      const editorPane = document.getElementById('editorPane')
      const previewPane = document.getElementById('previewPane')
      const editModeBtn = document.getElementById('editModeBtn')
      const previewModeBtn = document.getElementById('previewModeBtn')

      if (!editorPane || !previewPane || !editModeBtn || !previewModeBtn) return

      editModeBtn.classList.toggle('active', !isPreview)
      previewModeBtn.classList.toggle('active', isPreview)
      editorPane.classList.toggle('hidden', isPreview)
      previewPane.classList.toggle('hidden', !isPreview)

      if (isPreview) {
        updatePreview(true)
      } else if (editor) {
        editor.refresh()
      }
    }

    // Êõ¥Êñ∞È¢ÑËßà
    async function updatePreview(force = false) {
      if (!editor) return

      const previewPane = document.getElementById('previewPane')
      if (!force && previewPane?.classList.contains('hidden')) {
        return
      }

      if (!window.jsyaml) return

      const promptObject = buildPromptObjectFromUI()
      const yaml = window.jsyaml.dump(promptObject)

      try {
        const result = await apiCall('/md-preview', {
          method: 'POST',
          body: JSON.stringify({ yaml, vars: {} })
        })
        
        document.getElementById('previewContent').innerHTML = result.html || '<p>È¢ÑËßàÂÜÖÂÆπ</p>'
      } catch (error) {
        document.getElementById('previewContent').innerHTML = '<p style="color: red;">È¢ÑËßàÁîüÊàêÂ§±Ë¥•</p>'
      }
    }

    // ‰øùÂ≠òprompt
    async function savePrompt() {
      if (!editor) return

      const saveBtn = document.getElementById('saveBtn')
      if (saveBtn?.disabled) return

      const name = document.getElementById('promptName').value.trim()
      const group = document.getElementById('promptGroup').value.trim()

      if (!window.jsyaml) {
        showMessage('ËµÑÊ∫êÊú™ÂáÜÂ§áÂ∞±Áª™ÔºåËØ∑Âà∑Êñ∞ÈáçËØï', 'error')
        return
      }

      if (!name) {
        showMessage('ËØ∑ËæìÂÖ•promptÂêçÁß∞', 'error')
        return
      }

      const promptObject = buildPromptObjectFromUI()
      const unusedArguments = findUnusedArguments(promptObject)
      if (unusedArguments.length > 0) {
        const missingNames = unusedArguments.map(arg => arg.name).filter(Boolean)
        if (missingNames.length) {
          setUnusedArgumentHighlights(missingNames)
          const argumentsSection = document.getElementById('argumentsSection')
          if (argumentsSection) {
            argumentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' })
          }
          showMessage(`‰ª•‰∏ãÂèÇÊï∞Êú™Âú®ÂÜÖÂÆπ‰∏≠‰ΩøÁî®Ôºö${missingNames.join(', ')}`, 'error')
          const firstMissing = missingNames[0]
          requestAnimationFrame(() => {
            const listEl = document.getElementById('argumentsList')
            if (!listEl) return
            const targetCard = Array.from(listEl.querySelectorAll('.argument-card')).find(card => {
              const idx = Number(card.dataset.index)
              const argName = argumentsState[idx]?.name?.trim()
              return argName === firstMissing
            })
            if (targetCard) {
              const targetIndex = Number(targetCard.dataset.index)
              if (Number.isInteger(targetIndex)) {
                openArgumentModal(targetIndex)
              }
            }
          })
          return
        }
      } else {
        setUnusedArgumentHighlights([])
      }
      const yaml = window.jsyaml.dump(promptObject)

      let originalText = ''
      if (saveBtn) {
        originalText = (saveBtn.textContent || '‰øùÂ≠ò').trim()
        saveBtn.disabled = true
        saveBtn.classList.add('loading')
        saveBtn.textContent = '‰øùÂ≠ò‰∏≠...'
      }
      
      try {
        await apiCall('/prompts', {
          method: 'POST',
          body: JSON.stringify({
            name,
            group,
            yaml
          })
        })
        
        showMessage('‰øùÂ≠òÊàêÂäü')
        currentPromptObject = clonePromptObject(promptObject)
        currentPrompt = { ...(currentPrompt || {}), name }
        // ÈáçÊñ∞Âä†ËΩΩÂàóË°®Ôºå‰º†ÈÄíÊêúÁ¥¢ÂèÇÊï∞
        const searchInput = document.getElementById('searchInput');
        const searchValue = searchInput ? searchInput.value : '';
        loadPrompts(searchValue)
      } catch (error) {
        console.error('‰øùÂ≠òÂ§±Ë¥•:', error)
        if (!error?.__shown) {
          showMessage('‰øùÂ≠òÂ§±Ë¥•: ' + (error?.message || 'Êú™Áü•ÈîôËØØ'), 'error')
        }
      } finally {
        if (saveBtn) {
          saveBtn.disabled = false
          saveBtn.classList.remove('loading')
          saveBtn.textContent = originalText
        }
      }
    }

    // ÈáçÁΩÆÁºñËæëÂô®
    function resetEditor() {
      document.getElementById('promptName').value = ''
      document.getElementById('promptGroup').value = 'default'
      if (editor) editor.setValue('')
      if (descriptionInputEl) {
        descriptionInputEl.value = ''
        adjustDescriptionHeight()
      }
      setArgumentsState([])
      currentPrompt = null
      currentPromptObject = null
      document.getElementById('previewContent').innerHTML = '<p>ÈÄâÊã©ÊàñÂàõÂª∫promptÂºÄÂßãÁºñËæë</p>'
      setWorkspaceMode('edit')
    }

    // Êñ∞Âª∫prompt
    function newPrompt() {
      currentPrompt = null
      currentPromptObject = createDefaultPromptObject()

      const nameInput = document.getElementById('promptName')
      if (nameInput) nameInput.value = currentPromptObject.name
      document.getElementById('promptGroup').value = 'default'

      const defaultMessage = getFirstUserMessage(currentPromptObject)
      if (editor) {
        editor.setValue(defaultMessage?.content?.text || '')
      }

      setArgumentsState(currentPromptObject.arguments || [])

      if (descriptionInputEl) {
        descriptionInputEl.value = currentPromptObject.description || ''
        adjustDescriptionHeight()
      }

      document.getElementById('previewContent').innerHTML = '<p>ÈÄâÊã©ÊàñÂàõÂª∫promptÂºÄÂßãÁºñËæë</p>'
      setWorkspaceMode('edit')

      document.querySelectorAll('.prompt-item').forEach(el => el.classList.remove('active'))
      updatePreview(true)
    }
    
    // ÂàõÂª∫Êñ∞ÂàÜÁªÑ
    async function createNewGroup() {
      const groupName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÂàÜÁªÑÂêçÁß∞:')
      if (!groupName) return
      
      try {
        await apiCall('/groups', {
          method: 'POST',
          body: JSON.stringify({ name: groupName })
        })
        
        showMessage('ÂàÜÁªÑÂàõÂª∫ÊàêÂäü')
        loadPrompts()
      } catch (error) {
        console.error('ÂàõÂª∫ÂàÜÁªÑÂ§±Ë¥•:', error)
        showMessage('ÂàõÂª∫ÂàÜÁªÑÂ§±Ë¥•: ' + error.message, 'error')
      }
    }

    // ÂàùÂßãÂåñÂ∫îÁî®
    async function initApp() {
      try {
        // Ê†∑ÂºèËµÑÊ∫êÔºöhttps://codemirror.net/5/theme/
        // ÊïàÊûúÈ¢ÑËßàÔºöhttps://toolshu.com/codemirror-theme-prev#default

        // Âπ∂Ë°åÂä†ËΩΩËµÑÊ∫ê
        await Promise.all([
          loadScript('./js/codemirror.min.js'),
          loadScript('./js/markdown.min.js'),
          loadScript('./js/closebrackets.min.js'),
          loadScript('./js/js-yaml.min.js')
        ])

        // ÂàùÂßãÂåñÁºñËæëÂô®
        editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
          mode: 'markdown',
          lineNumbers: true,
          theme: 'xq-light',
          lineWrapping: true,
          autoCloseBrackets: true,
          value: 'ËØ∑ÈÄâÊã©ÊàñÂàõÂª∫promptÂºÄÂßãÁºñËæë'
        })

        editor.on('change', () => updatePreview())

        const editModeBtn = document.getElementById('editModeBtn')
        const previewModeBtn = document.getElementById('previewModeBtn')
        editModeBtn.addEventListener('click', () => setWorkspaceMode('edit'))
        previewModeBtn.addEventListener('click', () => setWorkspaceMode('preview'))
        setWorkspaceMode('edit')

        descriptionInputEl = document.getElementById('promptDescription')
        if (descriptionInputEl) {
          descriptionInputEl.addEventListener('input', adjustDescriptionHeight)
          adjustDescriptionHeight()
        }

        setArgumentsState([])

        argumentModalEl = document.getElementById('argumentModal')
        argumentFormEl = document.getElementById('argumentForm')
        argumentModalTitleEl = document.getElementById('argumentModalTitle')
        argumentNameInput = document.getElementById('argumentNameInput')
        argumentTypeInput = document.getElementById('argumentTypeInput')
        argumentRequiredInput = document.getElementById('argumentRequiredInput')
        argumentDefaultInput = document.getElementById('argumentDefaultInput')
        argumentDescriptionInput = document.getElementById('argumentDescriptionInput')

        if (argumentTypeInput && !argumentTypeInput.value) {
          argumentTypeInput.value = 'string'
        }

        const addArgumentBtn = document.getElementById('addArgumentBtn')
        if (addArgumentBtn) {
          addArgumentBtn.addEventListener('click', () => openArgumentModal(null))
        }

        const argumentsListEl = document.getElementById('argumentsList')
        if (argumentsListEl) {
          argumentsListEl.addEventListener('click', handleArgumentListClick)
        }

        if (argumentFormEl) {
          argumentFormEl.addEventListener('submit', handleArgumentFormSubmit)
        }

        const argumentCancelBtn = document.getElementById('argumentCancelBtn')
        if (argumentCancelBtn) {
          argumentCancelBtn.addEventListener('click', closeArgumentModal)
        }

        const argumentModalClose = document.getElementById('argumentModalClose')
        if (argumentModalClose) {
          argumentModalClose.addEventListener('click', closeArgumentModal)
        }

        if (argumentModalEl) {
          argumentModalEl.addEventListener('click', (event) => {
            if (event.target === argumentModalEl) {
              closeArgumentModal()
            }
          })
        }

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && argumentModalEl && !argumentModalEl.classList.contains('hidden')) {
            closeArgumentModal()
          }
        })

        // ÁªëÂÆö‰∫ã‰ª∂
        document.getElementById('loginBtn').addEventListener('click', () => {
          const username = document.getElementById('username').value.trim()
          const password = document.getElementById('password').value.trim()
          
          if (!username || !password) {
            document.getElementById('loginError').textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å'
            return
          }
          
          login(username, password)
        })

        document.getElementById('logoutBtn').addEventListener('click', logout)
        document.getElementById('newPromptBtn').addEventListener('click', newPrompt)
        document.getElementById('newGroupBtn').addEventListener('click', createNewGroup)
        document.getElementById('saveBtn').addEventListener('click', savePrompt)

        // ÊêúÁ¥¢ÂäüËÉΩ
        const searchInput = document.getElementById('searchInput')
        let searchTimeout
        searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout)
          searchTimeout = setTimeout(() => {
            loadPrompts(searchInput.value)
          }, 300)
        })

        // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        if (currentToken) {
          showMain()
          loadPrompts()
        } else {
          showLogin()
        }

      } catch (err) {
        console.error('ÂàùÂßãÂåñÈîôËØØ:', err)
        document.getElementById('loginError').textContent = 'ËµÑÊ∫êÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï'
        throw err
      }
    }

    // ÂêØÂä®Â∫îÁî®
    document.addEventListener('DOMContentLoaded', initApp)
  </script>
</body>
</html>
