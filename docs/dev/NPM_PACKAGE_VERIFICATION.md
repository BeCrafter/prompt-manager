# NPM包本地验证流程

## 快速开始

### 一键验证
```bash
npm run test:npm-package
```

### 直接运行脚本
```bash
node scripts/test-npm-package.js
```

## 验证流程说明

脚本会自动执行以下5个验证步骤：

### 步骤1: 发布前验证 ✅
- 运行 `npm run verify:publish`
- 检查代码质量（ESLint, Prettier）
- 运行单元测试
- 验证构建产物
- 检查安全审计
- 验证文件完整性
- 检查版本一致性
- **检查依赖完整性**（新增）

### 步骤2: 打包npm包 📦
- 执行 `npm pack`
- 生成 `.tgz` 包文件
- 验证包创建成功

### 步骤3: 安装npm包 📥
- 在临时目录创建干净的测试环境
- 安装npm包
- 验证所有依赖正确安装

### 步骤4: 启动服务 🚀
- 启动服务（默认端口5621）
- 等待服务就绪（最多30秒）
- 验证进程正常运行

### 步骤5: 测试API响应 🧪
- 测试配置API: `GET /adminapi/config/public`
- 测试管理界面: `GET /admin/`
- 验证响应格式正确

### 步骤6: 清理临时文件 🧹
- 停止服务进程
- 删除临时测试目录
- 清理打包的 `.tgz` 文件

## 验证结果示例

```
======================================================================
NPM Package Local Verification
======================================================================

[1] 运行发布前验证 (lint, test, build, security)
ℹ 执行: 发布前验证...
✓ 发布前验证 完成

[2] 打包npm包
ℹ 正在打包npm包...
✓ npm包已创建: becrafter-prompt-manager-0.2.4.tgz

[3] 安装npm包到临时目录
ℹ 创建临时测试目录: /tmp/npm-package-test-xxx
ℹ 安装npm包...
✓ npm包安装成功

[4] 启动服务
ℹ 启动服务 (端口: 5621)...
ℹ 等待服务启动...
✓ 服务启动成功

[5] 测试API响应
ℹ 测试配置API...
✓ 配置API响应正常
ℹ 测试管理界面...
✓ 管理界面响应正常

======================================================================
验证结果
======================================================================

发布前验证:
  Lint & Test & Build:  ✅ PASS

NPM包构建:
  Package Build:        ✅ PASS

NPM包安装:
  Package Install:      ✅ PASS

服务运行:
  Service Start:        ✅ PASS
  API Response:         ✅ PASS

======================================================================

🎉 所有验证通过！
```

## 什么时候使用此验证？

### 发布前必做 ✅
- 在创建版本标签前
- 在推送到main分支前
- 在合并PR前

### 开发时建议 ⚠️
- 添加了新的npm依赖
- 修改了package.json
- 修改了服务启动逻辑
- 修改了API接口

## 常见问题

### Q: 验证失败怎么办？
A: 检查失败步骤的日志，修复问题后重新运行。

### Q: 如何修改测试端口？
A: 编辑 `scripts/test-npm-package.js`，修改 `this.servicePort = 5621;`。

### Q: 如何查看详细日志？
A: 检查临时目录中的 `service.log` 文件。

### Q: 测试失败后如何清理？
A: 脚本会自动清理，如果清理失败，手动删除 `/tmp/npm-package-test-*` 目录。

### Q: 如何跳过某个步骤？
A: 修改脚本中的 `run()` 方法，注释掉不需要的步骤。

## 技术细节

### 依赖检查机制
脚本会扫描 `packages/server/` 目录下的所有 `.js` 文件，提取 `import` 语句中的包名，并验证这些包是否在根 `package.json` 的 `dependencies` 中声明。

### 白名单机制
以下包会被自动排除，不作为缺失依赖报错：
- Node.js内置模块（`fs`, `path`, `http`等）
- 开发工具（`vitest`, `eslint`, `prettier`等）

### 端口冲突处理
如果5621端口被占用，可以：
1. 修改 `this.servicePort` 的值
2. 或者在运行前停止占用端口的进程

## 相关文档

- [NPM发布流程](../../AGENTS.md#npm-publish-workflow)
- [发布前验证](./_QUICK_START.md)
- [代码质量规范](../../AGENTS.md#code-style-guidelines)